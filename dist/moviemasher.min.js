!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MovieMasher={})}(this,(function(e){"use strict";var t,i,s;e.ActionType=void 0,(t=e.ActionType||(e.ActionType={})).AddTrack="addTrack",t.AddClipsToTrack="addClipsToTrack",t.MoveClips="moveClips",t.AddEffect="addEffect",t.Change="change",t.ChangeFrames="changeFrames",t.ChangeTrim="changeTrim",t.ChangeGain="changeGain",t.MoveEffects="moveEffects",t.Split="split",t.Freeze="freeze",t.RemoveClips="removeClips",e.TrackType=void 0,(i=e.TrackType||(e.TrackType={})).Audio="audio",i.Video="video",e.ClipType=void 0,(s=e.ClipType||(e.ClipType={})).Audio="audio",s.Frame="frame",s.Image="image",s.Theme="theme",s.Transition="transition",s.Video="video";const n=Object.values(e.ClipType);var r;e.DefinitionType=void 0,(r=e.DefinitionType||(e.DefinitionType={})).Audio="audio",r.Effect="effect",r.Filter="filter",r.Font="font",r.Image="image",r.Mash="mash",r.Merger="merger",r.Scaler="scaler",r.Theme="theme",r.Transition="transition",r.Video="video";const o=Object.values(e.DefinitionType);var a;e.EventType=void 0,(a=e.EventType||(e.EventType={})).Action="action",a.Add="add",a.Duration="duration",a.Redo="redo",a.Truncate="truncate",a.Undo="undo",e.MashType=void 0,(e.MashType||(e.MashType={})).Mash="mash";const c=Object.values(e.MashType);var h;e.ModuleType=void 0,(h=e.ModuleType||(e.ModuleType={})).Effect="effect",h.Font="font",h.Merger="merger",h.Scaler="scaler",h.Theme="theme",h.Transition="transition";const l=Object.values(e.ModuleType);var d,u,m;e.LoadType=void 0,(d=e.LoadType||(e.LoadType={})).Audio="audio",d.Font="font",d.Image="image",d.Module="module",e.MoveType=void 0,(u=e.MoveType||(e.MoveType={})).Audio="audio",u.Effect="effect",u.Video="video",e.DataType=void 0,(m=e.DataType||(e.DataType={})).Direction4="direction4",m.Direction8="direction8",m.Font="font",m.Fontsize="fontsize",m.Hex="hex",m.Integer="integer",m.Mode="mode",m.Number="number",m.Pixel="pixel",m.Rgb="rgb",m.Rgba="rgba",m.Scalar="scalar",m.String="string",m.Text="text";const f=Object.values(e.DataType);var p;e.TransformType=void 0,(p=e.TransformType||(e.TransformType={})).Merger="merger",p.Scaler="scaler";const g=Object.values(e.TransformType),v="Invalid argument",y="Invalid property",b="deprecated in 4.1",w="Internal Error ",x={eval:{sourceRect:"Invalid evaluation of source rect ",outputSize:"Invalid evaluation of output size ",conditionTruth:"Expected at least one condition to evaluate to true ",conditionValue:"Expected condition to have a value ",number:"Expected evaluated value to be a number ",get:"Expected to get evaluated value "},composition:{mashUndefined:`${w}composition.mash undefined`},audibleContext:"Expected AudioContext",mash:"Expected mash",action:"Expected Action",actions:"Expected Actions",internal:w,argument:"Invalid argument ",invalid:{definition:{duration:"Invalid definition property duration",audio:"Invalid definition property audio|url",url:"Invalid definition property url",source:"Invalid definition property source",id:"Invalid definition property id"},track:"Invalid track ",trackType:"Invalid property trackType ",action:"Invalid action ",name:"Invalid property name ",value:"Invalid property value ",type:"Invalid property type ",url:"Invalid property url ",property:y,argument:v,object:"Invalid argument object ",factory:"Invalid factory ",volume:"Invalid argument volume"},type:"Unknown type ",selection:"Invalid selection ",unknown:{type:"Unknown type ",merger:"Unknown merger ",effect:"Unknown effect ",filter:"Unknown filter ",font:"Unknown font ",scaler:"Unknown scalar ",mode:"Unknown mode ",definition:"Unknown definition "},uncached:"Uncached URL ",object:"Invalid argument object ",array:"Invalid argument array ",media:"Invalid argument media ",id:"Invalid argument id ",frame:"Invalid argument frame ",frames:"Invalid property frames ",fps:"Invalid argument fps ",seconds:"Invalid argument seconds ",url:"Invalid argument url ",time:"Invalid argument Time",timeRange:"Invalid argument TimeRange",mainTrackOverlap:`${w}: main track clips overlap without transition`,unknownMash:"Unknown Mash property ",unimplemented:"Expected method to be overridden",property:"Invalid argument property ",deprecation:{property_types:`property_types ${b} - please get MovieMasher.Property.types instead`,addModulesOfType:`addModulesOfType ${b} for unsupported type `,configure:{get:`configure ${b} - please get MovieMasher.defaults instead`,set:`configure ${b} - please supply mash.quantize and media.duration instead`},canvas_context:{get:`canvas_context ${b} - please get visibleContext instead`,set:`canvas_context ${b} - please set visibleContext instead`}},wrongClass:"Expected instance of "};class T{constructor(e){this.done=!1;const{actions:t,mash:i,redoSelectedClips:s,redoSelectedEffects:n,type:r,undoSelectedClips:o,undoSelectedEffects:a}=e;this.actions=t,this.type=r,this.mash=i,this.undoSelectedClips=o,this.redoSelectedClips=s,this.undoSelectedEffects=a,this.redoSelectedEffects=n}get events(){return this.mash.events}get selectedClips(){return this.done?this.redoSelectedClips:this.undoSelectedClips}get selectedEffects(){return this.done?this.redoSelectedEffects:this.undoSelectedEffects}redo(){this.redoAction(),this.done=!0,this.events&&this.events.emit(e.EventType.Action,{action:this})}redoAction(){throw x.internal+"redoAction"}undo(){this.undoAction(),this.done=!1,this.events&&this.events.emit(e.EventType.Action,{action:this})}undoAction(){throw x.internal+"undoAction"}}class _ extends T{constructor(e){super(e);const{trackType:t}=e;this.trackType=t}redoAction(){this.mash.addTrack(this.trackType)}undoAction(){this.mash.removeTrack(this.trackType)}}class C extends T{constructor(e){super(e);const{property:t,redoValue:i,target:s,undoValue:n}=e;this.property=t,this.redoValue=i,this.target=s,this.undoValue=n}get redoValueNumeric(){return Number(this.redoValue)}get undoValueNumeric(){return Number(this.undoValue)}redoAction(){this.target[this.property]=this.redoValue}undoAction(){this.target[this.property]=this.undoValue}updateAction(e){this.redoValue=e,this.redo()}}class F extends T{constructor(e){super(e);const{frames:t,freezeClip:i,frozenClip:s,index:n,insertClip:r,trackClips:o}=e;this.frames=t,this.freezeClip=i,this.frozenClip=s,this.index=n,this.insertClip=r,this.trackClips=o}redoAction(){this.trackClips.splice(this.index,0,this.insertClip,this.frozenClip),this.freezeClip.frames-=this.frames}undoAction(){this.freezeClip.frames+=this.frames,this.trackClips.splice(this.index,2)}}class S extends C{constructor(e){super(e),this.clip=this.target}redoAction(){this.mash.changeClipFrames(this.clip,this.redoValue)}undoAction(){this.mash.changeClipFrames(this.clip,this.undoValue)}}class A extends C{constructor(e){super(e);const{frames:t,target:i}=e;this.frames=t,this.audibleClip=i}redoAction(){this.mash.changeClipTrimAndFrames(this.audibleClip,this.redoValue,this.frames)}undoAction(){this.mash.changeClipTrimAndFrames(this.audibleClip,this.undoValue,this.frames)}}class I extends T{constructor(e){super(e);const{effect:t,effects:i,index:s}=e;this.effect=t,this.effects=i,this.index=s}redoAction(){this.effects.splice(this.index,0,this.effect)}undoAction(){this.effects.splice(this.index,1)}}class k extends _{constructor(e){super(e);const{clip:t,createTracks:i,insertIndex:s,trackIndex:n}=e;this.clip=t,this.createTracks=i,this.insertIndex=s,this.trackIndex=n}get clips(){return this.track.clips}get track(){return this.mash[this.trackType][this.trackIndex]}redoAction(){for(let e=0;e<this.createTracks;e+=1)super.redoAction();this.mash.addClipsToTrack([this.clip],this.trackIndex,this.insertIndex)}undoAction(){this.mash.removeClipsFromTrack([this.clip]);for(let e=0;e<this.createTracks;e+=1)super.undoAction()}}class O extends T{constructor(e){super(e);const{clips:t,insertIndex:i,redoFrames:s,trackIndex:n,undoFrames:r,undoInsertIndex:o,undoTrackIndex:a}=e;this.clips=t,this.insertIndex=i,this.redoFrames=s,this.trackIndex=n,this.undoFrames=r,this.undoInsertIndex=o,this.undoTrackIndex=a}addClips(e,t){this.mash.addClipsToTrack(this.clips,e,t)}setFrames(e){this.clips.forEach(((t,i)=>{t.frame=e[i]}))}redoAction(){this.redoFrames&&this.setFrames(this.redoFrames),this.addClips(this.trackIndex,this.insertIndex)}undoAction(){this.undoFrames&&this.setFrames(this.undoFrames),this.addClips(this.undoTrackIndex,this.undoInsertIndex)}}class z extends T{constructor(e){super(e);const{clips:t,index:i,track:s}=e;this.clips=t,this.index=i,this.track=s}get trackIndex(){return this.track.index}redoAction(){this.mash.removeClipsFromTrack(this.clips)}undoAction(){this.mash.addClipsToTrack(this.clips,this.trackIndex,this.index)}}class E extends T{constructor(e){super(e);const{index:t,insertClip:i,redoFrames:s,splitClip:n,trackClips:r,undoFrames:o}=e;this.index=t,this.insertClip=i,this.redoFrames=s,this.splitClip=n,this.trackClips=r,this.undoFrames=o}redoAction(){this.trackClips.splice(this.index,0,this.insertClip),this.splitClip.frames=this.redoFrames}undoAction(){this.splitClip.frames=this.undoFrames,this.trackClips.splice(this.index,1)}}class D extends T{constructor(e){super(e);const{effects:t,redoEffects:i,undoEffects:s}=e;this.effects=t,this.redoEffects=i,this.undoEffects=s}redoAction(){this.effects.splice(0,this.effects.length,...this.redoEffects)}undoAction(){this.effects.splice(0,this.effects.length,...this.undoEffects)}}class M{constructor(e){this.index=-1,this.instances=[];const{mash:t}=e;this.mash=t}get canRedo(){return this.index<this.instances.length-1}get canSave(){return this.canUndo}get canUndo(){return this.index>-1}get currentAction(){return this.instances[this.index]}get currentActionLast(){return this.canUndo&&!this.canRedo}destroy(){this.index=-1,this.instances.splice(0,this.instances.length)}do(e){const t=this.instances.length-(this.index+1),i=t?this.instances.splice(this.index+1,t):[];return this.instances.push(e),this.redo(),i}redo(){this.index+=1;const e=this.currentAction;return e.redo(),e}save(){this.instances.splice(0,this.index+1),this.index=-1}undo(){const e=this.currentAction;return this.index-=1,e.undo(),e}}class j{constructor(e={}){this.methods=new Set;const{target:t}=e;t&&(this.target=t)}get target(){return this.__target}set target(e){if(this.__target!==e){const t=new Set(this.methods);t.forEach(this.removeListener,this),this.__target=e,t.forEach(this.addListener,this)}}addListener(e){if(this.methods.add(e)){if(!this.target)return;this.target.addEventListener(j.type,e)}}emit(e,t={}){const i={detail:{type:e,...t}};this.target&&this.target.dispatchEvent(new CustomEvent(j.type,i))}removeListener(e){if(this.methods.delete(e)){if(!this.target)return;this.target.removeEventListener(j.type,e)}}static get type(){return"masher"}}const V={buffer:10,fps:30,loop:!0,volume:.75,precision:3,autoplay:!1,mash:{label:"Untitled Mash",quantize:10,backcolor:"#00000000"},clip:{audio:{gain:1,trim:0},video:{speed:1}},media:{frame:{duration:2},image:{duration:2},theme:{duration:3},transition:{duration:1},video:{pattern:"%.jpg",fps:30,increment:1,begin:1}}},N=e=>"object"==typeof e,R=e=>"string"==typeof e,P=e=>void 0===e,q=e=>"number"==typeof e,B=e=>"boolean"==typeof e,$=e=>"function"==typeof e,J=e=>!P(e),L=e=>q(e)&&Number.isNaN(e),U=e=>Number.isInteger(e),Z=e=>q(e)&&!U(e),G=e=>q(e)&&Number(e)>=0,K=e=>(e=>q(e)&&!Number.isNaN(e))(e)&&Number(e)>0,W=e=>J(Array.isArray)?Array.isArray(e):e instanceof Array,H=e=>!!e.length,X=e=>R(e)&&H(String(e)),Y=e=>N(e)&&H(Object.keys(e)),Q=e=>W(e)&&H(e),ee={aboveZero:K,array:W,boolean:B,defined:J,float:Z,integer:U,method:$,nan:L,number:q,object:N,populatedArray:Q,populatedObject:Y,populatedString:X,positive:G,string:R,undefined:P},te=(e,t,i="")=>{if(e.fps===t.fps)return[e,t];const s=(n=e.fps,r=t.fps,n*r/((e,t)=>{let i=e,s=t,n=0;for(;0!==s;)n=s,s=i%s,i=n;return i})(n,r));var n,r;return[e.scale(s,i),t.scale(s,i)]},ie=(e,t="")=>((e="")=>{switch(e){case"ceil":return Math.ceil;case"floor":return Math.floor;default:return Math.round}})(t)(e);class se{constructor(e=0,t=1){if(!ee.integer(e)||e<0)throw x.frame;if(!ee.integer(t)||t<1)throw x.fps;this.frame=e,this.fps=t}add(e){const[t,i]=te(this,e);return new se(t.frame+i.frame,t.fps)}addFrames(e){const t=this.copy;return t.frame+=e,t}get copy(){return new se(this.frame,this.fps)}get description(){return`${this.frame}@${this.fps}`}divide(e,t=""){if(!ee.number(e))throw x.argument+"divide";return new se(ie(Number(this.frame)/e,t),this.fps)}equalsTime(e){const[t,i]=te(this,e);return t.frame===i.frame}min(e){const[t,i]=te(this,e);return new se(Math.min(t.frame,i.frame),t.fps)}scale(e,t=""){if(this.fps===e)return this;const i=Number(this.frame/this.fps)*Number(e);return new se(ie(i,t),e)}scaleToFps(e){return this.scaleToTime(new se(0,e))}scaleToTime(e){return te(this,e)[0]}get seconds(){return Number(this.frame)/Number(this.fps)}subtract(e){const[t,i]=te(this,e);let s=i.frame;return s>t.frame&&(s-=s-t.frame),new se(t.frame-s,t.fps)}subtractFrames(e){const t=this.copy;return t.frame-=e,t}toString(){return`[${this.description}]`}withFrame(e){const t=this.copy;return t.frame=e,t}static fromArgs(e=0,t=1){return new se(e,t)}static fromSeconds(e=0,t=1,i=""){if(!ee.number(e)||e<0)throw x.seconds;if(!ee.integer(t)||t<1)throw x.fps;const s=ie(e*t,i);return this.fromArgs(s,t)}}class ne extends se{constructor(e=0,t=1,i=1){if(!(ee.integer(i)&&i>=0))throw x.argument+"frames";super(e,t),this.frames=i}get description(){return`${this.frame}-${this.frames}@${this.fps}`}get end(){return this.frame+this.frames}get endTime(){return se.fromArgs(this.end,this.fps)}get lengthSeconds(){return Number(this.frames)/Number(this.fps)}get position(){return Number(this.frame)/Number(this.frames)}get startTime(){return se.fromArgs(this.frame,this.fps)}get copy(){return new ne(this.frame,this.fps,this.frames)}scale(e=1,t=""){if(this.fps===e)return this.copy;const i=Number(this.frames)/(Number(this.fps)/Number(e)),s=super.scale(e,t),n=Math.max(1,ie(i,t));return new ne(s.frame,s.fps,n)}intersects(e){const[t,i]=te(this,e);return!(t.frame>=i.end)&&t.end>i.frame}intersectsTime(e){const[t,i]=te(this,e),s=t;return i.frame>=s.frame&&i.frame<s.end}minEndTime(e){const[t,i]=te(this,e);return t.frames=Math.min(t.frames,i.frame),t}withFrame(e){const t=this.copy;return t.frame=e,t}withFrames(e){const t=this.copy;return t.frames=e,t}static fromArgs(e=0,t=1,i=1){return new ne(e,t,i)}static fromSeconds(e=0,t=1){return this.fromArgs(e,1,t)}static fromTime(e,t=1){return this.fromArgs(e.frame,e.fps,t)}static fromTimes(e,t){const[i,s]=te(e,t);if(s.frame<=i.frame)throw x.argument;const n=s.frame-i.frame;return this.fromArgs(i.frame,i.fps,n)}}const re=e=>Math.min(255,Math.max(0,Math.floor(Number(e)))),oe=e=>({r:re(e.r),g:re(e.g),b:re(e.b)}),ae=e=>({y:re(e.y),u:re(e.u),v:re(e.v)}),ce={yuvBlend:(e,t,i,s)=>{let n=0;const r=ae(t);return e.forEach((e=>{const t=ae(e),i=t.u-r.u,s=t.v-r.v;n+=Math.sqrt((i*i+s*s)/65025)})),n/=e.length,s>1e-4?255*Math.min(1,Math.max(0,(n-i)/s)):n>i?255:0},rgb2yuv:e=>{const t=oe(e);return{y:.299*t.r+.587*t.g+.114*t.b,u:-.168736*t.r+-.331264*t.g+.5*t.b+128,v:.5*t.r+-.418688*t.g+-.081312*t.b+128}},yuv2rgb:e=>{const t=ae(e);return oe({r:t.y+1.4075*(t.v-128),g:t.y-.3455*(t.u-128)-.7169*(t.v-128),b:t.y+1.779*(t.u-128)})},rgb2hex:e=>{let t=e.r.toString(16),i=e.g.toString(16),s=e.b.toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),s.length<2&&(s=`0${s}`),`#${t}${i}${s}`}},he=(e,t)=>({r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}),le=(e,t,i)=>{const{x:s,y:n}=t,{width:r,height:o}=i,a=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e,r);return a.x=Math.max(0,Math.min(r-1,a.x+s)),a.y=Math.max(0,Math.min(o-1,a.y+n)),((e,t)=>e.y*t+e.x)(a,r)},de={color:e=>{const t=String(e);return"0x"===t.slice(0,2)?`#${t.slice(2)}`:t},rgbaAtIndex:he,rgbs:(e,t,i)=>((e,t)=>{const i=[],s=Math.floor(1.5);for(let n=0;n<3;n+=1)for(let r=0;r<3;r+=1){const o={x:r-s,y:n-s};i.push(le(e,o,t))}return i})(e,i).map((e=>((e,t)=>he((e=>4*e)(e),t))(e,t)))},ue=(e,t)=>e.frame-t.frame,me=(e,t)=>e.track-t.track,fe=(e,t)=>e.label<t.label?-1:e.label>t.label?1:0,pe={byFrame:ue,byLabel:fe,byTrack:me},ge=["mm_width","mm_height"],ve=["mm_dimensions","mm_duration","mm_fps","mm_height","mm_t","mm_width","t"],ye=["ceil","floor","mm_cmp","mm_horz","mm_max","mm_min","mm_vert",...ve,...ge],be="evaluator",we=e=>{const{condition:t}=e;if(ee.defined(e.is))return`${t}==${e.is}`;const i=e.in;if(ee.undefined(i))return String(t);const s=(e=>"string"==typeof e?String(e).split(","):e)(i),n=ee.string(s[0]),r=s.map((e=>n?`"${e}"`:e)),o=n?"String":"Number";return`([${r.join(",")}].includes(${o}(${t})))`};class xe{constructor(e,t,i,s){this.ceil=Math.ceil,this.floor=Math.floor,this.map=new Map,this.mm_max=Math.max,this.mm_min=Math.min,this.timeRange=e,this.context=t,this.mergeContext=s,this.size=i,this.setInputSize(this.size)}conditionalValue(e){const t=e.find((e=>{const t=(e=>e.replaceAll(" or "," || ").replaceAll(" and "," && "))(we(e));return this.evaluateExpression(t)}));if(void 0===t)throw x.eval.conditionTruth;const{value:i}=t;if(void 0===i)throw x.eval.conditionValue;return i}get duration(){return this.timeRange.lengthSeconds}evaluate(e){if("number"==typeof e)return e;const t="string"==typeof e?String(e):this.conditionalValue(e);if("number"==typeof t)return t;return this.evaluateExpression(t)}evaluateExpression(e){const t=`return ${this.replaceKeys(e)}`;try{const e=new Function(be,t);return e(this)}catch(t){return console.warn("Evaluator.evaluateExpression",t,e,this.map),e}}get(e){if(this.map.has(e))return this.map.get(e);if(!ye.includes(e))throw x.eval.get+e;const t=this[e];if(ve.includes(e))return t;if("function"==typeof t)return t.bind(this);throw x.eval.get+e}has(e){return ye.includes(e)||this.map.has(e)}initialize(e,t){return!this.has(e)&&(this.set(e,t),!0)}get inputSize(){return{width:Number(this.get("mm_input_width")),height:Number(this.get("mm_input_height"))}}get keys(){return[...new Set([...this.map.keys(),...ye])]}mm_cmp(e,t,i,s){return e>t?i:s}get mm_dimensions(){return`${this.mm_width}x${this.mm_height}`}get mm_duration(){return this.duration}get mm_fps(){return this.timeRange.fps}get mm_height(){return this.size.height}mm_horz(e,t){return this.sized(0,e,t)}get mm_t(){return this.position}mm_vert(e,t){return this.sized(1,e,t)}get mm_width(){return this.size.width}get position(){return this.timeRange.position}replaceKeys(e){let t=e;const i=Object.fromEntries(this.keys.map((e=>[e,new RegExp(`\\b${e}\\b`,"g")])));return Object.entries(i).forEach((([e,i])=>{t=t.replaceAll(i,`evaluator.get("${e}")`)})),t}set(e,t){this.map.set(e,t)}setInputSize({width:e,height:t}){this.set("in_h",t),this.set("mm_input_height",t),this.set("in_w",e),this.set("mm_input_width",e)}sized(e,t,i){const s=ee.float(t)?Number(t):parseFloat(String(t));if(ee.nan(s))throw x.eval.number+"scale";const n=ge[e],r=this.get(n),o=parseFloat(String(r));if(ee.nan(o))throw x.eval.number+`value ${n}=>${r}`;const a=o*s;if(!i)return a;const c=ge[Math.abs(e-1)],h=this.get(c);if(void 0===h)throw x.internal+"otherValue";const l=parseFloat(String(h));if(ee.nan(l))throw x.eval.number+"other";return l<=o?a:o+(s-1)*l}get t(){return this.mm_duration}}const Te=e=>X(e)?`${e[0].toUpperCase()}${e.substr(1)}`:e,_e={AddTrack:_,AddClipsToTrack:k,MoveClips:O,AddEffect:I,Change:C,ChangeFrames:S,ChangeTrim:A,Split:E,Freeze:F,MoveEffects:D,RemoveClips:z};const Ce=new class{createFromObject(e){const{type:t}=e;if("string"!=typeof t)throw x.type;return new(_e[Te(t)])(e)}},Fe=new Map,Se=new Map,Ae=e=>{const t=Se.get(e);if(t)return t;const i=[];return Se.set(e,i),i},Ie=()=>{Fe.clear()},ke=Ae(e.DefinitionType.Font),Oe=e=>{if(!Ee(e))throw x.unknown.definition;const t=Fe.get(e);if(!t)throw x.internal;return t},ze=e=>{const{type:t,id:i}=e;Fe.set(i,e),Ae(t).push(e)},Ee=e=>Fe.has(e),De=Ae(e.DefinitionType.Merger),Me=Ae(e.DefinitionType.Scaler),je=e=>{if(!Ee(e))return;const t=Oe(e);Fe.delete(e);const{type:i}=t,s=Ae(i),n=s.indexOf(t);if(n<0)throw x.internal+i+" "+e;s.splice(n,1)},Ve={byType:Ae,clear:Ie,font:ke,fromId:Oe,install:ze,installed:Ee,map:Fe,merger:De,scaler:Me,uninstall:je};class Ne{constructor(...e){const[t]=e;if(!ee.populatedObject(t))throw x.invalid.object+"instance";const{id:i,definition:s,label:n}=t;if(s)this.definition=s;else{if(!i||!Ve.installed(i))throw x.invalid.argument;this.definition=Ve.fromId(i)}n&&(this._label=n)}get copy(){return this.definition.instanceFromObject(this.toJSON())}get definitions(){return[this.definition]}definitionTime(e,t){return t.scaleToFps(e)}get id(){return this.definition.id}get label(){return this._label||this.definition.label}set label(e){this._label=e}load(e,t,i){const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.definition.load(s,n)}loaded(e,t,i){const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.definition.loaded(s,n)}get propertyNames(){return this.definition.properties.map((e=>e.name))}get propertyValues(){return Object.fromEntries(this.definition.properties.map((e=>[e.name,this.value(e.name)])))}get type(){return this.definition.type}toJSON(){return this.propertyValues}value(e){const t=this[e];if(void 0===t)throw x.property+"value "+this.propertyNames.includes(e)+" "+this[e];return t}}function Re(e){return class extends e{constructor(...e){super(...e);const[t]=e;this.constructProperties(t)}constructProperties(e={}){this.definition.properties.forEach((t=>{const{name:i}=t;void 0!==e[i]?this[i]=e[i]:void 0===this[i]&&(this[i]=t.value)}))}get definitions(){return[...super.definitions,...this.modularDefinitions]}load(e,t,i){const s=[super.load(e,t,i)],n=this.definitionTime(e,t),r=i?this.definitionTime(e,i):i;return this.modularDefinitions.forEach((e=>{s.push(e.load(n,r))})),Promise.all(s).then()}loaded(e,t,i){if(!super.load(e,t,i))return!1;const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.modularDefinitions.every((e=>e.loaded(s,n)))}get modularDefinitions(){return this.definition.propertiesModular.map((e=>String(this.value(e.name)))).map((e=>Ve.fromId(e)))}}}const Pe=Re(Ne);class qe extends Pe{toJSON(){const e=super.toJSON();return e.id=this.id,e}}class Be{get context(){if(!this.__context){const e=AudioContext||window.webkitAudioContext;if(!e)throw x.audibleContext;this.__context=new e}return this.__context}createBuffer(e){const t=44100*e;return this.context.createBuffer(2,t,44100)}createBufferSource(){return this.context.createBufferSource()}createGain(){return this.context.createGain()}decode(e){return new Promise(((t,i)=>this.context.decodeAudioData(e,(e=>t(e)),(e=>i(e)))))}get destination(){return this.context.destination}get time(){return se.fromSeconds(this.currentTime)}get currentTime(){return this.context.currentTime}}const $e={x:0,y:0};class Je{constructor(e={}){e.context2d&&(this.__context2d=e.context2d)}get alpha(){return this.context2d.globalAlpha}set alpha(e){this.context2d.globalAlpha=e}get canvas(){return this.context2d.canvas}clear(){return this.clearSize(this.size)}clearSize(e){return this.clearRect({...$e,...e})}clearRect(e){const{x:t,y:i,width:s,height:n}=e;return this.context2d.clearRect(t,i,s,n),this}get composite(){return this.context2d.globalCompositeOperation}set composite(e){this.context2d.globalCompositeOperation=e}get context2d(){if(!this.__context2d){const e=globalThis.document.createElement("canvas").getContext("2d");if(!e)throw x.internal;this.__context2d=e}return this.__context2d}set context2d(e){this.__context2d=e}get dataUrl(){return this.canvas.toDataURL()}draw(e){return this.drawAtPoint(e,$e)}drawAtPoint(e,t){const{x:i,y:s}=t;return this.context2d.drawImage(e,i,s),this}drawFill(e){return this.drawFillToSize(e,this.size)}drawFillInRect(e,t){const{x:i,y:s,width:n,height:r}=t,o=this.fill;return this.fill=e,this.context2d.fillRect(i,s,n,r),this.fill=o,this}drawFillToSize(e,t){return this.drawFillInRect(e,{...$e,...t})}drawImageData(e){return this.drawImageDataAtPoint(e,$e)}drawImageDataAtPoint(e,t){const{x:i,y:s}=t;return this.context2d.putImageData(e,i,s),this}drawInRect(e,t){const{x:i,y:s,width:n,height:r}=t;return this.context2d.drawImage(e,i,s,n,r),this}drawInRectFromRect(e,t,i){const{x:s,y:n,width:r,height:o}=t,{x:a,y:c,width:h,height:l}=i,{width:d,height:u}=e;if(s+r>d||n+o>u)throw x.eval.sourceRect+JSON.stringify(t)+" "+d+"x"+u;return this.context2d.drawImage(e,s,n,r,o,a,c,h,l),this}drawInRectFromSize(e,t,i){return this.drawInRectFromRect(e,t,{...$e,...i})}drawInSizeFromSize(e,t,i){const s={...$e,...t},n={...$e,...i};return this.drawInRectFromRect(e,s,n)}drawText(e,t){return this.drawTextAtPoint(e,t,$e)}drawTextAtPoint(e,t,i){const{x:s,y:n}=i,{height:r,family:o,color:a,shadow:c,shadowPoint:h}=t,l=this.fill,d=this.font,u=this.shadow,m=this.shadowPoint;return c&&(this.shadow=c,h&&(this.shadowPoint=h)),this.font=`${r}px "${o}"`,this.fill=a,this.context2d.fillText(e,s,n+r),this.font=d,this.fill=l,c&&(this.shadow=u,h&&(this.shadowPoint=m)),this}drawToSize(e,t){return this.drawInRect(e,{...$e,...t})}drawWithAlpha(e,t){const i=this.alpha;this.alpha=t;const s=this.draw(e);return this.alpha=i,s}drawWithComposite(e,t){const i=this.composite;this.composite=t;const s=this.draw(e);return this.composite=i,s}get fill(){return String(this.context2d.fillStyle)}set fill(e){this.context2d.fillStyle=e}get font(){return this.context2d.font}set font(e){this.context2d.font=e}get imageData(){return this.imageDataFromSize(this.size)}get imageDataFresh(){const{width:e,height:t}=this.size;return this.context2d.createImageData(e,t)}imageDataFromRect(e){const{x:t,y:i,width:s,height:n}=e;return this.context2d.getImageData(t,i,s,n)}imageDataFromSize(e){return this.imageDataFromRect({...$e,...e})}get imageSource(){return this.canvas}get shadow(){return this.context2d.shadowColor}set shadow(e){this.context2d.shadowColor=e}get shadowPoint(){return{x:this.context2d.shadowOffsetX,y:this.context2d.shadowOffsetY}}set shadowPoint(e){this.context2d.shadowOffsetX=e.x,this.context2d.shadowOffsetY=e.y}get size(){return{width:this.canvas.width,height:this.canvas.height}}set size(e){const{width:t,height:i}=e;ee.aboveZero(t)&&(this.canvas.width=t),ee.aboveZero(i)&&(this.canvas.height=i)}}const Le=["audible","visible"],Ue=Object.fromEntries(Le.map((e=>[e,e])));const Ze=new class{toSize(e){const t=this.visible();return t.size=e,t}audible(){return new Be}fromContext2D(e){return new Je({context2d:e})}get type(){return Ue}get types(){return Le}visible(){return new Je}},Ge={};class Ke{get[e.DefinitionType.Audio](){const t=Ge[e.DefinitionType.Audio];if(!t)throw x.invalid.factory+e.DefinitionType.Audio;return t}get[e.DefinitionType.Effect](){const t=Ge[e.DefinitionType.Effect];if(!t)throw x.invalid.factory+e.DefinitionType.Effect;return t}get[e.DefinitionType.Filter](){const t=Ge[e.DefinitionType.Filter];if(!t)throw x.invalid.factory+e.DefinitionType.Filter;return t}get[e.DefinitionType.Font](){const t=Ge[e.DefinitionType.Font];if(!t)throw x.invalid.factory+e.DefinitionType.Font;return t}get[e.DefinitionType.Image](){const t=Ge[e.DefinitionType.Image];if(!t)throw x.invalid.factory+e.DefinitionType.Image;return t}get[e.DefinitionType.Mash](){const t=Ge[e.DefinitionType.Mash];if(!t)throw x.invalid.factory+e.DefinitionType.Mash;return t}get[e.DefinitionType.Merger](){const t=Ge[e.DefinitionType.Merger];if(!t)throw x.invalid.factory+e.DefinitionType.Merger;return t}get[e.DefinitionType.Scaler](){const t=Ge[e.DefinitionType.Scaler];if(!t)throw x.invalid.factory+e.DefinitionType.Scaler;return t}get[e.DefinitionType.Theme](){const t=Ge[e.DefinitionType.Theme];if(!t)throw x.invalid.factory+e.DefinitionType.Theme;return t}get[e.DefinitionType.Transition](){const t=Ge[e.DefinitionType.Transition];if(!t)throw x.invalid.factory+e.DefinitionType.Transition;return t}get[e.DefinitionType.Video](){const t=Ge[e.DefinitionType.Video];if(!t)throw x.invalid.factory+e.DefinitionType.Video;return t}}const We=new Ke,He={autoplay:"autoplay",precision:"precision",loop:"loop",fps:"fps",volume:"volume",buffer:"buffer"};class Xe{constructor(e={}){this.autoplay=V.autoplay,this._buffer=V.buffer,this._fps=V.fps,this._loop=V.loop,this._muted=!1,this._paused=!0,this.precision=V.precision,this.selectedClipObject={},this._selectedClips=[],this._selectedEffects=[],this.type="masher",this._volume=V.volume;const{autoplay:t,precision:i,loop:s,fps:n,volume:r,buffer:o,audibleContext:a,visibleContext:c,mash:h}=e;void 0!==t&&(this.autoplay=t),void 0!==i&&(this.precision=i),void 0!==s&&(this._loop=s),void 0!==a&&(this._audibleContext=a),void 0!==c&&(this._visibleContext=c),this.events.addListener(this.handleMasher.bind(this)),void 0!==n&&(this._fps=n),void 0!==r&&(this._volume=r),void 0!==o&&(this._buffer=o),this._time=se.fromArgs(0,this.fps),h&&(this.mash=h)}actionCreate(e){const t=e.mash||this.mash,i=e.undoSelectedClips||this.selectedClips,s=e.undoSelectedEffects||this.selectedEffects,n=e.redoSelectedClips||this.selectedClips,r=e.redoSelectedEffects||this.selectedEffects,o={...e,mash:t,undoSelectedClips:i,undoSelectedEffects:s,redoSelectedClips:n,redoSelectedEffects:r},a=Ce.createFromObject(o);a.actions=this.actions,this.actions.do(a)}get actions(){return this._actions||(this._actions=new M({mash:this.mash})),this._actions}add(t,i=0,s=0){if(!ee.populatedObject(t))throw x.argument+"add";const{type:r}=t;if(!r)throw x.type+"Masher.add";if(r===e.DefinitionType.Effect){const e=We.effect.definition(t).instance;return this.addEffect(e,i).then((()=>e))}const o=r;if(!n.includes(o))throw x.type+r;const a=We[r].definition(t).instance;return this.addClip(a,i,s).then((()=>a))}addClip(t,i=0,s=0){const{trackType:n}=t,r=[t],o={clip:t,type:e.ActionType.AddClipsToTrack,redoSelectedClips:r,trackType:n},a=this.mash.trackOfTypeAtIndex(n,s),c=this.mash[n].length;return a.isMainVideo?(o.insertIndex=i,o.createTracks=Math.min(1,Math.max(0,1-c))):(o.trackIndex=s,t.frame=a.frameForClipsNearFrame(r,i),o.createTracks=Math.max(0,s+1-c)),this.actionCreate(o),this.loadMashAndDraw()}addEffect(t,i=0){const{effects:s}=this.selectedClipOrThrow;if(!s)throw x.selection;const n=[...s],r=[...s],o=[t];r.splice(i,0,t);const a={effects:s,undoEffects:n,redoEffects:r,redoSelectedEffects:o,type:e.ActionType.MoveEffects};return this.actionCreate(a),this.loadMashAndDraw()}addTrack(t=e.TrackType.Video){this.actionCreate({trackType:t,type:e.ActionType.AddTrack})}get audibleContext(){return this._audibleContext||(this._audibleContext=Ze.audible(),this._mash&&(this.mash.audibleContext=this._audibleContext)),this._audibleContext}set audibleContext(e){this._audibleContext!==e&&(this._audibleContext=e,this._mash&&(this.mash.audibleContext=e))}get buffer(){return this._buffer}set buffer(e){this._buffer!==e&&(this._buffer=e,this.mash.buffer=e)}can(t){const i=this._selectedClips.length;switch(t){case"save":return this.actions.canSave;case"undo":return this.actions.canUndo;case"redo":return this.actions.canRedo;case"copy":return i>0;case"cut":case"remove":return!!i;case"split":return 1===i&&this.clipCanBeSplit(this.selectedClipOrThrow,this.time,this.mash.quantize);case"freeze":return 1===i&&e.DefinitionType.Video===this.selectedClipOrThrow.type&&this.clipCanBeSplit(this.selectedClipOrThrow,this.time,this.mash.quantize);default:throw x.argument}}get canvas(){return this.visibleContext.canvas}set canvas(e){const t=e.getContext("2d");if(!t)throw x.internal+"context2d";this.events.target=e,this.context2d=t}change(e){ee.populatedObject(this.selectedClip)?ee.populatedObject(this.selectedEffect)?this.changeEffect(e):this.changeClip(e):this.changeMash(e)}changeClip(t){if(console.log(this.constructor.name,"changeClip",t),!ee.populatedString(t))throw x.property+"changeClip "+t;if(!this._pristine)throw x.internal+"changeClip _pristine";const i=this.selectedClipOrThrow,s={property:t,target:i},[n,r]=t.split(".");if(r){const e=n;if(!g.includes(e))throw x.property+"transform "+n;const o=i;s.target=o[e],s.property=r,s.redoValue=o[e].value(r);const a=this._pristine[e];if("object"!=typeof a)throw x.internal+JSON.stringify(this._pristine);const c=a[r];if(void 0===c)throw x.property+"pristine "+t+JSON.stringify(a);s.undoValue=c}else s.undoValue=this._pristine[t],s.redoValue=i.value(t);if(this.currentActionReusable(i,t)){this.actions.currentAction.updateAction(s.redoValue)}else{switch(s.property){case"frames":s.type=e.ActionType.ChangeFrames;break;case"trim":s.type=e.ActionType.ChangeTrim,s.frames=i.frames+s.undoValue;break;default:s.type=e.ActionType.Change}this.actionCreate(s)}}changeEffect(t){if(console.log(this.constructor.name,"changeEffect",t),!ee.populatedString(t))throw x.property;const i=this.selectedEffect;if(!i)throw x.selection;if(!this._pristineEffect)throw x.selection;const s=i[t];if(this.currentActionReusable(i,t)){return void this.actions.currentAction.updateAction(s)}const n=this._pristineEffect[t],r={type:e.ActionType.Change,target:i,property:t,redoValue:s,undoValue:n};this.actionCreate(r)}changeMash(t){if(!this.mash.propertyNames.includes(t))throw x.unknownMash;if(!this._pristine)throw x.selection;const i=this.mash,s=this.mash[t];if(this.currentActionReusable(i,t)){return this.actions.currentAction.updateAction(s)}const n={target:i,property:t,redoValue:s,undoValue:this._pristine[t],type:e.ActionType.Change};this.actionCreate(n)}clipCanBeSplit(e,t,i){if(!ee.object(e))return!1;const s=ne.fromTime(t),n=e.timeRange(i);if(!n.intersects(s))return!1;const r=s.scale(n.fps);return r.frame!==n.frame&&r.end!==n.end}get context2d(){return this.visibleContext.context2d}set context2d(e){this._context2D!==e&&(this._context2D=e,this._visibleContext&&(this.visibleContext.context2d=e,this.mash.compositeVisible()))}get configured(){return!0}currentActionReusable(e,t){if(!this.actions.currentActionLast)return!1;const i=this.actions.currentAction;return i instanceof C&&(i.target===e&&i.property===t)}get currentTime(){return this.time.seconds}set currentTime(e){this.time=se.fromSeconds(e,this.fps)}get definitions(){return this.mash.media}delayedDraw(){this._delayedTimer||(this._delayedTimer=setTimeout((()=>{delete this._delayedTimer,this.mash.compositeVisible()}),50))}destroy(){}draw(){this.mash.compositeVisible()}get duration(){return this.mash.duration}get endTime(){return this.mash.endTime.scale(this.fps,"floor")}get events(){return this.__events||(this.__events=new j({target:this.canvas})),this.__events}filterClipSelection(t){const i=Array.isArray(t)?t:[t],[s]=i;if(!s)return[];const{trackType:n,track:r}=s,o=i.filter((e=>e.track===r&&e.trackType===n)).sort(ue);if(r||n===e.TrackType.Audio)return o;let a=!0;return o.filter(((e,t)=>!!a&&(t===o.length-1||(a=e.frame+e.frames===o[t+1].frame),!0)))}get fps(){return this._fps}set fps(e){if(!ee.aboveZero(e))throw x.fps;this._fps!==e&&(this._fps=e,this._time=this._time.scale(e))}get frame(){return this.time.frame}set frame(e){this.time=se.fromArgs(e,this.fps)}get frames(){return this.endTime.frame}freeze(){const t=this.selectedClipOrThrow;if(!this.clipCanBeSplit(t,this.time,this.mash.quantize))throw x.invalid.action;if(e.DefinitionType.Video!==t.type)throw x.invalid.action;const i=t,s=this.time.scale(this.mash.quantize),n=this.mash.clipTrack(i).clips,r=i.copy,o=i.copy,a={frames:i.frames-(s.frame-i.frame),freezeClip:i,frozenClip:o,insertClip:r,trackClips:n,redoSelectedClips:[o],index:1+n.indexOf(i),type:e.ActionType.Freeze};o.frame=s.frame,o.frames=1,o.trim=i.trim+(s.frame-i.frame),r.frame=s.frame+1,r.frames=a.frames-1,r.trim=o.trim+1,this.actionCreate(a)}get gain(){return this.muted?0:this.volume}handleGainChange(){this.mash.gain=this.gain}handleMasher(t){if(t.type!==j.type)return;const{detail:i}=t;if(i.type===e.EventType.Action){const{action:e}=i;if(!e)throw x.internal+"action";this.selectedClips=e.selectedClips,this.selectedEffects=e.selectedEffects}}loadMash(){return this.mash.load()}loadMashAndDraw(){return this.loadMash().then((()=>{this.draw()}))}get loadedDefinitions(){return this.mash.loadedDefinitions}get loop(){return this._loop}set loop(e){this._loop=e,this._mash&&(this.mash.loop=e)}get mash(){return this._mash||(this._mash=We.mash.instance(this.mashOptions({id:"mash-id"}))),this._mash}set mash(e){this._mash!==e&&(this.paused=!0,this._mash&&this._mash.destroy(),this._selectedEffects=[],this._mash=e,this._mash.events=this.events,this._mash.visibleContext=this.visibleContext,this._mash.audibleContext=this.audibleContext,this._mash.buffer=this.buffer,this._mash.gain=this.gain,this._actions&&(this._actions.destroy(),this._actions.mash=this._mash),this.selectedClips=[],this.time=se.fromSeconds(0,this.fps),this.autoplay&&(this.paused=!1))}mashOptions(e={}){return{...e,audibleContext:this.audibleContext,buffer:this.buffer,events:this.events,gain:this.gain,loop:this.loop,visibleContext:this.visibleContext}}media(e){return e.definition}move(t,i,s=0,n=0){if(!ee.object(t))throw x.argument+"move";i!==e.MoveType.Effect?this.moveClips(t,s,n):this.moveEffects(t,s)}moveClips(t,i=0,s=0){if(!ee.positive(i))throw x.argument+"moveClips frameOrIndex";if(!ee.positive(s))throw x.argument+"moviClips trackIndex";const n=this.filterClipSelection(t);if(!ee.populatedArray(n))throw x.argument+"moviClips clips";const[r]=n,{trackType:o,track:a}=r,c={clips:n,trackType:o,trackIndex:s,undoTrackIndex:a,type:e.ActionType.MoveClips},h=this.mash.trackOfTypeAtIndex(o,s),l=this.mash.trackOfTypeAtIndex(o,a),d=h.clips.indexOf(r);if(h.isMainVideo&&(c.insertIndex=i),l.isMainVideo&&(c.undoInsertIndex=d,i<d&&(c.undoInsertIndex+=n.length)),!h.isMainVideo||!l.isMainVideo){const e=n.map((e=>e.frame)),t=h.frameForClipsNearFrame(n,i)-r.frame;if(!t)return;c.undoFrames=e,c.redoFrames=e.map((e=>e+t))}this.actionCreate(c)}moveEffects(t,i=0){if(!ee.positive(i))throw x.argument;const s=(Array.isArray(t)?t:[t]).filter((e=>e instanceof qe));if(!ee.populatedArray(s))throw x.argument;const{effects:n}=this.selectedClipOrThrow,r=[...n],o=[];r.forEach(((e,t)=>{t===i&&o.push(...s),s.includes(e)||o.push(e)}));const a={effects:n,undoEffects:r,redoEffects:o,type:e.ActionType.MoveEffects};this.actionCreate(a)}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this.handleGainChange())}pause(){this.paused=!0}get paused(){return this.mash.paused}set paused(e){this.mash.paused=e}play(){this.paused=!1}get position(){let e=0;return this._time.frame&&(e=this._time.seconds/this.duration,1!==e&&(e=parseFloat(e.toFixed(this.precision)))),e}set position(e){this.time=se.fromSeconds(this.duration*e,this.fps)}get positionStep(){return parseFloat(`0.${"0".repeat(this.precision-1)}1`)}get properties(){return Object.values(He)}redo(){this.actions.canRedo&&this.actions.redo()}remove(t,i){if(!ee.object(t))throw x.argument;return i===e.MoveType.Effect?this.removeEffects(t):this.removeClips(t)}removeClips(t){const i=this.filterClipSelection(t);if(!ee.populatedArray(i))throw x.argument;const[s]=i,n=this.mash.clipTrack(s),r={redoSelectedClips:[],clips:i,track:n,index:n.clips.indexOf(s),type:e.ActionType.RemoveClips};this.actionCreate(r)}removeEffects(t){const i=(Array.isArray(t)?t:[t]).filter((e=>e instanceof qe));if(!ee.populatedArray(i))throw x.argument;const{effects:s}=this.selectedClipOrThrow,n=[...s],r=s.filter((e=>!i.includes(e))),o={redoSelectedEffects:[],effects:s,undoEffects:n,redoEffects:r,type:e.ActionType.MoveEffects};this.actionCreate(o)}save(){this.actions.save()}select(t,i=!1){if(!t)return void(this.selectedClips=[]);if(t instanceof qe)return void this.selectEffect(t,i);const{type:s}=t;s!==e.DefinitionType.Mash?this.selectClip(t,i):this.selectMash()}selectClip(e,t){const i=[];if(e)if(t){i.push(...this.selectedClips);const t=this.selectedClips.indexOf(e);t>-1?i.splice(t,1):i.push(e)}else this.selectedClips.includes(e)?i.push(...this.selectedClips):i.push(e);this.selectedClips=i}selectEffect(e,t){const i=[];if(e)if(t){i.push(...this.selectedEffects);const t=this.selectedEffects.indexOf(e);t>-1?i.splice(t,1):i.push(e)}else i.push(e);this.selectedEffects=i}selectMash(){this.selectedClips=[]}selected(e){return e instanceof qe?this.selectedEffects.includes(e):this.selectedClips.includes(e)}get selectedClip(){return 1===this._selectedClips.length?this.selectedClipOrThrow:this.selectedClipObject}set selectedClip(e){if(e&&ee.populatedObject(e)){const t=e,{type:i}=t,s=String(i);if(!n.includes(s))return void console.warn(this.constructor.name,"set selectedClip invalid type",e);this.selectedClips=[t]}else this.selectedClips=[]}get selectedClipOrMash(){const e=this.selectedClip;return ee.populatedObject(e)?this.selectedClipOrThrow:this.mash}get selectedClipOrThrow(){if(1!==this._selectedClips.length)throw x.selection;return this._selectedClips[0]}get selectedClips(){return this._selectedClips}set selectedClips(e){this._selectedClips=this.filterClipSelection(e),this._pristine=this.selectedClipOrMash.propertyValues,this.selectedEffects=[]}get selectedEffect(){if(1===this._selectedEffects.length)return this._selectedEffects[0]}set selectedEffect(e){this.selectedEffects=e?[e]:[]}get selectedEffects(){return this._selectedEffects}set selectedEffects(e){const{effects:t}=this.selectedClipOrMash;if(!t)return this._selectedEffects=[],void(this._pristineEffect={});const i=t;this._selectedEffects=e.filter((e=>i.includes(e))),this._pristineEffect=this.selectedEffect&&this.selectedEffect.propertyValues||{}}get silenced(){return this._paused||this.muted||!this.gain}split(){const t=this.selectedClipOrThrow;if(!this.clipCanBeSplit(t,this.time,this.mash.quantize))throw x.invalid.action;const i=this.time.scale(this.mash.quantize),s=t.frames,n=i.frame-t.frame,r=t.copy;r.frames=s-n,r.frame=i.frame,t.propertyNames.includes("trim")&&(r.trim+=n);const o=this.mash.clipTrack(t).clips,a={type:e.ActionType.Split,splitClip:t,insertClip:r,trackClips:o,redoFrames:n,undoFrames:s,index:1+o.indexOf(t),redoSelectedClips:[r],undoSelectedClips:[t]};this.actionCreate(a)}get stalling(){return!this.__moving&&!this.paused}get time(){return this.mash.time}set time(e){this.mash.seekToTime(e)}undo(){this.actions.canUndo&&this.actions.undo()}get visibleContext(){return this._visibleContext||(void 0===this._context2D?this._visibleContext=Ze.visible():this._visibleContext=Ze.fromContext2D(this._context2D),this._mash&&(this.mash.visibleContext=this._visibleContext)),this._visibleContext}set visibleContext(e){this._visibleContext!==e&&(this._visibleContext=e,this._mash&&(this.mash.visibleContext=e))}get volume(){return this._volume}set volume(e){if(this._volume!==e){if(!ee.positive(e))throw x.invalid.volume;this._volume=e,ee.aboveZero(e)&&(this.muted=!1),this.handleGainChange()}}}class Ye{constructor({name:e,value:t}){if(!e)throw x.invalid.name;if(void 0===t)throw x.invalid.value;this.name=String(e),this.value=t}toJSON(){return{name:this.name,value:this.value}}}var Qe={direction4:{values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"}],value:0},direction8:{values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"},{id:4,identifier:"top_right",label:"Top Right"},{id:5,identifier:"bottom_right",label:"Bottom Right"},{id:6,identifier:"bottom_left",label:"Bottom Left"},{id:7,identifier:"top_left",label:"Top Left"}],value:0},font:{value:"com.moviemasher.font.default",modular:!0},fontsize:{value:13},integer:{value:0},mode:{value:"normal",values:[{id:"burn",identifier:"color-burn",label:"Color Burn"},{id:"dodge",identifier:"color-dodge",label:"Color Dodge"},{id:"darken",identifier:"darken",label:"Darken"},{id:"difference",identifier:"difference",label:"Difference"},{id:"exclusion",identifier:"exclusion",label:"Exclusion"},{id:"hardlight",identifier:"hard-light",label:"Hard Light"},{id:"lighten",identifier:"lighter",label:"Lighten"},{id:"multiply",identifier:"multiply",label:"Multiply"},{id:"normal",identifier:"normal",label:"Normal"},{id:"overlay",identifier:"overlay",label:"Overlay"},{id:"screen",identifier:"screen",label:"Screen"},{id:"softlight",identifier:"soft-light",label:"Soft Light"},{id:"xor",identifier:"xor",label:"Xor"}]},number:{value:0},pixel:{value:0},rgb:{value:"rgb(0, 0, 0)"},hex:{value:"#000000"},rgba:{value:"rgba(0, 0, 0, 1)"},string:{value:""},text:{value:""}};class et{constructor(e){const{id:t,identifier:i,label:s}=e;this.id=t,this.identifier=i,this.label=s}}class tt{constructor(e){this.modular=!1,this.values=[];const{value:t,values:i,modular:s,id:n}=e;if(!n)throw x.id;if(void 0===t)throw x.invalid.value+JSON.stringify(e);this.value=t,this.id=n,s&&(this.modular=s),i&&this.values.push(...i.map((e=>new et(e))))}}const it=new class{constructor(e){this.propertyTypes=new Map,Object.entries(e).forEach((e=>{const[t,i]=e,s=t;if(!f.includes(s))throw x.type+"DataTypes "+t;this.propertyTypes.set(s,new tt({...i,id:s}))}))}propertyType(e){const t=this.propertyTypes.get(e);if(!t)throw console.trace("propertyType "+e),x.type+"propertyType "+e;return t}propertyTypeDefault(e){if(!ee.populatedString(e)||!f.includes(e))throw x.type+"propertyTypeDefault "+e;const t=this.propertyType(e);return ee.object(t)?t.value:""}}(Qe);class st{constructor(e){const{type:t,name:i,value:s,custom:n}=e;if(!t)throw x.invalid.type;if(!i)throw x.invalid.name;if(void 0===s)throw x.invalid.value+JSON.stringify(e);this.type=it.propertyType(t),this.name=i,this.value=s,this.custom=!!n}toJSON(){return{value:this.value,type:this.type.id}}}class nt{constructor(...t){this.properties=[],this.retain=!1;const[i]=t;if(!ee.populatedObject(i))throw x.unknown.definition;const{id:s,label:n,icon:r}=i;if(!s)throw x.id;this.id=s,this.label=n||s,r&&(this.icon=r),this.properties.push(new st({name:"label",type:e.DataType.String,value:""}))}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Ne({...this.instanceObject,...e})}get instanceObject(){const e={};return e.definition=this,this.properties.forEach((t=>{e[t.name]=t.value})),e}load(e,t){return Promise.resolve()}loaded(e,t){return!0}loadedAudible(e){}loadedVisible(e){}get propertiesModular(){return this.properties.filter((e=>e.type.modular))}property(e){return this.properties.find((t=>t.name===e))}toJSON(){const e={id:this.id,type:this.type,label:this.label};return this.icon&&(e.icon=this.icon),e}unload(e=[]){}value(e){const t=this.property(e);if(t)return t.value}}function rt(e){return class extends e{constructor(...e){super(...e),this.audible=!0,this.gain=V.clip.audio.gain,this.gainPairs=[],this.trim=V.clip.audio.trim;const[t]=e,{gain:i,trim:s}=t;if(void 0!==i)if("string"==typeof i)if(i.includes(",")){const e=i.split(",").map((e=>parseFloat(e))),t=e.length/2;for(let i=0;i<t;i+=1)this.gainPairs.push([e[2*i],e[2*i+1]]);this.gain=-1}else this.gain=Number(i);else this.gain=i;void 0!==s&&ee.integer(s)&&(this.trim=s)}definitionTime(e,t){const i=super.definitionTime(e,t);if(!ee.aboveZero(this.trim))return i;const s=this.trimTime(e).scale(i.fps);return i.withFrame(i.frame+s.frame)}get muted(){return 0===this.gain||!ee.positive(this.gain)&&this.gainPairs===[[0,0],[1,0]]}maxFrames(e,t){const i=t||this.trim;return Math.floor(this.definition.duration*e)-i}mediaTime(e,t=!1){const{fps:i}=e,s=this.frame+this.frames,n=se.fromArgs(s,i),r=e.min(n),o=se.fromArgs(this.frame,i);let a=r.subtract(o);if(t){const e=se.fromArgs(1,i);a=a.add(e)}if(this.trim===V.clip.audio.trim)return a;const c=se.fromArgs(this.trim,i);return a.add(c)}mediaTimeRange(e){const t=e.frames>1;return ne.fromTimes(this.mediaTime(e.startTime),this.mediaTime(e.endTime,t))}toJSON(){const e=super.toJSON();return this.trim!==V.clip.audio.trim&&(e.trim=this.trim),this.gain!==V.clip.audio.gain&&(e.gain=this.gain),e}trimTime(e){return se.fromArgs(this.trim,e)}}}function ot(t){return class extends t{constructor(...t){super(...t),this.audible=!1,this.frame=0,this.frames=-1,this.track=-1,this.trackType=e.TrackType.Video,this.visible=!1;const[i]=t,{frame:s,frames:n,track:r}=i;void 0!==s&&ee.positive(s)&&(this.frame=s),n&&ee.aboveZero(n)&&(this.frames=n),void 0!==r&&(this.track=r)}definitionTime(e,t){const i=super.definitionTime(e,t),s=this.time(e).scale(i.fps),n=this.endTime(e).scale(i.fps),r=Math.max(Math.min(t.frame,n.frame),s.frame);return i.withFrame(r-s.frame)}get endFrame(){return this.frame+this.frames}endTime(e){return se.fromArgs(this.endFrame,e)}maxFrames(e,t){return 0}mediaTime(e){return e}mediaTimeRange(e){return e}time(e){return se.fromArgs(this.frame,e)}timeRange(e){return ne.fromArgs(this.frame,e,this.frames)}timeRangeRelative(e,t){const i=this.timeRange(t).scale(e.fps),s=e.frame-i.frame;return i.withFrame(s)}toJSON(){const e=super.toJSON();return e.id=this.id,e}}}const at=rt(ot(Ne));class ct extends at{constructor(){super(...arguments),this.trackType=e.TrackType.Audio}}const ht=[{name:"frame",type:e.DataType.Integer,value:0},{name:"frames",type:e.DataType.Integer,value:-1},{name:"track",type:e.DataType.Integer,value:-1}];function lt(e){return class extends e{constructor(...e){super(...e),this.audible=!1,this.visible=!1;const t=ht.map((e=>new st(e)));this.properties.push(...t)}get duration(){if(!this._duration){const e=V.media;this._duration=Number(e[this.type].duration)}return this._duration}set duration(e){this._duration=e}}}const dt=new class{constructor(){this.cachedByKey=new Map,this.urlsByKey=new Map}add(e,t){console.log(this.constructor.name,"add",e,t.constructor.name);const i=this.key(e);this.cachedByKey.set(i,t),this.urlsByKey.set(i,e)}cached(e){if(!ee.populatedString(e))throw x.argument+"url";return this.cachedByKey.has(this.key(e))}get(e){return this.cachedByKey.get(this.key(e))}key(e){if(!ee.populatedString(e))throw console.trace(),x.argument+"url";return"cachekey"+e.replaceAll(/[^a-z0-9]/gi,"")}remove(e){console.log(this.constructor.name,"remove",e);const t=this.key(e);this.cachedByKey.delete(t),this.urlsByKey.delete(t)}};class ut{process(e,t){return Promise.resolve()}}class mt extends ut{constructor(e){super(),e&&e.audibleContext?this._audibleContext=e.audibleContext:this._audibleContext=Ze.audible()}get audibleContext(){return this._audibleContext}set audibleContext(e){this._audibleContext=e}process(e,t){return this.audibleContext.decode(t)}}class ft extends ut{process(e,t){const i=dt.key(e),s=new FontFace(i,t);return s.load().then((()=>(document.fonts.add(s),{family:i})))}}class pt extends ut{process(e,t){return Promise.resolve()}}class gt{async loadUrl(e){if(dt.cached(e)){const t=dt.get(e);return t instanceof Promise?t:Promise.resolve()}const t=this.requestUrl(e);dt.add(e,t);const i=await t;return dt.add(e,i),i}requestUrl(e){return Promise.resolve()}}const vt={Audio:mt,Font:ft,Module:pt};const yt=new class{audio(e){return new vt.Audio(e)}font(){return new vt.Font}install(e,t){vt[Te(e)]=t}module(){return new vt.Module}};class bt extends gt{constructor(t){super(),this.type=e.LoadType.Audio,t&&t.audibleContext?this._audibleContext=t.audibleContext:this._audibleContext=Ze.audible()}get audibleContext(){return this._audibleContext}set audibleContext(e){this._audibleContext=e}async requestUrl(e){return fetch(e).then((e=>e.arrayBuffer())).then((t=>{const i={audibleContext:this.audibleContext};return yt.audio(i).process(e,t)}))}}class wt extends gt{constructor(){super(...arguments),this.type=e.LoadType.Font}requestUrl(e){return fetch(e).then((e=>e.arrayBuffer())).then((t=>yt.font().process(e,t)))}}class xt extends gt{constructor(){super(...arguments),this.type=e.LoadType.Image}requestUrl(e){const t=new Image;return t.crossOrigin="Anonymous",t.src=e,t.decode().then((()=>Promise.resolve(t)))}}class Tt extends gt{constructor(){super(...arguments),this.type=e.LoadType.Module}async requestUrl(e){return import(e)}}const _t={Audio:bt,Font:wt,Image:xt,Module:Tt};const Ct=new class{audio(e){return new _t.Audio(e)}font(){return new _t.Font}image(){return new _t.Image}install(e,t){_t[Te(e)]=t}module(){return new _t.Module}};function Ft(t){return class extends t{constructor(...t){super(...t),this.audible=!0,this.loops=!1;const[i]=t,{loops:s,duration:n,url:r,audio:o,source:a,waveform:c}=i;if(!n)throw x.invalid.definition.duration;this.duration=Number(n);const h=o||r||a||"";if(!h)throw x.invalid.definition.audio;this.urlAudible=h,s&&(this.loops=!!s),a&&(this.source=a),c&&(this.waveform=c),this.properties.push(new st({name:"gain",type:e.DataType.Number,value:1})),this.properties.push(new st({name:"trim",type:e.DataType.Integer,value:0}))}load(e,t){const i=[super.load(e,t)];if(t)if(dt.cached(this.urlAudible)){const e=dt.get(this.urlAudible);e instanceof Promise&&i.push(e)}else i.push(Ct.audio().loadUrl(this.urlAudible));return Promise.all(i).then()}loaded(e,t){return super.loaded(e,t)&&dt.cached(this.urlAudible)}loadedAudible(e){return dt.get(this.urlAudible)}toJSON(){const e=super.toJSON();return e.duration=this.duration,e.audio=this.urlAudible,this.loops&&(e.loops=!0),this.source&&(e.source=this.source),this.waveform&&(e.waveform=this.waveform),e}unload(e=[]){super.unload(e),e.length&&e.some((e=>2===e.length))||dt.cached(this.urlAudible)&&dt.remove(this.urlAudible)}}}const St=Ft(lt(nt));class At extends St{constructor(...t){super(...t),this.trackType=e.TrackType.Audio,this.type=e.DefinitionType.Audio,Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){const t={...this.instanceObject,...e};return new ct(t)}}const It=e=>{const{id:t}=e;if(!t)throw x.id;return Ve.installed(t)?Ve.fromId(t):new At(e)},kt=e=>It({id:e}),Ot=e=>It(e).instanceFromObject(e),zt=e=>Ot({id:e}),Et=()=>{},Dt=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),It(e)},Mt={define:Dt,definition:It,definitionFromId:kt,fromId:zt,initialize:Et,instance:Ot};Ge.audio=Mt;class jt extends Ne{constructor(...e){super(...e),this.parameters=[];const[t]=e;if(!ee.populatedObject(t))throw x.invalid.object+"filter";const{parameters:i}=t;i&&this.parameters.push(...i.map((e=>new Ye(e))))}drawFilter(e){return this.definition.scopeSet(e),this.definition.draw(e,this.evaluated(e))}evaluated(e){const t={},i=[...this.parameters];return this.definition.parameters.forEach((e=>{i.find((t=>t.name===e.name))||i.push(e)})),ee.populatedArray(i)?(i.forEach((i=>{const{name:s,value:n}=i;if(!ee.populatedString(s))return;const r=e.evaluate(n);return t[s]=r,e.set(s,r),`${s}=>${r}`})),t):t}toJSON(){const e={id:this.id};return this.parameters.length&&(e.parameters=this.parameters),e}}class Vt extends nt{constructor(...t){super(...t),this.parameters=[],this.type=e.DefinitionType.Filter,Ve.install(this)}draw(e,t){throw x.unimplemented}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new jt({...this.instanceObject,...e})}scopeSet(e){}}const Nt="rgba";var Rt={label:"Blackout Two AM",id:"com.moviemasher.font.default",type:"font",source:"../examples/javascript/media/font/blackout/theleagueof-blackout/webfonts/blackout_two_am-webfont.ttf",family:"Blackout Two AM"};class Pt extends Ne{}class qt extends nt{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Font;const[i]=t,{source:s}=i;if(!s)throw x.invalid.definition.source+JSON.stringify(i);this.source=s,Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Pt({...this.instanceObject,...e})}load(e,t){const i=[super.load(e,t)];if(dt.cached(this.source)){const e=dt.get(this.source);e instanceof Promise&&i.push(e)}else i.push(Ct.font().loadUrl(this.source));return Promise.all(i).then()}loaded(e,t){return super.loaded(e,t)&&dt.cached(this.source)}loadedVisible(e){return dt.get(this.source)}toJSON(){return{...super.toJSON(),source:this.source}}}const Bt="com.moviemasher.font.default",$t=t=>{const{id:i}=t,s=i&&ee.populatedString(i)?i:Bt;return Ve.installed(s)||new qt({...t,type:e.DefinitionType.Font,id:s}),Ve.fromId(s)},Jt=e=>$t({id:e}),Lt=e=>$t(e).instanceFromObject(e),Ut=e=>Lt({id:e}),Zt=()=>{$t(Rt)},Gt=e=>{const{id:t}=e,i=t&&ee.populatedString(t)?t:Bt;return Ve.uninstall(i),$t(e)},Kt={define:Gt,definition:$t,definitionFromId:Jt,fromId:Ut,initialize:Zt,instance:Lt};Ge.font=Kt;const Wt=e=>{if(!ee.populatedString(e))throw x.id;return Kt.definitionFromId(e).source},Ht=e=>String(e),Xt=e=>dt.key(Wt(e));const Yt={setsar:class extends Vt{constructor(){super(...arguments),this.id="setsar"}draw(e,t){return e.context}},blend:class extends Vt{constructor(){super(...arguments),this.id="blend"}draw(t,i){const{context:s,mergeContext:n}=t;if(void 0===n)throw x.internal+"BlendFilter mergeContext";const r=it.propertyType(e.DataType.Mode).values;if(void 0===r)throw x.unknown.mode;const o=r.find((e=>e.id===i.all_mode));if(void 0===o)throw x.unknown.mode;const{identifier:a}=o;return n.drawWithComposite(s.imageSource,a),n}},chromakey:class extends Vt{constructor(){super(...arguments),this.id="chromakey",this.parameters=[new Ye({name:"color",value:"color"}),new Ye({name:"similarity",value:"similarity"}),new Ye({name:"blend",value:"blend"})]}draw(e,t){const{context:i}=e,{width:s,height:n}=i.size,{accurate:r}=t,o=Number(t.similarity),a=Number(t.blend),c=String(t.color),h=c.substr(4,c.length-5).split(",").map((e=>Number(e))),l={r:h[0],g:h[1],b:h[2]},d=ce.rgb2yuv(l),u=i.imageData,m=u.data,f=r?this.yuvsFromPixelsAccurate(m,s,n):this.yuvsFromPixels(m);let p=0;return f.forEach((e=>{m[p+3]=ce.yuvBlend(e,d,o,a),p+=4})),i.drawImageData(u),i}yuvsFromPixels(e){const t=[];for(let i=e.length/4-1;i>0;i-=1)t.push([ce.rgb2yuv(de.rgbaAtIndex(4*i,e))]);return t}yuvsFromPixelsAccurate(e,t,i){const s=[];for(let n=e.length/4-1;n>0;n-=1){const r=de.rgbs(4*n,e,{width:t,height:i});s.push(r.map((e=>ce.rgb2yuv(e))))}return s}},color:class extends Vt{constructor(){super(...arguments),this.id="color",this.parameters=[new Ye({name:"color",value:"color"}),new Ye({name:"size",value:"mm_dimensions"}),new Ye({name:"duration",value:"mm_duration"}),new Ye({name:"rate",value:"mm_fps"})]}draw(e,t){const{context:i}=e,{color:s}=t;return X(s)?(i.drawFill(de.color(s)),i):i}},colorchannelmixer:class extends Vt{constructor(){super(...arguments),this.id="colorchannelmixer"}draw(e,t){const i=Object.fromEntries(Object.entries(t).map((e=>{const[t,i]=e;return[t,Number(i)]}))),{context:s}=e,n="rgba".split("");n.forEach((e=>{n.forEach((t=>{const s=`${e}${t}`;null===i[s]&&(i[s]=e===t?1:0)}))}));const{imageData:r}=s,{data:o}=r;return o.forEach(((e,t)=>{const s=o[t+1],n=o[t+2],r=o[t+3];o[t]=e*i.rr+s*i.rg+n*i.rb+r*i.ra,o[t+1]=e*i.gr+s*i.gg+n*i.gb+r*i.ga,o[t+2]=e*i.br+s*i.bg+n*i.bb+r*i.ba,o[t+3]=e*i.ar+s*i.ag+n*i.ab+r*i.aa})),s.drawImageData(r),s}},convolution:class extends Vt{constructor(){super(...arguments),this.id="convolution"}draw(e,t){const i=(e=>{const t={bias:{},rdiv:{},matrix:{}};return Nt.split("").forEach(((i,s)=>{const n=e[`${s}m`].split(" ").map((e=>parseInt(e)));if(t.matrix[i]=n,t.rdiv[i]=e[`${s}rdiv`]||1,String(t.rdiv[i]).includes("/")){const e=String(t.rdiv[i]).split("/");t.rdiv[i]=parseFloat(e[0])/parseFloat(e[1])}else t.rdiv[i]=parseFloat(String(t.rdiv[i]));t.bias[i]=e[`${s}bias`]||0})),t})(t),{context:s}=e,{size:n}=s,{width:r,height:o}=n,a=s.imageData,c=s.imageDataFresh,h=a.data,l=c.data,d=r*o;for(let e=0;e<d;e+=1){const t=de.rgbs(e,h,n);Nt.split("").forEach(((s,n)=>{const r=i.rdiv[s],o=i.matrix[s],a=i.bias[s];let c=0;for(let e=0;e<9;e+=1)c+=t[e][s]*o[e];c=Math.floor(c*r+a+.5),l[4*e+n]=c}))}return s.drawImageData(c),s}},crop:class extends Vt{constructor(){super(...arguments),this.id="crop"}draw(e,t){const{context:i}=e,s=t.x||0,n=t.y||0,r=e.inputSize;let o=t.w||t.out_w||0,a=t.h||t.out_h||0;if(o+a<2)throw x.eval.outputSize;-1===o&&(o=r.width*(a/r.height)),-1===a&&(a=r.height*(o/r.width));const c={width:o,height:a},h={x:s,y:n,...c},l=Ze.toSize(c);return l.drawInRectFromSize(i.imageSource,h,c),l}scopeSet(e){e.setInputSize(e.context.size),e.initialize("x","((in_w - out_w) / 2)"),e.initialize("y","((in_h - out_h) / 2)")}},drawbox:class extends Vt{constructor(){super(...arguments),this.id="drawbox"}draw(e,t){const{context:i}=e,s=X(t.color)?t.color:"black",n=t.x||0,r=t.y||0,o=t.width||i.size.width,a=t.height||i.size.height;return i.drawFillInRect(de.color(s),{x:n,y:r,width:o,height:a}),i}},drawtext:class extends Vt{constructor(){super(...arguments),this.id="drawtext",this.parameters=[new Ye({name:"fontcolor",value:"#000000"}),new Ye({name:"shadowcolor",value:"#FFFFFF"}),new Ye({name:"fontsize",value:"mm_vert(20)"}),new Ye({name:"x",value:"0"}),new Ye({name:"y",value:"0"}),new Ye({name:"shadowx",value:"mm_horz(5)"}),new Ye({name:"shadowy",value:"mm_vert(5)"}),new Ye({name:"fontfile",value:"mmFontFile('com.moviemasher.font.default')"}),new Ye({name:"textfile",value:"Hello World"})]}draw(e,t){const{context:i}=e,s=String(e.get("fontface")),n=Xt(s),{x:r,y:o,fontsize:a,fontcolor:c,text:h,textfile:l,shadowcolor:d,shadowx:u,shadowy:m}=t;if(!a||!ee.aboveZero(a))throw x.eval.number+" fontsize";const f={height:Number(a),family:n,color:String(c||"black"),shadow:String(d||""),shadowPoint:{x:Number(u||0),y:Number(m||0)}},p={x:Number(r||0),y:Number(o||0)},g=String(h||l);return i.drawTextAtPoint(g,f,p),i}scopeSet(e){e.set("text_w",0),e.set("text_h",0),e.set("mmFontFamily",Xt),e.set("mmTextFile",Ht),e.set("mmFontFile",Wt),e.set("mm_fontfamily",Xt),e.set("mm_textfile",Ht),e.set("mm_fontfile",Wt)}},fade:class extends Vt{constructor(){super(...arguments),this.id="fade"}draw(e){const{context:t}=e,i=Ze.toSize(t.size);return i.drawWithAlpha(t.imageSource,e.position),i}},overlay:class extends Vt{constructor(){super(...arguments),this.id="overlay"}draw(e,t){const{x:i,y:s}=t,{context:n,mergeContext:r}=e;if(void 0===r)throw x.internal+"OverlayFilter mergeContext";return r.drawAtPoint(n.imageSource,{x:i||0,y:s||0}),r}scopeSet(e){const{width:t,height:i}=e.context.size;e.set("overlay_w",t),e.set("overlay_h",i)}},scale:class extends Vt{constructor(){super(...arguments),this.id="scale"}draw(e,t){const{context:i}=e;let s=t.w||t.width||0,n=t.h||t.height||0;if(s+n<2)return i;const r={width:Number(e.get("mm_in_w")),height:Number(e.get("mm_in_h"))};-1===s?s=r.width*(n/r.height):-1===n&&(n=r.height*(s/r.width));const o={width:s,height:n},a=Ze.toSize(o);return a.drawInSizeFromSize(i.imageSource,r,o),a}scopeSet(e){const{width:t,height:i}=e.context.size;e.set("in_h",i),e.set("mm_in_h",i),e.set("in_w",t),e.set("mm_in_w",t)}}},Qt=t=>{const{id:i}=t;if(!i||"string"!=typeof i||!i.length)throw x.id;if(Ve.installed(i))return Ve.fromId(i);if(!Yt[i])throw x.unknown.filter;return new Yt[i]({id:i,type:e.DefinitionType.Filter})},ei=e=>Qt({id:e}),ti=e=>{const{id:t}=e;if(!t)throw x.id;return Qt({id:t}).instanceFromObject(e)},ii=e=>ti({id:e}),si=()=>{},ni=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),Qt(e)},ri={define:ni,definition:Qt,definitionFromId:ei,fromId:ii,initialize:si,instance:ti};function oi(e){return class extends e{constructor(...e){super(...e),this.filters=[];const[t]=e,{properties:i,filters:s}=t;if(i){const e=Object.entries(i).map((e=>{const[t,i]=e;if(!ee.object(i))throw x.invalid.property+"name "+t;const s=Object.assign(i,{name:t,custom:!0});return new st(s)}));this.properties.push(...e)}if(s){const e=s.map((e=>{const{id:t}=e;if(!t)throw x.id;return ti(e)}));this.filters.push(...e)}}drawFilters(e,t,i,s,n){let r=i;return this.filters.forEach((i=>{const o=this.evaluator(e,t,r,s,n);r=i.drawFilter(o)})),r}evaluator(e,t,i,s,n){const r=new xe(t,i,s,n);return this.propertiesCustom.forEach((t=>{const i=e.value(t.name);r.set(t.name,i)})),r}get propertiesCustom(){return this.properties.filter((e=>e.custom))}toJSON(){const e=super.toJSON();this.filters.length&&(e.filters=this.filters);const t=this.propertiesCustom.map((e=>[e.name,e]));return t.length&&(e.properties=Object.fromEntries(t)),e}}}Ge.filter=ri;const ai=oi(nt);class ci extends ai{constructor(...t){super(...t),this.type=e.DefinitionType.Effect,Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new qe({...this.instanceObject,...e})}}const hi={"com.moviemasher.effect.blur":{label:"Blur",type:"effect",id:"com.moviemasher.effect.blur",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"1 1 1 1 1 1 1 1 1"},{name:"1m",value:"1 1 1 1 1 1 1 1 1"},{name:"2m",value:"1 1 1 1 1 1 1 1 1"},{name:"3m",value:"1 1 1 1 1 1 1 1 1"},{name:"0rdiv",value:"1/9"},{name:"1rdiv",value:"1/9"},{name:"2rdiv",value:"1/9"},{name:"3rdiv",value:"1/9"}]}]},"com.moviemasher.effect.chromakey":{label:"Chromakey",type:"effect",id:"com.moviemasher.effect.chromakey",properties:{chroma_blend:{type:"number",value:.01},chroma_similarity:{type:"number",value:.5},chroma_color:{type:"rgb",value:"rgb(0,255,0)"}},filters:[{id:"chromakey",parameters:[{name:"color",value:"chroma_color"},{name:"blend",value:"chroma_blend"},{name:"similarity",value:"chroma_similarity"}]}]},"com.moviemasher.effect.emboss":{label:"Emboss",type:"effect",id:"com.moviemasher.effect.emboss",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"1m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"2m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"3m",value:"-2 -1 0 -1 1 1 0 1 2"}]}]},"com.moviemasher.effect.grayscale":{label:"Grayscale",type:"effect",id:"com.moviemasher.effect.grayscale",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.3},{name:"rg",value:.4},{name:"rb",value:.3},{name:"ra",value:0},{name:"gr",value:.3},{name:"gg",value:.4},{name:"gb",value:.3},{name:"ga",value:0},{name:"br",value:.3},{name:"bg",value:.4},{name:"bb",value:.3},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]},"com.moviemasher.effect.sepia":{label:"Sepia",type:"effect",id:"com.moviemasher.effect.sepia",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.393},{name:"rg",value:.769},{name:"rb",value:.189},{name:"ra",value:0},{name:"gr",value:.349},{name:"gg",value:.686},{name:"gb",value:.168},{name:"ga",value:0},{name:"br",value:.272},{name:"bg",value:.534},{name:"bb",value:.131},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]},"com.moviemasher.effect.sharpen":{label:"Sharpen",type:"effect",id:"com.moviemasher.effect.sharpen",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"1m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"2m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"3m",value:"0 -1 0 -1 5 -1 0 -1 0"}]}]},"com.moviemasher.effect.text":{label:"Text Box",type:"effect",id:"com.moviemasher.effect.textbox",properties:{string:{type:"string",value:"Text Box"},size:{type:"fontsize",value:.2},color:{type:"rgba",value:"rgba(255,0,0,1)"},fontface:{type:"font",value:"com.moviemasher.font.default"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},x:{type:"number",value:0},y:{type:"number",value:0}},filters:[{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]}},li=t=>{const{id:i}=t;if(!i||!i.length)throw x.id;if(!Ve.installed(i)){const s={type:e.DefinitionType.Effect};hi[i]&&Object.assign(s,hi[i]),Object.assign(s,t),new ci(s)}return Ve.fromId(i)},di=e=>li({id:e}),ui=e=>li(e).instanceFromObject(e),mi=e=>ui({id:e}),fi=()=>{},pi=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),li(e)},gi={define:pi,definition:li,definitionFromId:di,fromId:mi,initialize:fi,instance:ui};Ge.effect=gi;const vi=Re(Ne);class yi extends vi{get id(){return this.definition.id}set id(e){this.definition=We.merger.definitionFromId(e),this.constructProperties()}}const bi=oi(nt);class wi extends bi{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Merger,this.properties.push(new st({name:"id",type:e.DataType.String,value:""})),Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new yi({...this.instanceObject,...e})}}var xi={label:"Blend",id:"com.moviemasher.merger.blend",type:"merger",properties:{mode:{type:"mode",value:"normal"}},filters:[{id:"blend",parameters:[{name:"all_mode",value:"mode"},{name:"repeatlast",value:"0"}]}]};var Ti={label:"Center",id:"com.moviemasher.merger.center",type:"merger",filters:[{id:"overlay",parameters:[{name:"x",value:"floor((mm_width - overlay_w) / 2)"},{name:"y",value:"floor((mm_height - overlay_h) / 2)"}]}]};var _i={label:"Constrained",type:"merger",id:"com.moviemasher.merger.constrained",properties:{left:{type:"pixel",value:0},top:{type:"pixel",value:0}},filters:[{id:"overlay",parameters:[{name:"x",value:"left*(mm_width-overlay_w)"},{name:"y",value:"top*(mm_height-overlay_h)"}]}]};var Ci={label:"Top Left",id:"com.moviemasher.merger.default",type:"merger",filters:[{id:"overlay",parameters:[{name:"x",value:"0"},{name:"y",value:"0"}]}]};var Fi={label:"Overlay",id:"com.moviemasher.merger.overlay",type:"merger",properties:{left:{type:"pixel",value:.5},top:{type:"pixel",value:.5}},filters:[{id:"overlay",parameters:[{name:"x",value:"((mm_width + overlay_w) * left) - overlay_w"},{name:"y",value:"((mm_height + overlay_h) * top) - overlay_h"}]}]};const Si="com.moviemasher.merger.default",Ai=t=>{const{id:i}=t,s=i&&ee.populatedString(i)?i:Si;return Ve.installed(s)||new wi({...t,type:e.DefinitionType.Merger,id:s}),Ve.fromId(s)},Ii=e=>Ai({id:e}),ki=e=>Ai(e).instanceFromObject(e),Oi=e=>ki({id:e}),zi=()=>{Ai(xi),Ai(Ti),Ai(_i),Ai(Ci),Ai(Fi)},Ei=e=>{const{id:t}=e,i=t&&ee.populatedString(t)?t:Si;return Ve.uninstall(i),Ai(e)},Di={define:Ei,definition:Ai,definitionFromId:Ii,fromId:Oi,initialize:zi,instance:ki};Ge.merger=Di;const Mi=Re(Ne);class ji extends Mi{get id(){return this.definition.id}set id(e){this.definition=We.scaler.definitionFromId(e),this.constructProperties()}}const Vi=oi(nt);class Ni extends Vi{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Scaler,this.properties.push(new st({name:"id",type:e.DataType.String,value:""})),Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new ji({...this.instanceObject,...e})}}var Ri={label:"Stretch",id:"com.moviemasher.scaler.default",type:"scaler",filters:[{id:"scale",parameters:[{name:"width",value:"mm_width"},{name:"height",value:"mm_height"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var Pi={label:"Pan",type:"scaler",id:"com.moviemasher.scaler.pan",properties:{scale:{type:"number",value:1.25},direction:{type:"direction8",value:1}},filters:[{id:"crop",description:"crop down diagonals and center",parameters:[{name:"out_w",value:[{condition:"direction < 4",value:"mm_input_width"},{condition:"true",value:"mm_horz(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"out_h",value:[{condition:"direction < 4",value:"mm_input_height"},{condition:"true",value:"mm_vert(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"x",value:"(mm_input_width-out_w)/2"},{name:"y",value:"(mm_input_height-out_h)/2"}]},{id:"scale",description:"scale (proudly for diagonals)",parameters:[{name:"w",value:[{condition:"direction < 4",value:"mm_input_width * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_horz(scale, true)"}]},{name:"h",value:[{condition:"direction < 4",value:"mm_input_height * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_vert(scale, true)"}]}]},{id:"crop",description:"crop down and position over time",parameters:[{name:"w",value:"mm_width"},{name:"h",value:"mm_height"},{name:"x",value:[{condition:"direction",in:[0,2],value:"(in_w-mm_width)/2"},{condition:"direction",in:[1,5],value:"(in_w-mm_width)*mm_t"},{condition:"direction",is:4,value:"(in_w-mm_width)*mm_t"},{condition:"direction",in:[3,7],value:"(in_w-mm_width)-((in_w-mm_width)*mm_t)"},{condition:"direction",is:6,value:"floor(((in_w-mm_width)*(1.0-mm_t)))"}]},{name:"y",value:[{condition:"direction",in:[1,3],value:"(in_h-mm_height)/2"},{condition:"direction",in:[2,5],value:"(in_h-mm_height)*mm_t"},{condition:"direction",is:6,value:"ceil((in_h-mm_height)*mm_t)"},{condition:"direction",in:[0,7],value:"(in_h-mm_height)-((in_h-mm_height)*mm_t)"},{condition:"direction",is:4,value:"(in_h-mm_height)-((in_h-mm_height) * mm_t)"}]}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var qi={label:"Scale",type:"scaler",id:"com.moviemasher.scaler.scale",properties:{scale:{type:"number",value:1}},filters:[{id:"scale",parameters:[{name:"width",value:"scale * mm_input_width * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"},{name:"height",value:"scale * mm_input_height * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};const Bi="com.moviemasher.scaler.default",$i=t=>{const{id:i}=t,s=i&&"string"==typeof i&&i.length?i:Bi;return Ve.installed(s)||new Ni({...t,type:e.DefinitionType.Scaler,id:s}),Ve.fromId(s)},Ji=e=>$i(e).instanceFromObject(e),Li=()=>{$i(Ri),$i(Pi),$i(qi)},Ui={define:e=>{const{id:t}=e,i=t&&ee.populatedString(t)?t:Bi;return Ve.uninstall(i),$i(e)},definitionFromId:e=>$i({id:e}),definition:$i,instance:Ji,fromId:e=>Ji({id:e}),initialize:Li};function Zi(e){return class extends e{constructor(...e){super(...e),this.effects=[];const[t]=e,{merger:i,effects:s,scaler:n}=t;if(this.merger=ki(i||{}),this.scaler=Ji(n||{}),s){const e=s.map((e=>ui(e)));this.effects.push(...e)}}get definitions(){return[...super.definitions,...this.merger.definitions,...this.scaler.definitions,...this.effects.flatMap((e=>e.definitions))]}effectedContextAtTimeToSize(e,t,i){const s=this.scaledContextAtTimeToSize(e,t,i);if(!s)return;let n=s;if(!this.effects)return n;const r=this.timeRangeRelative(e,t);return r?(this.effects.reverse().every((e=>n=e.definition.drawFilters(e,r,n,i))),n):void 0}load(e,t,i){const s=[super.load(e,t,i)];return s.push(this.merger.load(e,t,i)),s.push(this.scaler.load(e,t,i)),this.effects.forEach((n=>{s.push(n.load(e,t,i))})),Promise.all(s).then()}mergeContextAtTime(e,t,i){const s=this.effectedContextAtTimeToSize(e,t,i.size);if(!s)return;const n=this.timeRangeRelative(e,t);this.merger.definition.drawFilters(this.merger,n,s,i.size,i)}get propertyValues(){return{merger:this.merger.propertyValues,scaler:this.scaler.propertyValues,...super.propertyValues}}scaledContextAtTimeToSize(e,t,i){const s=this.contextAtTimeToSize(e,t,i);if(!s)return;const n=this.timeRangeRelative(e,t);return ee.undefined(n)?s:this.scaler.definition.drawFilters(this.scaler,n,s,i)}toJSON(){const e=super.toJSON();return this.effects.length&&(e.effects=this.effects),e}}}function Gi(t){return class extends t{constructor(){super(...arguments),this.trackType=e.TrackType.Video,this.visible=!0}contextAtTimeToSize(e,t,i){const s=this.definitionTime(t,e),n=this.definition.loadedVisible(s);if(!n)return;const r=Number(n.width),o=Number(n.height),a=Ze.toSize({width:r,height:o});return a.draw(n),a}mergeContextAtTime(e,t,i){}}}Ge.scaler=Ui;const Ki=Zi(Gi(ot(Ne)));class Wi extends Ki{}function Hi(t){return class extends t{constructor(){super(...arguments),this.trackType=e.TrackType.Video,this.visible=!0}}}const Xi=Hi(lt(nt));class Yi extends Xi{constructor(...t){super(...t),this.source="",this.type=e.DefinitionType.Image;const[i]=t;if(!i)throw x.unknown.definition;const{url:s,source:n}=i;if(!s)throw x.invalid.definition.url;this.urlVisible=s,n&&(this.source=n),Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Wi({...this.instanceObject,...e})}load(e,t){const i=[super.load(e,t)];if(dt.cached(this.urlVisible)){const e=dt.get(this.urlVisible);e instanceof Promise&&i.push(e)}else i.push(Ct.image().loadUrl(this.urlVisible));return Promise.all(i).then()}loaded(e,t){return super.loaded(e,t)&&dt.cached(this.urlVisible)}loadedVisible(e){return dt.get(this.urlVisible)}toJSON(){const e=super.toJSON();return e.url=this.urlVisible,this.source&&(e.source=this.source),e}unload(e=[]){super.unload(e),e.length||dt.cached(this.urlVisible)&&dt.remove(this.urlVisible)}}const Qi=e=>{const{id:t}=e;if(!t)throw x.id;return Ve.installed(t)?Ve.fromId(t):new Yi(e)},es=e=>Qi({id:e}),ts=e=>Qi(e).instanceFromObject(e),is=e=>ts({id:e}),ss=()=>{},ns=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),Qi(e)},rs={define:ns,definition:Qi,definitionFromId:es,fromId:is,initialize:ss,instance:ts};Ge.image=rs;class os{constructor(t){this.clips=[],this.index=0,this.type=e.TrackType.Video;const{clips:i,index:s,type:n}=t;s&&(this.index=s),n&&(this.type=n),i&&this.clips.push(...i.map((e=>{const{id:t}=e;if(!t)throw x.id;const i=Ve.fromId(t),s={track:this.index,...e};return i.instanceFromObject(s)})))}get frames(){if(!this.clips.length)return 0;const e=this.clips[this.clips.length-1];return e.frame+e.frames}get isMainVideo(){return!this.index&&this.type===e.TrackType.Video}addClips(e,t=0){let i=t||0;this.isMainVideo||(i=0);const s=i,n=[],r=this.clips.filter(((t,r)=>{const o=e.includes(t);return o&&n.push(t),s&&o&&r<s&&(i-=1),!o}));r.splice(i,0,...e),this.sortClips(r);e.filter((e=>!n.includes(e))).forEach((e=>{e.track=this.index})),this.clips.splice(0,this.clips.length,...r)}frameForClipsNearFrame(e,t=0){if(this.isMainVideo)return t;const i=this.clips.filter((i=>!e.includes(i)&&i.endFrame>t));if(!i.length)return t;const s=Math.min(...e.map((e=>e.frame))),n=Math.max(...e.map((e=>e.endFrame)))-s;let r=t;return i.find((e=>{if(e.frame>=r+n)return!0;r=e.endFrame})),r}removeClips(e){const t=this.clips.filter((t=>!e.includes(t)));if(t.length===this.clips.length)throw x.internal+"removeClips";e.forEach((e=>{e.track=-1})),this.sortClips(t),this.clips.splice(0,this.clips.length,...t)}sortClips(t){if(this.isMainVideo){let i=0;t.forEach(((t,s)=>{const n=t.type===e.DefinitionType.Transition;s&&n&&(i-=t.frames),t.frame=i,n||(i+=t.frames)}))}t.sort(ue)}toJSON(){return{type:this.type,index:this.index,clips:this.clips}}}class as{constructor(e){this.buffer=V.buffer,this.contextSeconds=0,this._gain=V.volume,this.mashSeconds=0,this.playing=!1,this.quantize=V.fps,this.sourcesByClip=new Map;const{audibleContext:t,backcolor:i,buffer:s,gain:n,quantize:r,visibleContext:o}=e;i&&(this.backcolor=i),r&&ee.aboveZero(r)&&(this.quantize=r),this._audibleContext=t||Ze.audible(),this._visibleContext=o||Ze.visible(),void 0!==n&&ee.positive(n)&&(this._gain=n),s&&ee.aboveZero(s)&&(this.buffer=s)}adjustSourceGain(e){const t=this.sourcesByClip.get(e);if(!t)return;const{gainNode:i}=t;if(0===this.gain)return void(i.gain.value=0);const s=e.gain;if(ee.positive(s))return void(i.gain.value=this.gain*s);const n=this.clipTiming(e),{start:r,duration:o}=n;i.gain.cancelScheduledValues(0),e.gainPairs.forEach((e=>{const[t,s]=e;i.gain.linearRampToValueAtTime(this.gain*s,r+t*o)}))}get audibleContext(){return this._audibleContext}set audibleContext(e){this._audibleContext=e}clipTiming(e){const t=e.timeRange(this.quantize);let i=0,s=this.contextSeconds-this.mashSeconds+t.seconds,n=t.lengthSeconds;e.trim&&(t.frame=e.trim,i=t.seconds);const r=this.audibleContext.currentTime;if(r>s){const e=r-s;s=r,i+=e,n-=e}return{duration:n,offset:i,start:s}}compositeAudible(e){return!!this.createSources(e)&&(this.destroySources(e),!0)}compositeVisible(t,i){const s=i.filter((e=>0===e.track));if(this.drawBackground(),s.length>1){const i=s.find((t=>t.type===e.DefinitionType.Transition));if(!i)throw x.mainTrackOverlap;const n=s.filter((t=>t.type!==e.DefinitionType.Transition));i.mergeClipsIntoContextAtTime(n,this.visibleContext,t,this.quantize,this.backcolor)}else{const[e]=s;e&&e.mergeContextAtTime(t,this.quantize,this.visibleContext)}i.filter((e=>!s.includes(e))).sort(me).forEach((e=>{e.mergeContextAtTime(t,this.quantize,this.visibleContext)}))}compositeVisibleRequest(e,t){ee.populatedArray(t)?requestAnimationFrame((()=>this.compositeVisible(e,t))):this.drawBackground()}createSources(e){return e.filter((e=>!this.sourcesByClip.has(e))).every((e=>{const{definition:t}=e,i=t.loadedAudible();if(!i)return!1;const s=this.clipTiming(e),{start:n,duration:r,offset:o}=s;if(ee.positive(n)&&ee.aboveZero(r)){const t=this.audibleContext.createBufferSource();t.buffer=i,t.loop=e.definition.loops;const s=this.audibleContext.createGain();t.connect(s),s.connect(this.audibleContext.destination),t.start(n,o,r),this.sourcesByClip.set(e,{gainSource:t,gainNode:s}),this.adjustSourceGain(e)}return!0}))}destroySources(e=[]){this.sourcesByClip.forEach(((t,i)=>{if(e.includes(i))return;const{gainSource:s,gainNode:n}=t;n.disconnect(this.audibleContext.destination),s.disconnect(n),this.sourcesByClip.delete(i)}))}drawBackground(){this.visibleContext.clear(),this.backcolor&&this.visibleContext.drawFill(de.color(this.backcolor))}get gain(){return this._gain}set gain(e){if(this._gain!==e){if(this._gain=e,!this.playing)return;[...this.sourcesByClip.keys()].forEach((e=>this.adjustSourceGain(e)))}}get seconds(){if(!this.audibleContext)throw x.internal+"audibleContext";return this.audibleContext.currentTime-this.contextSeconds+this.mashSeconds}startContext(){if(this.bufferSource)throw x.internal+"bufferSource";if(this.playing)throw x.internal+"playing";this.bufferSource=this.audibleContext.createBufferSource(),this.bufferSource.loop=!0,this.bufferSource.buffer=this.audibleContext.createBuffer(this.buffer),this.bufferSource.connect(this.audibleContext.destination),this.bufferSource.start(0)}startPlaying(e,t){if(!this.bufferSource)throw x.internal+"bufferSource";if(this.playing)throw x.internal+"playing";const{seconds:i}=e;return this.playing=!0,this.mashSeconds=i,this.contextSeconds=this.audibleContext.currentTime,!!this.createSources(t)||(this.stopPlaying(),!1)}stopPlaying(){this.playing&&(this.playing=!1,this.bufferSource&&this.bufferSource.stop(),this.destroySources(),this.mashSeconds=0,this.contextSeconds=0,this.bufferSource&&(this.bufferSource.disconnect(this.audibleContext.destination),delete this.bufferSource))}get visibleContext(){return this._visibleContext}set visibleContext(e){this._visibleContext=e}}class cs extends Ne{constructor(...t){super(...t),this.audio=[],this._backcolor=V.mash.backcolor,this._buffer=V.buffer,this._gain=V.volume,this.loop=!1,this._paused=!0,this._playing=!1,this.quantize=V.mash.quantize,this.video=[];const i=t[0]||{},{audio:s,backcolor:n,events:r,label:a,loop:c,media:h,quantize:l,video:d,audibleContext:u,buffer:m,gain:f,visibleContext:p}=i;this._events=r,"boolean"==typeof c&&(this.loop=c),l&&ee.aboveZero(l)&&(this.quantize=l),a&&ee.populatedString(a)&&(this.label=a),n&&ee.populatedString(n)&&(this._backcolor=n),h&&h.forEach((e=>{const{id:t,type:i}=e;if(!i||!ee.populatedString(i))throw x.type;const s=i;if(!o.includes(s))throw x.type+s;if(!t||!ee.populatedString(t))throw x.invalid.definition.id+JSON.stringify(e);return We[s].definition(e)})),s?this.audio.push(...s.map((e=>new os(e)))):this.audio.push(new os({type:e.TrackType.Audio})),d?this.video.push(...d.map((e=>new os(e)))):this.video.push(new os({type:e.TrackType.Video})),m&&ee.aboveZero(m)&&(this.buffer=m),void 0!==f&&ee.positive(f)&&(this._gain=f),u&&(this._audibleContext=u),p&&(this._visibleContext=p)}addClipsToTrack(e,t=0,i=0){const[s]=e;e.filter((e=>!ee.positive(e.frames))).forEach((e=>{const t=e.definition.duration;e.frames=se.fromSeconds(t).scale(this.quantize,"floor").frame}));const n=this.clipTrackAtIndex(s,t);if(!n)throw x.invalid.track;const r=ee.positive(s.track)&&this.clipTrack(s);this.emitIfFramesChange((()=>{r&&r!==n&&r.removeClips(e),n.addClips(e,i)}))}addTrack(e){const t=this[e],i={type:e,index:t.length},s=new os(i);return t.push(s),s}get audibleContext(){return this._audibleContext||(this._audibleContext=Ze.audible(),this._composition&&(this.composition.audibleContext=this._audibleContext)),this._audibleContext}set audibleContext(e){this._audibleContext!==e&&(this._audibleContext=e,this._composition&&(this.composition.audibleContext=e))}get backcolor(){return this._backcolor}set backcolor(e){this._backcolor=e,this._composition&&(this.composition.backcolor=e)}get buffer(){return this._buffer}set buffer(e){if(!ee.aboveZero(e))throw x.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this._composition&&(this.composition.buffer=e))}get bufferFrames(){return this.buffer*this.quantize}get bufferTime(){return se.fromSeconds(this.buffer)}changeClipFrames(e,t){let i=Math.max(1,t);const s=e.maxFrames(this.quantize);ee.aboveZero(s)&&(i=Math.min(s,i));const n=this.clipTrack(e);this.emitIfFramesChange((()=>{e.frames=i,n.sortClips(n.clips)}))}changeClipTrimAndFrames(e,t,i){let s=Math.max(0,t);const n=e.maxFrames(this.quantize,1);ee.aboveZero(n)&&(s=Math.min(n,s));const r=i-s,o=this.clipTrack(e);this.emitIfFramesChange((()=>{e.trim=s,e.frames=r,o.sortClips(o.clips)}))}clipIntersects(e,t){return e.timeRange(this.quantize).intersects(t)}clipTrack(e){return this.clipTrackAtIndex(e,e.track)}clipTrackAtIndex(e,t=0){return this.trackOfTypeAtIndex(e.trackType,t)}clips(e,t){const i=this.clipsVisible(e,t);return t&&i.push(...this.clipsAudible(e,t)),[...new Set(i)]}get clipsInTracks(){return this.tracks.map((e=>e.clips)).flat()}clipsAudible(e,t){const i=t&&ne.fromTimes(e,t);return this.clipsAudibleInTracks.filter((t=>{const s=t.timeRange(this.quantize);return i?s.intersects(i):s.intersectsTime(e)}))}get clipsAudibleInTracks(){return this.clipsInTracks.filter((e=>e.audible&&!e.muted))}clipsAudibleInTimeRange(e){const t=e.scale(this.quantize);return this.clipsAudibleInTracks.filter((e=>this.clipIntersects(e,t)))}get clipsVideo(){return this.video.flatMap((e=>e.clips))}clipsVisible(e,t){const i=t&&ne.fromTimes(e,t);return this.clipsVideo.filter((t=>{const s=t.timeRange(this.quantize);return i?s.intersects(i):s.intersectsTime(e)}))}clipsVisibleAtTime(e){return this.clipsVisibleInTimeRange(ne.fromTime(e))}clipsVisibleInTimeRange(e){const t=e.scale(this.quantize);return this.clipsVideo.filter((e=>this.clipIntersects(e,t)))}compositeAudible(){const e=this.clipsAudibleInTimeRange(this.timeRangeToBuffer);return this.composition.compositeAudible(e)}get composition(){if(!this._composition){const e={audibleContext:this.audibleContext,backcolor:this.backcolor,buffer:this.buffer,gain:this.gain,quantize:this.quantize,visibleContext:this.visibleContext,events:this.events};this._composition=new as(e)}return this._composition}compositeVisible(){const{time:e}=this;this.composition.compositeVisible(e,this.clipsVisibleAtTime(e))}compositeVisibleRequest(){const{time:e}=this;this.composition.compositeVisibleRequest(e,this.clipsVisibleAtTime(e))}destroy(){delete this._events,delete this._visibleContext,delete this._audibleContext,delete this._composition}drawAtInterval(){if(!this._playing)return;const e=this.time.withFrame(this.time.frame+1),t=this.playing?this.composition.seconds:e.seconds;t<this.endTime.seconds?t>=e.seconds&&this.drawTime(e):this.loop?this.seekToTime(this.time.withFrame(0)):this.paused=!0}drawTime(e){delete this.seekTime,this.drawnTime=e,this.compositeVisibleRequest()}get duration(){return se.fromArgs(this.frames,this.quantize).seconds}emitDuration(){const t={value:se.fromArgs(this.frames,this.quantize).seconds};this.events?.emit(e.EventType.Duration,t)}emitIfFramesChange(e){const t=this.events?this.frames:null;e(),this.events&&t!==this.frames&&this.emitDuration()}get endTime(){return se.fromArgs(this.frames,this.quantize)}get events(){if(this._events||(this.events=new j),!this._events)throw x.internal;return this._events}set events(e){if(this._events!==e){if(!e)throw x.argument+"events";this._events&&this._events.removeListener(this.handleEvent.bind(this)),this._events=e,this._events.addListener(this.handleEvent.bind(this))}}get frame(){return this.time.scale(this.quantize,"floor").frame}get frames(){return Math.max(0,...this.tracks.map((e=>e.frames)))}get gain(){return this._gain}set gain(e){if(!ee.positive(e))throw x.invalid.argument+"gain "+e;this._gain!==e&&(this._gain=e,this.composition.gain=e)}handleEvent(t){if(t.type!==j.type)return;const{detail:i}=t;if(!i)throw x.internal;const{type:s,action:n}=i;if(s){switch(s){case e.EventType.Duration:return void(this.frame>this.frames&&this.seekToTime(se.fromArgs(this.frames,this.quantize)));case e.EventType.Action:if(n&&n instanceof C){const e=n,{property:t}=e;if("gain"===t)return void(this.playing&&ee.aboveZero(this.gain)&&this.composition.adjustSourceGain(e.target))}}this.stopAndLoad()}}get startAndEnd(){const{time:e}=this,t=[e];return this.paused||t.push(e.add(this.bufferTime)),t}load(){const[e,t]=this.startAndEnd,i=this.clips(e,t).map((i=>i.load(this.quantize,e,t)));return Promise.all(i).then()}loadAndComposite(){this.load().then((()=>{this.compositeVisibleRequest()}))}get loadedDefinitions(){const e=new Map,[t,i]=this.startAndEnd;return this.clips(t,i).forEach((s=>{const{definitions:n}=s,r=[s.definitionTime(this.quantize,t)];i&&r.push(s.definitionTime(this.quantize,i)),n.forEach((t=>{e.has(t)||e.set(t,[]);const i=e.get(t);if(!i)throw x.internal;i.push(r)}))})),e}get media(){return[...new Set(this.clipsInTracks.flatMap((e=>e.definitions)))]}get paused(){return this._paused}set paused(e){const t=e||!this.frames;this._paused!==t&&(this._paused=t,t?(this.playing=!1,this.__bufferTimer&&(clearInterval(this.__bufferTimer),delete this.__bufferTimer)):(this.composition.startContext(),this.__bufferTimer||(this.__bufferTimer=setInterval((()=>{this.load()}),Math.round(this.buffer/2))),this.load().then((()=>{this.playing=!0}))))}get playing(){return this._playing}set playing(e){if(this._playing!==e){if(e){const e=this.clipsAudibleInTimeRange(this.timeRangeToBuffer);if(!this.composition.startPlaying(this.time,e))return;this._drawAtInterval=setInterval((()=>{this.drawAtInterval()}),500/this.time.fps)}else this.composition.stopPlaying(),this._drawAtInterval&&(clearInterval(this._drawAtInterval),delete this._drawAtInterval);this._playing=e}}removeClipsFromTrack(e){const[t]=e,i=this.clipTrack(t);this.emitIfFramesChange((()=>{i.removeClips(e)}))}removeTrack(e){const t=this[e];this.emitIfFramesChange((()=>{t.pop()}))}async seekToTime(e){if(this.seekTime!==e)return this.seekTime=e,this.stopAndLoad()}get stalled(){return!this.paused&&!this.playing}async stopAndLoad(){const{time:e}=this,t=this.paused;this.playing&&(this.playing=!1),await this.load(),e===this.time&&(this.drawTime(e),t||(this.composition.startContext(),this.playing=!0))}get time(){return this.seekTime||this.drawnTime||se.fromArgs(0,this.quantize)}get timeRangeToBuffer(){const{time:e,quantize:t,buffer:i,paused:s}=this;if(s){return ne.fromArgs(e.scale(t,"floor").frame,t,1)}return ne.fromTimes(e,se.fromSeconds(i+e.seconds,e.fps))}toJSON(){return{label:this.label,quantize:this.quantize,backcolor:this.backcolor||"",id:this.id,media:this.media,audio:this.audio,video:this.video}}trackOfTypeAtIndex(e,t=0){if(!ee.positive(t))throw console.error(x.invalid.track,t,t?.constructor.name),x.invalid.track;return this[e][t]}get tracks(){return Object.values(e.TrackType).map((e=>this[e])).flat()}get visibleContext(){return this._visibleContext||(this._visibleContext=Ze.visible(),this._composition&&(this.composition.visibleContext=this._visibleContext)),this._visibleContext}set visibleContext(e){this._visibleContext!==e&&(this._visibleContext=e,this._composition&&(this.composition.visibleContext=e))}}class hs extends nt{constructor(...t){super(...t),this.type=e.DefinitionType.Mash,this.properties.push(new st({name:"backcolor",type:e.DataType.Rgba,value:"#00000000"})),Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new cs({...this.instanceObject,...e})}}const ls=e=>{const{id:t}=e;if(!t)throw x.id+JSON.stringify(e);return Ve.installed(t)?Ve.fromId(t):new hs(e)},ds=e=>ls({id:e}),us=e=>ls(e).instanceFromObject(e),ms=e=>us({id:e}),fs=()=>{},ps=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),ls(e)},gs={define:ps,definition:ls,definitionFromId:ds,fromId:ms,initialize:fs,instance:us};Ge.mash=gs;const vs=Zi(Gi(ot(Re(Ne))));class ys extends vs{contextAtTimeToSize(e,t,i){const s=Ze.toSize(i),n=this.timeRangeRelative(e,t);return this.definition.drawFilters(this,n,s,i)}}const bs=Hi(lt(oi(nt)));class ws extends bs{constructor(...t){super(...t),this.type=e.DefinitionType.Theme,Ve.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){const t={...this.instanceObject,...e};return new ys(t)}}const xs={"com.moviemasher.theme.color":{label:"Color",type:"theme",id:"com.moviemasher.theme.color",properties:{color:{type:"rgb",value:"#FFFF00"}},filters:[{id:"color"}]},"com.moviemasher.theme.text":{label:"Title",type:"theme",id:"com.moviemasher.theme.text",properties:{string:{type:"string",value:"Title"},size:{type:"fontsize",value:.3},x:{type:"number",value:0},y:{type:"number",value:0},color:{type:"rgba",value:"rgba(255,0,0,1)"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},background:{type:"hex",value:"#ffffff"},fontface:{type:"font",value:"com.moviemasher.font.default"}},filters:[{id:"color",parameters:[{name:"color",value:"background"},{name:"size",value:"mm_dimensions"},{name:"duration",value:"mm_duration"},{name:"rate",value:"mm_fps"}]},{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]}},Ts=t=>{const{id:i}=t;if(!i||!ee.populatedString(i))throw x.id;if(!Ve.installed(i)){const s={};xs[i]&&Object.assign(s,xs[i]),Object.assign(s,t),Object.assign(s,{type:e.DefinitionType.Theme,id:i}),new ws(s)}return Ve.fromId(i)},_s=e=>Ts({id:e}),Cs=e=>Ts(e).instanceFromObject(e),Fs=e=>Cs({id:e}),Ss=()=>{},As=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),Ts(e)},Is={define:As,definition:Ts,definitionFromId:_s,fromId:Fs,initialize:Ss,instance:Cs};Ge.theme=Is;const ks=Gi(ot(Re(Ne)));class Os extends ks{constructor(){super(...arguments),this.trackType=e.TrackType.Video}contextAtTimeToSize(e,t,i){}mergeClipsIntoContextAtTime(e,t,i,s,n){ee.aboveZero(e.length)&&this.definition.drawVisibleFilters(e,this,i,s,t,n)}}const zs=Hi(lt(oi(nt)));class Es extends zs{constructor(...t){super(...t),this.fromFilters=[],this.toFilters=[],this.type=e.DefinitionType.Transition;const[i]=t,{to:s,from:n}=i;if(s){const{filters:e}=s;e&&this.toFilters.push(...e.map((e=>ti(e))))}if(n){const{filters:e}=n;e&&this.fromFilters.push(...e.map((e=>ti(e))))}Ve.install(this)}drawVisibleFilters(e,t,i,s,n,r){const{size:o}=n,a=[...e].sort(ue),[c,h]=a,l=ne.fromTime(i),d=c.timeRange(i.fps);if(r&&n.drawFill(r),d.intersects(l)&&(c.mergeContextAtTime(i,s,n),this.filters=this.fromFilters,this.drawFilters(t,l,n,o)),!h)return;if(!h.timeRangeRelative(i,s).intersects(l))return;const u=Ze.toSize(o);r&&u.drawFill(r),h.mergeContextAtTime(i,s,u),this.filters=this.toFilters,this.drawFilters(t,l,u,o),n.draw(u.imageSource)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Os({...this.instanceObject,...e})}toJSON(){return{...super.toJSON(),to:{filters:this.toFilters},from:{filters:this.fromFilters}}}}var Ds={label:"Crossfade",type:"transition",id:"com.moviemasher.transition.crossfade",to:{filters:[{id:"fade",parameters:[{name:"alpha",value:"1"},{name:"type",value:"in"},{name:"duration",value:"mm_duration"}]}]}};const Ms=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.installed(t)?Ve.fromId(t):new Es(e)},js=e=>Ms({id:e}),Vs=e=>Ms(e).instanceFromObject(e),Ns=e=>Vs({id:e}),Rs=()=>{Ms(Ds)},Ps=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),Ms(e)},qs={define:Ps,definition:Ms,definitionFromId:js,fromId:Ns,initialize:Rs,instance:Vs};Ge.transition=qs;const Bs=Zi(Gi(rt(ot(Ne))));class $s extends Bs{constructor(...e){super(...e),this.speed=V.clip.video.speed;const[t]=e,{speed:i}=t;i&&ee.aboveZero(i)&&(this.speed=i)}get copy(){return super.copy}definitionTime(e,t){const i=super.definitionTime(e,t);return this.speed===V.clip.video.speed?i:i.divide(this.speed)}toJSON(){const e=super.toJSON();return this.speed!==V.clip.video.speed&&(e.speed=this.speed),e}}const Js=Hi(Ft(lt(nt)));class Ls extends Js{constructor(...t){super(...t),this.begin=V.media.video.begin,this.fps=V.media.video.fps,this.increment=V.media.video.increment,this.pattern="%.jpg",this.source="",this.trackType=e.TrackType.Video,this.type=e.DefinitionType.Video;const[i]=t,{url:s,begin:n,fps:r,increment:o,pattern:a,video_rate:c,source:h}=i;if(!s)throw x.invalid.definition.url;this.url=s,h&&(this.source=h),void 0!==n&&(this.begin=n),(r||c)&&(this.fps=Number(r||c)),o&&(this.increment=o),a&&(this.pattern=a),this.properties.push(new st({name:"speed",type:e.DataType.Number,value:1})),Ve.install(this)}frames(e,t){const i=[],s=Math.min(this.framesMax,e.scale(this.fps,"floor").frame);if(t){const e=Math.min(this.framesMax,t.scale(this.fps,"ceil").frame);for(let t=s;t<=e;t+=1)i.push(t)}else i.push(s);return i}get framesMax(){return Math.floor(this.fps*this.duration)-2}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new $s({...this.instanceObject,...e})}load(e,t){const i=[super.load(e,t)];return this.frames(e,t).forEach((e=>{const t=this.urlForFrame(e);if(dt.cached(t)){const e=dt.get(t);e instanceof Promise&&i.push(e)}else i.push(Ct.image().loadUrl(t))})),Promise.all(i).then()}loaded(e,t){return!!super.loaded(e,t)&&this.frames(e,t).every((e=>dt.cached(this.urlForFrame(e))))}loadedVisible(e){if(!e)throw x.internal;const[t]=this.urls(e);return dt.get(t)}toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),this.pattern!==V.media.video.pattern&&(e.pattern=this.pattern),this.increment!==V.media.video.increment&&(e.increment=this.increment),this.begin!==V.media.video.begin&&(e.begin=this.begin),this.fps!==V.media.video.fps&&(e.fps=this.fps),e}unload(e){const t=se.fromArgs(0,this.fps),i=this.urls(t,t.withFrame(this.framesMax)),s=new Set(i.filter((e=>dt.cached(e))));e&&e.forEach((e=>{const[t,i]=e;this.frames(t,i).map((e=>this.urlForFrame(e))).filter((e=>s.has(e))).forEach((e=>{s.delete(e)}))})),s.forEach((e=>{dt.remove(e)}))}urlForFrame(e){let t=String(e*this.increment+this.begin);return this.zeropadding&&(t=t.padStart(this.zeropadding,"0")),(this.url+this.pattern).replaceAll("%",t)}urls(e,t){return this.frames(e,t).map((e=>this.urlForFrame(e)))}get zeropadding(){if(!this.__zeropadding){const e=this.begin+(this.increment*this.framesMax-this.begin);this.__zeropadding=String(e).length}return this.__zeropadding}}const Us=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.installed(t)?Ve.fromId(t):new Ls(e)},Zs=e=>Us({id:e}),Gs=e=>Us(e).instanceFromObject(e),Ks=e=>Gs({id:e}),Ws=()=>{},Hs=e=>{const{id:t}=e;if(!t||!ee.populatedString(t))throw x.id;return Ve.uninstall(t),Us(e)},Xs={define:Hs,definition:Us,definitionFromId:Zs,fromId:Ks,initialize:Ws,instance:Gs};Ge.video=Xs;const Ys=["masher"],Qs=Object.fromEntries(Ys.map((e=>[e,e]))),en=Xe;const tn=new class{constructor(){this.mashers=[]}create(e={}){const t=new en(e);return this.addMasher(t),t}addMasher(e){this.mashers.length||this.start(),this.mashers.push(e)}destroy(e){const t=this.mashers.indexOf(e);t<0||(this.mashers.splice(t,1),this.mashers.length||this.stop())}handleInterval(){const e=new Map,t=new Set;this.mashers.forEach((i=>{i.definitions.forEach((e=>{t.add(e)}));i.loadedDefinitions.forEach(((t,i)=>{e.has(i)||e.set(i,[]);const s=e.get(i);if(!s)throw x.internal;s.push(...t)}))})),e.forEach(((e,t)=>{t.unload(e)})),Ve.map.forEach((i=>{t.has(i)?e.has(i)?i.unload(e.get(i)):i.unload():(i.unload(),i.retain||Ve.uninstall(i.id))}))}start(){this.interval||(this.interval=setInterval(this.handleInterval.bind(this),1e4))}stop(){this.interval&&(clearInterval(this.interval),delete this.interval)}get type(){return Qs}get types(){return Ys}};zi(),Li(),Zt(),Rs(),e.Action=T,e.Actions=M,e.AddClipToTrackAction=k,e.AddEffectAction=I,e.AddTrackAction=_,e.AudibleContext=Be,e.AudioClass=ct,e.AudioDefinitionClass=At,e.AudioFactoryImplementation=Mt,e.AudioLoader=bt,e.AudioProcessor=mt,e.Cache=dt,e.Capitalize=Te,e.ChangeAction=C,e.ChangeFramesAction=S,e.ChangeTrimAction=A,e.ClipTypes=n,e.Color=ce,e.ContextFactory=Ze,e.DataTypes=f,e.Default=V,e.DefinitionClass=nt,e.DefinitionTypes=o,e.Definitions=Ve,e.EffectClass=qe,e.EffectDefinitionClass=ci,e.EffectFactoryImplementation=gi,e.Errors=x,e.Evaluator=xe,e.Events=j,e.Factories=Ge,e.Factory=We,e.FilterClass=jt,e.FilterDefinitionClass=Vt,e.FilterFactoryImplementation=ri,e.FontClass=Pt,e.FontDefinitionClass=qt,e.FontFactoryImplementation=Kt,e.FontLoader=wt,e.FontProcessor=ft,e.FreezeAction=F,e.ImageClass=Wi,e.ImageDefinitionClass=Yi,e.ImageFactoryImplementation=rs,e.ImageLoader=xt,e.Is=ee,e.Loader=gt,e.MashClass=cs,e.MashDefinitionClass=hs,e.MashFactoryImplementation=gs,e.MashTypes=c,e.MasherClass=Xe,e.MasherFactory=tn,e.MergerClass=yi,e.MergerDefinitionClass=wi,e.MergerFactoryImplementation=Di,e.ModuleLoader=Tt,e.ModuleProcessor=pt,e.ModuleTypes=l,e.MoveClipsAction=O,e.MoveEffectsAction=D,e.Parameter=Ye,e.Pixel=de,e.Processor=ut,e.Property=st,e.RemoveClipsAction=z,e.Sort=pe,e.SplitAction=E,e.ThemeClass=ys,e.ThemeDefinitionClass=ws,e.ThemeFactoryImplementation=Is,e.Time=se,e.TimeRange=ne,e.TrackClass=os,e.TransformTypes=g,e.TransitionClass=Os,e.TransitionDefinitionClass=Es,e.TransitionFactoryImplementation=qs,e.Type=tt,e.TypeValue=et,e.Types=it,e.VideoClass=$s,e.VideoDefinitionClass=Ls,e.VideoFactoryImplementation=Xs,e.VisibleContext=Je,e.audioDefine=Dt,e.audioDefinition=It,e.audioDefinitionFromId=kt,e.audioFromId=zt,e.audioInitialize=Et,e.audioInstance=Ot,e.byFrame=ue,e.byLabel=fe,e.byTrack=me,e.definitionsByType=Ae,e.definitionsClear=Ie,e.definitionsFont=ke,e.definitionsFromId=Oe,e.definitionsInstall=ze,e.definitionsInstalled=Ee,e.definitionsMap=Fe,e.definitionsMerger=De,e.definitionsScaler=Me,e.definitionsUninstall=je,e.effectDefine=pi,e.effectDefinition=li,e.effectDefinitionFromId=di,e.effectFromId=mi,e.effectInitialize=fi,e.effectInstance=ui,e.filterDefine=ni,e.filterDefinition=Qt,e.filterDefinitionFromId=ei,e.filterFromId=ii,e.filterInitialize=si,e.filterInstance=ti,e.fontDefine=Gt,e.fontDefinition=$t,e.fontDefinitionFromId=Jt,e.fontFromId=Ut,e.fontInitialize=Zt,e.fontInstance=Lt,e.imageDefine=ns,e.imageDefinition=Qi,e.imageDefinitionFromId=es,e.imageFromId=is,e.imageInitialize=ss,e.imageInstance=ts,e.isAboveZero=K,e.isArray=W,e.isBoolean=B,e.isDefined=J,e.isFloat=Z,e.isInteger=U,e.isMethod=$,e.isNan=L,e.isNumber=q,e.isObject=N,e.isPopulatedArray=Q,e.isPopulatedObject=Y,e.isPopulatedString=X,e.isPositive=G,e.isString=R,e.isUndefined=P,e.mashDefine=ps,e.mashDefinition=ls,e.mashDefinitionFromId=ds,e.mashFromId=ms,e.mashInitialize=fs,e.mashInstance=us,e.mergerDefaultId=Si,e.mergerDefine=Ei,e.mergerDefinition=Ai,e.mergerDefinitionFromId=Ii,e.mergerFromId=Oi,e.mergerInitialize=zi,e.mergerInstance=ki,e.roundWithMethod=ie,e.scaleTimes=te,e.themeDefine=As,e.themeDefinition=Ts,e.themeDefinitionFromId=_s,e.themeFromId=Fs,e.themeInitialize=Ss,e.themeInstance=Cs,e.transitionDefine=Ps,e.transitionDefinition=Ms,e.transitionDefinitionFromId=js,e.transitionFromId=Ns,e.transitionInitialize=Rs,e.transitionInstance=Vs,e.videoDefine=Hs,e.videoDefinition=Us,e.videoDefinitionFromId=Zs,e.videoFromId=Ks,e.videoInitialize=Ws,e.videoInstance=Gs}));
//# sourceMappingURL=moviemasher.min.js.map
