!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MovieMasher={})}(this,(function(e){"use strict";const t=e=>Math.min(255,Math.max(0,Math.floor(Number(e)))),i=e=>({r:t(e.r),g:t(e.g),b:t(e.b)}),s=e=>({y:t(e.y),u:t(e.u),v:t(e.v)}),n=e=>{const t=s(e);return i({r:t.y+1.4075*(t.v-128),g:t.y-.3455*(t.u-128)-.7169*(t.v-128),b:t.y+1.779*(t.u-128)})},r=e=>{let t=e.r.toString(16),i=e.g.toString(16),s=e.b.toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),s.length<2&&(s=`0${s}`),`#${t}${i}${s}`},o=(e,t,i,n)=>{let r=0;const o=s(t);return e.forEach((e=>{const t=s(e),i=t.u-o.u,n=t.v-o.v;r+=Math.sqrt((i*i+n*n)/65025)})),r/=e.length,n>1e-4?255*Math.min(1,Math.max(0,(r-i)/n)):r>i?255:0},a=e=>{const t=i(e);return{y:.299*t.r+.587*t.g+.114*t.b,u:-.168736*t.r+-.331264*t.g+.5*t.b+128,v:.5*t.r+-.418688*t.g+-.081312*t.b+128}},c=e=>e.toLowerCase().replaceAll(/[\s]/g,""),l=e=>{const t=c(e),i=(new Option).style;i.color=e;const s=c(i.color);return!!s&&(!!s.startsWith("rgb")||s===t)},h="#00000000",d={valid:l,yuvBlend:o,rgb2yuv:a,yuv2rgb:n,rgb2hex:r,transparent:h,strip:c},u={label:"Unlabeled",masher:{buffer:10,fps:0,loop:!0,volume:.75,precision:3,autoplay:!1},mash:{label:"Unlabeled Mash",quantize:10,backcolor:h,gain:.75,buffer:10,output:{size:"320x240"}},instance:{audio:{gain:1,trim:0,loop:1},video:{speed:1}},definition:{frame:{duration:2},image:{duration:2},theme:{duration:3},transition:{duration:1},video:{fps:0},videosequence:{pattern:"%.jpg",fps:10,increment:1,begin:1,padding:0},videostream:{duration:10}}},m="Invalid argument",f="Invalid property",p="Internal Error ",g={eval:{sourceRect:"Invalid evaluation of source rect ",outputSize:"Invalid evaluation of output size ",conditionTruth:"Expected at least one condition to evaluate to true ",conditionValue:"Expected condition to have a value ",number:"Expected evaluated value to be a number ",get:"Expected to get evaluated value "},composition:{mashUndefined:`${p}composition.mash undefined`},audibleContext:"Expected AudioContext",mash:"Expected mash",action:"Expected Action",actions:"Expected Actions",internal:p,argument:"Invalid argument ",invalid:{canvas:"Invalid argument canvas ",definition:{duration:"Invalid definition property duration",audio:"Invalid definition property audio|url",url:"Invalid definition property url",source:"Invalid definition property source",id:"Invalid definition property id",object:"Invalid property definition"},size:"Invalid size ",track:"Invalid track ",trackType:"Invalid property trackType ",action:"Invalid action ",name:"Invalid property name ",value:"Invalid property value ",type:"Invalid property type ",url:"Invalid property url ",property:f,argument:m,object:"Invalid argument object ",factory:"Invalid factory ",volume:"Invalid argument volume"},type:"Unknown type ",selection:"Invalid selection ",unknown:{type:"Unknown type ",merger:"Unknown merger ",effect:"Unknown effect ",filter:"Unknown filter ",font:"Unknown font ",scaler:"Unknown scalar ",mode:"Unknown mode ",definition:"Unknown definition "},uncached:"Uncached URL ",object:"Invalid argument object ",array:"Invalid argument array ",media:"Invalid argument media ",id:"Invalid argument id ",frame:"Invalid argument frame ",frames:"Invalid property frames ",fps:"Invalid argument fps ",seconds:"Invalid argument seconds ",url:"Invalid argument url ",time:"Invalid argument Time",timeRange:"Invalid argument TimeRange",mainTrackOverlap:`${p}: main track clips overlap without transition`,unknownMash:"Unknown Mash property ",unimplemented:"Expected method to be overridden",property:"Invalid argument property ",wrongClass:"Expected instance of "};class y{constructor({name:e,value:t}){if(!e)throw g.invalid.name;if(void 0===t)throw g.invalid.value;this.name=String(e),this.value=t}toJSON(){return{name:this.name,value:this.value}}}const v=e=>"object"==typeof e,b=e=>"string"==typeof e,w=e=>void 0===e,T=e=>"number"==typeof e,x=e=>"boolean"==typeof e,C=e=>"function"==typeof e,S=e=>!w(e),F=e=>T(e)&&Number.isNaN(e),_=e=>Number.isInteger(e),I=e=>T(e)&&!_(e),A=e=>T(e)&&Number(e)>=0,D=e=>(e=>T(e)&&!Number.isNaN(e))(e)&&Number(e)>0,k=e=>S(Array.isArray)?Array.isArray(e):e instanceof Array,O=e=>!!e.length,M=e=>b(e)&&O(String(e)),E=e=>v(e)&&O(Object.keys(e)),z=e=>k(e)&&O(e),V={aboveZero:D,array:k,boolean:x,defined:S,float:I,integer:_,method:C,nan:F,number:T,object:v,populatedArray:z,populatedObject:E,populatedString:M,positive:A,string:b,undefined:w};var j,N,P,R={boolean:{value:!1},direction4:{values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"}],value:0},direction8:{values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"},{id:4,identifier:"top_right",label:"Top Right"},{id:5,identifier:"bottom_right",label:"Bottom Right"},{id:6,identifier:"bottom_left",label:"Bottom Left"},{id:7,identifier:"top_left",label:"Top Left"}],value:0},font:{value:"com.moviemasher.font.default",modular:!0},fontsize:{value:13},integer:{value:0},mode:{value:"normal",values:[{id:"burn",identifier:"color-burn",label:"Color Burn"},{id:"dodge",identifier:"color-dodge",label:"Color Dodge"},{id:"darken",identifier:"darken",label:"Darken"},{id:"difference",identifier:"difference",label:"Difference"},{id:"exclusion",identifier:"exclusion",label:"Exclusion"},{id:"hardlight",identifier:"hard-light",label:"Hard Light"},{id:"lighten",identifier:"lighter",label:"Lighten"},{id:"multiply",identifier:"multiply",label:"Multiply"},{id:"normal",identifier:"normal",label:"Normal"},{id:"overlay",identifier:"overlay",label:"Overlay"},{id:"screen",identifier:"screen",label:"Screen"},{id:"softlight",identifier:"soft-light",label:"Soft Light"},{id:"xor",identifier:"xor",label:"Xor"}]},number:{value:0},pixel:{value:0},rgb:{value:"rgb(0, 0, 0)"},rgba:{value:"rgba(0, 0, 0, 1)"},string:{value:""},text:{value:""}};e.ActionType=void 0,(j=e.ActionType||(e.ActionType={})).AddTrack="addTrack",j.AddClipsToTrack="addClipsToTrack",j.MoveClips="moveClips",j.AddEffect="addEffect",j.Change="change",j.ChangeFrames="changeFrames",j.ChangeTrim="changeTrim",j.ChangeGain="changeGain",j.MoveEffects="moveEffects",j.Split="split",j.Freeze="freeze",j.RemoveClips="removeClips",e.TrackType=void 0,(N=e.TrackType||(e.TrackType={})).Audio="audio",N.Video="video",e.ClipType=void 0,(P=e.ClipType||(e.ClipType={})).Audio="audio",P.Frame="frame",P.Image="image",P.Theme="theme",P.Transition="transition",P.Video="video",P.VideoSequence="videosequence",P.VideoStream="videostream";const q=Object.values(e.ClipType);var U;e.DefinitionType=void 0,(U=e.DefinitionType||(e.DefinitionType={})).Filter="filter",U.Merger="merger",U.Scaler="scaler",U.Effect="effect",U.Font="font",U.Mash="mash",U.Masher="masher",U.Theme="theme",U.Transition="transition",U.Image="image",U.Video="video",U.Audio="audio",U.VideoStream="videostream",U.VideoSequence="videosequence";const B=Object.values(e.DefinitionType);var J;e.EventType=void 0,(J=e.EventType||(e.EventType={})).Action="action",J.Duration="durationchange",J.Draw="draw",J.Ended="ended",J.Fps="ratechange",J.Loaded="loadeddata",J.Mash="mashchange",J.Pause="pause",J.Play="play",J.Playing="playing",J.Seeked="seeked",J.Seeking="seeking",J.Selection="selection",J.Time="timeupdate",J.Track="track",J.Volume="volumechange",J.Waiting="waiting",e.MashType=void 0,(e.MashType||(e.MashType={})).Mash="mash";const $=Object.values(e.MashType);var L;e.ModuleType=void 0,(L=e.ModuleType||(e.ModuleType={})).Effect="effect",L.Font="font",L.Merger="merger",L.Scaler="scaler",L.Theme="theme",L.Transition="transition";const Z=Object.values(e.ModuleType);var W,K,G;e.LoadType=void 0,(W=e.LoadType||(e.LoadType={})).Audio="audio",W.Font="font",W.Image="image",W.Module="module",W.Video="video",e.MoveType=void 0,(K=e.MoveType||(e.MoveType={})).Audio="audio",K.Effect="effect",K.Video="video",e.DataType=void 0,(G=e.DataType||(e.DataType={})).Boolean="boolean",G.Direction4="direction4",G.Direction8="direction8",G.Font="font",G.Fontsize="fontsize",G.Integer="integer",G.Mode="mode",G.Number="number",G.Pixel="pixel",G.Rgb="rgb",G.Rgba="rgba",G.String="string",G.Text="text";const H=Object.values(e.DataType);var X;e.TransformType=void 0,(X=e.TransformType||(e.TransformType={})).Merger="merger",X.Scaler="scaler";const Y=Object.values(e.TransformType);var Q;e.CommandType=void 0,(Q=e.CommandType||(e.CommandType={})).File="file",Q.Stream="stream";const ee=Object.values(e.CommandType);class te{constructor(e){const{id:t,identifier:i,label:s}=e;this.id=t,this.identifier=i,this.label=s}}const ie=new Map,se=new Map,ne=e=>{const t=se.get(e);if(t)return t;const i=[];return se.set(e,i),i},re=()=>{ie.clear(),se.clear()},oe=ne(e.DefinitionType.Font),ae=e=>{if(!le(e))throw console.trace(e),g.unknown.definition+e;const t=ie.get(e);if(!t)throw g.internal+e;return t},ce=e=>{const{type:t,id:i}=e;ie.set(i,e),ne(t).push(e)},le=e=>ie.has(e),he=ne(e.DefinitionType.Merger),de=ne(e.DefinitionType.Scaler),ue=e=>{if(!le(e))return;const t=ae(e);ie.delete(e);const{type:i}=t,s=ne(i),n=s.indexOf(t);if(n<0)throw g.internal;s.splice(n,1)},me={byType:ne,clear:re,font:oe,fromId:ae,install:ce,installed:le,map:ie,merger:he,scaler:de,uninstall:ue};class fe{constructor(e){this.modular=!1,this.values=[];const{value:t,values:i,modular:s,id:n}=e;if(!n)throw g.id;if(void 0===t)throw g.invalid.value+JSON.stringify(e);this.value=t,this.id=n,s&&(this.modular=s),i&&this.values.push(...i.map((e=>new te(e))))}coerce(t){const i=String(t),s=Number(t);if(!this.modular||me.fromId(i)){switch(this.id){case e.DataType.Boolean:return!!t;case e.DataType.Number:case e.DataType.Fontsize:case e.DataType.Pixel:if(F(s))return;return s;case e.DataType.Integer:if(F(s))return;return Math.round(s);case e.DataType.Rgb:case e.DataType.Rgba:if(!l(i))return;break;case e.DataType.Direction4:case e.DataType.Direction8:case e.DataType.Mode:if(!this.values?.find((e=>{e.id})))return}return i}}}const pe=new class{constructor(e){this.propertyTypes=new Map,Object.entries(e).forEach((e=>{const[t,i]=e,s=t;if(!H.includes(s))throw g.type+"DataTypes "+t;this.propertyTypes.set(s,new fe({...i,id:s}))}))}propertyType(e){const t=this.propertyTypes.get(e);if(!t)throw g.type+"propertyType "+e;return t}propertyTypeDefault(e){if(!V.populatedString(e)||!H.includes(e))throw g.type+"propertyTypeDefault "+e;const t=this.propertyType(e);return V.object(t)?t.value:""}}(R);class ge{constructor(e){const{type:t,name:i,value:s,custom:n}=e;if(!t)throw g.invalid.type;if(!i)throw g.invalid.name;if(void 0===s)throw g.invalid.value+JSON.stringify(e);this.type=pe.propertyType(t),this.name=i,this.value=s,this.custom=!!n}toJSON(){return{value:this.value,type:this.type.id}}}const ye=e=>M(e)?`${e[0].toUpperCase()}${e.substr(1)}`:e,ve=["scrollPaddingleft","scrollPaddingRight","scrollPaddingTop","scrollPaddingBottom"],be=e=>{if(!e)return;const t=getComputedStyle(e),i=ve.map((e=>{const i=t.getPropertyValue(e)||"0px",s=Number(i.slice(0,-2));return[e,isNaN(s)?0:s]})),{scrollLeft:s,scrollTop:n}=e,{x:r,y:o,width:a,height:c}=e.getBoundingClientRect();return i.push(["scrollLeft",s]),i.push(["scrollTop",n]),i.push(["x",r]),i.push(["y",o]),i.push(["width",a]),i.push(["height",c]),Object.fromEntries(i)},we={scrollMetrics:be},Te=["mm_width","mm_height"],xe=["mm_dimensions","mm_duration","mm_fps","mm_height","mm_t","mm_width","t"],Ce=["ceil","floor","mm_cmp","mm_horz","mm_max","mm_min","mm_vert",...xe,...Te],Se="evaluator",Fe=e=>{const{condition:t}=e;if(V.defined(e.is))return`${t}==${e.is}`;const i=e.in;if(V.undefined(i))return String(t);const s=(e=>"string"==typeof e?String(e).split(","):e)(i),n=V.string(s[0]),r=s.map((e=>n?`"${e}"`:e)),o=n?"String":"Number";return`([${r.join(",")}].includes(${o}(${t})))`};class _e{constructor(e,t,i,s){this.ceil=Math.ceil,this.floor=Math.floor,this.map=new Map,this.mm_max=Math.max,this.mm_min=Math.min,this.timeRange=e,this.context=t,this.mergeContext=s,this.size=i,this.setInputSize(this.size)}conditionalValue(e){const t=e.find((e=>{const t=(e=>e.replaceAll(" or "," || ").replaceAll(" and "," && "))(Fe(e));return this.evaluateExpression(t)}));if(void 0===t)throw g.eval.conditionTruth;const{value:i}=t;if(void 0===i)throw g.eval.conditionValue;return i}get duration(){return this.timeRange.lengthSeconds}evaluate(e){if("number"==typeof e)return e;const t="string"==typeof e?String(e):this.conditionalValue(e);if("number"==typeof t)return t;return this.evaluateExpression(t)}evaluateExpression(e){const t=`return ${this.replaceKeys(e)}`;try{const e=new Function(Se,t);return e(this)}catch(t){return e}}get(e){if(this.map.has(e))return this.map.get(e);if(!Ce.includes(e))throw g.eval.get+e;const t=this[e];if(xe.includes(e))return t;if("function"==typeof t)return t.bind(this);throw g.eval.get+e}has(e){return Ce.includes(e)||this.map.has(e)}initialize(e,t){return!this.has(e)&&(this.set(e,t),!0)}get inputSize(){return{width:Number(this.get("mm_input_width")),height:Number(this.get("mm_input_height"))}}get keys(){return[...new Set([...this.map.keys(),...Ce])]}mm_cmp(e,t,i,s){return e>t?i:s}get mm_dimensions(){return`${this.mm_width}x${this.mm_height}`}get mm_duration(){return this.duration}get mm_fps(){return this.timeRange.fps}get mm_height(){return this.size.height}mm_horz(e,t){return this.sized(0,e,t)}get mm_t(){return this.position}mm_vert(e,t){return this.sized(1,e,t)}get mm_width(){return this.size.width}get position(){return this.timeRange.position}replaceKeys(e){let t=e;const i=Object.fromEntries(this.keys.map((e=>[e,new RegExp(`\\b${e}\\b`,"g")])));return Object.entries(i).forEach((([e,i])=>{t=t.replaceAll(i,`evaluator.get("${e}")`)})),t}set(e,t){this.map.set(e,t)}setInputSize({width:e,height:t}){this.set("in_h",t),this.set("mm_input_height",t),this.set("in_w",e),this.set("mm_input_width",e)}sized(e,t,i){const s=V.float(t)?Number(t):parseFloat(String(t));if(V.nan(s))throw g.eval.number+"scale";const n=Te[e],r=this.get(n),o=parseFloat(String(r));if(V.nan(o))throw g.eval.number+`value ${n}=>${r}`;const a=o*s;if(!i)return a;const c=Te[Math.abs(e-1)],l=this.get(c);if(void 0===l)throw g.internal+"otherValue";const h=parseFloat(String(l));if(V.nan(h))throw g.eval.number+"other";return h<=o?a:o+(s-1)*h}get t(){return this.mm_duration}}const Ie=()=>`${Date.now().toString(36)}${Math.random().toString(36).substr(2)}`,Ae=(e="")=>{switch(e){case"ceil":return Math.ceil;case"floor":return Math.floor;default:return Math.round}},De=(e,t="")=>Ae(t)(e),ke={method:Ae,withMethod:De},Oe=(e,t)=>({r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}),Me=(e,t,i)=>{const{x:s,y:n}=t,{width:r,height:o}=i,a=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e,r);return a.x=Math.max(0,Math.min(r-1,a.x+s)),a.y=Math.max(0,Math.min(o-1,a.y+n)),((e,t)=>e.y*t+e.x)(a,r)},Ee=(e,t,i)=>((e,t)=>{const i=[],s=Math.floor(1.5);for(let n=0;n<3;n+=1)for(let r=0;r<3;r+=1){const o={x:r-s,y:n-s};i.push(Me(e,o,t))}return i})(e,i).map((e=>((e,t)=>Oe((e=>4*e)(e),t))(e,t))),ze=e=>{const t=String(e);return"0x"===t.slice(0,2)?`#${t.slice(2)}`:t},Ve=(e,t,i)=>{if(!e||!t)return 0;const s=t/e,n=Math.min(1,s),r=Math.max(1,s);return 1===i?r:i?n+(r-n)*i:n},je=(e,t,i="ceil")=>{if(!e||!t)return 0;return De(e*t,i)},Ne=(e,t,i="round")=>e&&t?De(e/t,i):0,Pe={color:ze,fromFrame:je,neighboringRgbas:Ee,perFrame:Ve,rgbaAtIndex:Oe,toFrame:Ne},Re=(e,t)=>e.frame-t.frame,qe=(e,t)=>e.track-t.track,Ue=(e,t)=>e.label<t.label?-1:e.label>t.label?1:0,Be={byFrame:Re,byLabel:Ue,byTrack:qe},Je=(e,t,i="")=>{if(e.fps===t.fps)return[e,t];const s=(n=e.fps,r=t.fps,n*r/((e,t)=>{let i=e,s=t,n=0;for(;0!==s;)n=s,s=i%s,i=n;return i})(n,r));var n,r;return[e.scale(s,i),t.scale(s,i)]};class $e{constructor(e=0,t=1){if(!V.integer(e)||e<0)throw g.frame;if(!V.integer(t)||t<1)throw g.fps;this.frame=e,this.fps=t}add(e){const[t,i]=Je(this,e);return new $e(t.frame+i.frame,t.fps)}addFrame(e){const t=this.copy;return t.frame+=e,t}get copy(){return new $e(this.frame,this.fps)}get description(){return`${this.frame}@${this.fps}`}divide(e,t=""){if(!V.number(e))throw g.argument+"divide";return new $e(De(Number(this.frame)/e,t),this.fps)}equalsTime(e){const[t,i]=Je(this,e);return t.frame===i.frame}min(e){const[t,i]=Je(this,e);return new $e(Math.min(t.frame,i.frame),t.fps)}scale(e,t=""){if(this.fps===e)return this;const i=Number(this.frame)/Number(this.fps)*Number(e);return new $e(De(i,t),e)}scaleToFps(e){return this.scaleToTime(new $e(0,e))}scaleToTime(e){return Je(this,e)[0]}get seconds(){return Number(this.frame)/Number(this.fps)}subtract(e){const[t,i]=Je(this,e);let s=i.frame;return s>t.frame&&(s-=s-t.frame),new $e(t.frame-s,t.fps)}subtractFrames(e){const t=this.copy;return t.frame-=e,t}toString(){return`[${this.description}]`}withFrame(e){const t=this.copy;return t.frame=e,t}static fromArgs(e=0,t=1){return new $e(e,t)}static fromSeconds(e=0,t=1,i=""){if(!V.number(e)||e<0)throw g.seconds;if(!V.integer(t)||t<1)throw g.fps;const s=De(e*t,i);return this.fromArgs(s,t)}}class Le extends $e{constructor(e=0,t=1,i=1){if(!(V.integer(i)&&i>=0))throw g.argument+"frames";super(e,t),this.frames=i}addFrames(e){const t=this.copy;return t.frames+=e,t}get description(){return`${this.frame}-${this.frames}@${this.fps}`}get end(){return this.frame+this.frames}get endTime(){return $e.fromArgs(this.end,this.fps)}equalsTimeRange(e){const[t,i]=Je(this,e);return t.frame===i.frame&&t.frames===i.frames}get lengthSeconds(){return Number(this.frames)/Number(this.fps)}get position(){return Number(this.frame)/Number(this.frames)}get startTime(){return $e.fromArgs(this.frame,this.fps)}get copy(){return new Le(this.frame,this.fps,this.frames)}scale(e=1,t=""){if(this.fps===e)return this.copy;const i=Number(this.frames)/(Number(this.fps)/Number(e)),s=super.scale(e,t),n=Math.max(1,De(i,t));return new Le(s.frame,s.fps,n)}intersects(e){const[t,i]=Je(this,e);return!(t.frame>=i.end)&&t.end>i.frame}intersectsTime(e){const[t,i]=Je(this,e),s=t;return i.frame>=s.frame&&i.frame<s.end}minEndTime(e){const[t,i]=Je(this,e);return t.frames=Math.min(t.frames,i.frame),t}get times(){const{frames:e,frame:t,fps:i}=this;return Array.from({length:e+1},((e,s)=>$e.fromArgs(t+s,i)))}withFrame(e){const t=this.copy;return t.frame=e,t}withFrames(e){const t=this.copy;return t.frames=e,t}static fromArgs(e=0,t=1,i=1){return new Le(e,t,i)}static fromSeconds(e=0,t=1){return this.fromArgs(e,1,t)}static fromTime(e,t=1){return this.fromArgs(e.frame,e.fps,t)}static fromTimes(e,t){const[i,s]=Je(e,t);if(s.frame<=i.frame)throw g.argument;const n=s.frame-i.frame;return this.fromArgs(i.frame,i.fps,n)}}class Ze{constructor(e=0,t=-1,i){this.last=-1,this.first=0,this.first=e,this.last=t,this.type=i}get count(){return 1+this.last-this.first}get relative(){return this.last<0}equals(e){return this.last===e.last&&this.first===e.first}get tracks(){return this.last<0?[]:Array(this.last-this.first+1).fill(0).map(((e,t)=>this.first+t))}toString(){return`[${this.type||"av"}-${this.first}-${this.last}]`}withEnd(e){return Ze.fromArgs(this.first,e,this.type)}withMax(e){return this.withEnd(e+this.last)}static ofType(e,t=-1,i=0){return this.fromArgs(i,t,e)}static fromArgs(e=0,t=-1,i){return new Ze(e,t,i)}}const We=e=>new URL(e,document.baseURI).href,Ke={absolute:We};class Ge{constructor(e){this.done=!1;const{actions:t,mash:i,redoSelectedClips:s,redoSelectedEffects:n,type:r,undoSelectedClips:o,undoSelectedEffects:a}=e;this.actions=t,this.type=r,this.mash=i,this.undoSelectedClips=o,this.redoSelectedClips=s,this.undoSelectedEffects=a,this.redoSelectedEffects=n}get selectedClips(){return this.done?this.redoSelectedClips:this.undoSelectedClips}get selectedEffects(){return this.done?this.redoSelectedEffects:this.undoSelectedEffects}redo(){this.redoAction(),this.done=!0}redoAction(){throw g.internal+"redoAction"}undo(){this.undoAction(),this.done=!1}undoAction(){throw g.internal+"undoAction"}}class He extends Ge{constructor(e){super(e);const{trackType:t}=e;this.trackType=t}redoAction(){this.mash.addTrack(this.trackType)}undoAction(){this.mash.removeTrack(this.trackType)}}class Xe extends Ge{constructor(e){super(e);const{property:t,redoValue:i,target:s,undoValue:n}=e;this.property=t,this.redoValue=i,this.target=s,this.undoValue=n}get redoValueNumeric(){return Number(this.redoValue)}get undoValueNumeric(){return Number(this.undoValue)}redoAction(){this.target.setValue(this.property,this.redoValue)}undoAction(){this.target.setValue(this.property,this.undoValue)}updateAction(e){this.redoValue=e,this.redo()}}class Ye extends Ge{constructor(e){super(e);const{frames:t,freezeClip:i,frozenClip:s,index:n,insertClip:r,trackClips:o}=e;this.frames=t,this.freezeClip=i,this.frozenClip=s,this.index=n,this.insertClip=r,this.trackClips=o}redoAction(){this.trackClips.splice(this.index,0,this.insertClip,this.frozenClip),this.freezeClip.frames-=this.frames}undoAction(){this.freezeClip.frames+=this.frames,this.trackClips.splice(this.index,2)}}class Qe extends Xe{constructor(e){super(e),this.clip=this.target}redoAction(){this.mash.changeClipFrames(this.clip,this.redoValueNumeric)}undoAction(){this.mash.changeClipFrames(this.clip,this.undoValueNumeric)}}class et extends Xe{constructor(e){super(e);const{frames:t,target:i}=e;this.frames=t,this.audibleClip=i}redoAction(){this.mash.changeClipTrimAndFrames(this.audibleClip,this.redoValueNumeric,this.frames)}undoAction(){this.mash.changeClipTrimAndFrames(this.audibleClip,this.undoValueNumeric,this.frames)}}class tt extends Ge{constructor(e){super(e);const{effect:t,effects:i,index:s}=e;this.effect=t,this.effects=i,this.index=s}redoAction(){this.effects.splice(this.index,0,this.effect)}undoAction(){this.effects.splice(this.index,1)}}class it extends He{constructor(e){super(e);const{clip:t,createTracks:i,insertIndex:s,trackIndex:n}=e;this.clip=t,this.createTracks=i,this.insertIndex=s,this.trackIndex=n}get clips(){return this.track.clips}get track(){return this.mash[this.trackType][this.trackIndex]}redoAction(){for(let e=0;e<this.createTracks;e+=1)super.redoAction();this.mash.addClipsToTrack([this.clip],this.trackIndex,this.insertIndex)}undoAction(){this.mash.removeClipsFromTrack([this.clip]);for(let e=0;e<this.createTracks;e+=1)super.undoAction()}}class st extends Ge{constructor(e){super(e);const{clips:t,insertIndex:i,redoFrames:s,trackIndex:n,undoFrames:r,undoInsertIndex:o,undoTrackIndex:a}=e;this.clips=t,this.insertIndex=i,this.redoFrames=s,this.trackIndex=n,this.undoFrames=r,this.undoInsertIndex=o,this.undoTrackIndex=a}addClips(e,t,i){this.mash.addClipsToTrack(this.clips,e,t,i)}redoAction(){this.addClips(this.trackIndex,this.insertIndex,this.redoFrames)}undoAction(){this.addClips(this.undoTrackIndex,this.undoInsertIndex,this.undoFrames)}}class nt extends Ge{constructor(e){super(e);const{clips:t,index:i,track:s}=e;this.clips=t,this.index=i,this.track=s}get trackIndex(){return this.track.index}redoAction(){this.mash.removeClipsFromTrack(this.clips)}undoAction(){this.mash.addClipsToTrack(this.clips,this.trackIndex,this.index)}}class rt extends Ge{constructor(e){super(e);const{index:t,insertClip:i,redoFrames:s,splitClip:n,trackClips:r,undoFrames:o}=e;this.index=t,this.insertClip=i,this.redoFrames=s,this.splitClip=n,this.trackClips=r,this.undoFrames=o}redoAction(){this.trackClips.splice(this.index,0,this.insertClip),this.splitClip.frames=this.redoFrames}undoAction(){this.splitClip.frames=this.undoFrames,this.trackClips.splice(this.index,1)}}class ot extends Ge{constructor(e){super(e);const{effects:t,redoEffects:i,undoEffects:s}=e;this.effects=t,this.redoEffects=i,this.undoEffects=s}redoAction(){this.effects.splice(0,this.effects.length,...this.redoEffects)}undoAction(){this.effects.splice(0,this.effects.length,...this.undoEffects)}}class at{constructor(e){this.index=-1,this.instances=[];const{mash:t}=e;this.mash=t}get canRedo(){return this.index<this.instances.length-1}get canSave(){return this.canUndo}get canUndo(){return this.index>-1}get currentAction(){return this.instances[this.index]}get currentActionLast(){return this.canUndo&&!this.canRedo}destroy(){this.index=-1,this.instances.splice(0,this.instances.length)}add(e){const t=this.instances.length-(this.index+1);V.positive(t)&&this.instances.splice(this.index+1,t),this.instances.push(e)}redo(){this.index+=1;const e=this.currentAction;return e.redo(),e}save(){this.instances.splice(0,this.index+1),this.index=-1}undo(){const e=this.currentAction;return this.index-=1,e.undo(),e}}class ct{get context(){if(!this.__context){const e=AudioContext||window.webkitAudioContext;if(!e)throw g.audibleContext;this.__context=new e}return this.__context}createBuffer(e){const t=44100*e;return this.context.createBuffer(2,t,44100)}createBufferSource(e){const t=this.context.createBufferSource();return e&&(t.buffer=e),t}createGain(){return this.context.createGain()}get currentTime(){return this.context.currentTime}decode(e){return new Promise(((t,i)=>this.context.decodeAudioData(e,(e=>t(e)),(e=>i(e)))))}get destination(){return this.context.destination}emit(e){this.context.dispatchEvent(new CustomEvent(e))}get time(){return $e.fromSeconds(this.currentTime)}}const lt={x:0,y:0};class ht{constructor(e={}){const{context2d:t}=e;t&&(this._context2d=t)}get alpha(){return this.context2d.globalAlpha}set alpha(e){this.context2d.globalAlpha=e}get canvas(){return this.context2d.canvas}set canvas(e){const t=e.getContext("2d");if(!t)throw g.invalid.canvas;this.context2d=t}clear(){return this.clearSize(this.size)}clearSize(e){return this.clearRect({...lt,...e})}clearRect(e){const{x:t,y:i,width:s,height:n}=e;return this.context2d.clearRect(t,i,s,n),this}get composite(){return this.context2d.globalCompositeOperation}set composite(e){this.context2d.globalCompositeOperation=e}get context2d(){if(!this._context2d){const e=globalThis.document.createElement("canvas").getContext("2d");if(!e)throw g.internal;this._context2d=e}return this._context2d}set context2d(e){this._context2d=e}get dataUrl(){return this.canvas.toDataURL()}draw(e){return this.drawAtPoint(e,lt)}drawAtPoint(e,t){const{x:i,y:s}=t;return this.context2d.drawImage(e,i,s),this}drawFill(e){return this.drawFillToSize(e,this.size)}drawFillInRect(e,t){const{x:i,y:s,width:n,height:r}=t,o=this.fill;return this.fill=e,this.context2d.fillRect(i,s,n,r),this.fill=o,this}drawFillToSize(e,t){return this.drawFillInRect(e,{...lt,...t})}drawImageData(e){return this.drawImageDataAtPoint(e,lt)}drawImageDataAtPoint(e,t){const{x:i,y:s}=t;return this.context2d.putImageData(e,i,s),this}drawInRect(e,t){const{x:i,y:s,width:n,height:r}=t;return this.context2d.drawImage(e,i,s,n,r),this}drawInRectFromRect(e,t,i){const{x:s,y:n,width:r,height:o}=t,{x:a,y:c,width:l,height:h}=i,{width:d,height:u}=e;if(s+r>d||n+o>u)throw g.eval.sourceRect+JSON.stringify(t)+" "+d+"x"+u;return this.context2d.drawImage(e,s,n,r,o,a,c,l,h),this}drawInRectFromSize(e,t,i){return this.drawInRectFromRect(e,t,{...lt,...i})}drawInSizeFromSize(e,t,i){const s={...lt,...t},n={...lt,...i};return this.drawInRectFromRect(e,s,n)}drawText(e,t){return this.drawTextAtPoint(e,t,lt)}drawTextAtPoint(e,t,i){const{x:s,y:n}=i,{height:r,family:o,color:a,shadow:c,shadowPoint:l}=t,h=this.fill,d=this.font,u=this.shadow,m=this.shadowPoint;return c&&(this.shadow=c,l&&(this.shadowPoint=l)),this.font=`${r}px "${o}"`,this.fill=a,this.context2d.fillText(e,s,n+r),this.font=d,this.fill=h,c&&(this.shadow=u,l&&(this.shadowPoint=m)),this}drawToSize(e,t){return this.drawInRect(e,{...lt,...t})}drawWithAlpha(e,t){const i=this.alpha;this.alpha=t;const s=this.draw(e);return this.alpha=i,s}drawWithComposite(e,t){const i=this.composite;this.composite=t;const s=this.draw(e);return this.composite=i,s}get fill(){return String(this.context2d.fillStyle)}set fill(e){this.context2d.fillStyle=e}get font(){return this.context2d.font}set font(e){this.context2d.font=e}get imageData(){return this.imageDataFromSize(this.size)}get imageDataFresh(){const{width:e,height:t}=this.size;return this.context2d.createImageData(e,t)}imageDataFromRect(e){const{x:t,y:i,width:s,height:n}=e;return this.context2d.getImageData(t,i,s,n)}imageDataFromSize(e){return this.imageDataFromRect({...lt,...e})}get drawingSource(){return this.canvas}get shadow(){return this.context2d.shadowColor}set shadow(e){this.context2d.shadowColor=e}get shadowPoint(){return{x:this.context2d.shadowOffsetX,y:this.context2d.shadowOffsetY}}set shadowPoint(e){this.context2d.shadowOffsetX=e.x,this.context2d.shadowOffsetY=e.y}get size(){return{width:this.canvas.width,height:this.canvas.height}}set size(e){const{width:t,height:i}=e;V.aboveZero(t)&&(this.canvas.width=t),V.aboveZero(i)&&(this.canvas.height=i)}}const dt=["audible","visible"],ut=Object.fromEntries(dt.map((e=>[e,e])));const mt=new class{audible(){return new ct}fromCanvas(e){const t=this.visible();return t.canvas=e,t}fromContext2D(e){return new ht({context2d:e})}toSize(e){const t=this.visible();return t.size=e,t}get type(){return ut}get types(){return dt}visible(){return new ht}};const ft=new class{constructor(){this.audibleContext=mt.audible(),this.cachedByKey=new Map,this.urlsByKey=new Map,this.visibleContext=mt.visible()}add(e,t){const i=this.key(e);this.cachedByKey.set(i,t),this.urlsByKey.set(i,e)}cached(e){const t=this.getObject(e);return t&&!(t instanceof Promise)}caching(e){const t=this.getObject(e);return t&&t instanceof Promise}flush(e){const t=[...this.urlsByKey.keys()],i=e.map((e=>this.key(e)));t.filter((e=>!i.includes(e))).forEach((e=>{const t=this.urlsByKey.get(e);t&&this.remove(t)}))}get(e){return this.cachedByKey.get(this.key(e))}getObject(e){if(!V.populatedString(e))throw g.argument+"url";const t=this.key(e);if(this.cachedByKey.has(t))return this.cachedByKey.get(t)}key(e){if(!V.populatedString(e))throw g.argument+"url";return"cachekey"+e.replaceAll(/[^a-z0-9]/gi,"")}remove(e){const t=this.key(e);this.cachedByKey.delete(t),this.urlsByKey.delete(t)}};class pt{arrayBufferPromiseFromUrl(e){return fetch(e).then((e=>e.arrayBuffer()))}arrayBufferPromiseFromBlob(e){return new Promise(((t,i)=>{const s=new FileReader;s.onload=()=>{t(s.result)},s.onerror=i,s.readAsArrayBuffer(e)}))}audioBufferPromiseFromArrayBuffer(e){return ft.audibleContext.decode(e)}async loadUrl(e){if(ft.cached(e)){const t=ft.get(e);return t instanceof Promise?t:Promise.resolve()}const t=this.requestUrl(e);ft.add(e,t);const i=await t;return ft.add(e,i),i}requestUrl(e){return Promise.resolve()}}class gt{constructor(...e){const[t]=e;if(!V.populatedObject(t))throw g.invalid.object+"InstanceBase";const{definition:i,id:s,label:n}=t;if(!i)throw g.invalid.definition.object+"InstanceBase";this.definition=i,s&&s!==i.id&&(this._id=s),n&&n!==i.label&&(this._label=n)}get copy(){return this.definition.instanceFromObject(this.toJSON())}get definitions(){return[this.definition]}definitionTime(e,t){return t.scaleToFps(e)}get id(){return this._id||this.definition.id}get identifier(){return this._identifier||=Ie()}get label(){return this._label||this.definition.label||this.id}set label(e){this._label=e}get propertyNames(){return this.definition.properties.map((e=>e.name))}get propertyValues(){return Object.fromEntries(this.definition.properties.map((e=>[e.name,this.value(e.name)])))}setValue(e,t){const i=this.definition.property(e);if(!i)throw g.property+e;const{type:s}=i,n=s.coerce(t);return void 0===n?(console.error(this.constructor.name,"setValue",e,t),!1):(this[e]=n,!0)}toJSON(){return this.propertyValues}get type(){return this.definition.type}value(e){const t=this[e];if(void 0===t)throw g.property+e;return t}}class yt{constructor(...t){this.properties=[],this.retain=!1;const[i]=t,{id:s,label:n,icon:r}=i;if(!s||!V.populatedString(s))throw g.invalid.definition.id+JSON.stringify(i);this.id=s,this.label=n||s,r&&(this.icon=r),this.properties.push(new ge({name:"label",type:e.DataType.String,value:""}))}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new gt({...this.instanceObject,...e})}get instanceObject(){const e={};return e.definition=this,this.properties.forEach((t=>{e[t.name]=t.value})),e}loadDefinition(e,t,i){}definitionUrls(e,t){return[]}get propertiesModular(){return this.properties.filter((e=>e.type.modular))}property(e){return this.properties.find((t=>t.name===e))}toJSON(){const e={id:this.id,type:this.type};return this.icon&&(e.icon=this.icon),this.label!==this.id&&(e.label=this.label),e}unload(e=[]){}value(e){const t=this.property(e);if(t)return t.value}}function vt(e){return class extends e{constructor(...e){super(...e),this.audible=!0,this.gain=u.instance.audio.gain,this.gainPairs=[];const[t]=e,{gain:i}=t;if(void 0!==i)if("string"==typeof i)if(i.includes(",")){const e=i.split(",").map((e=>parseFloat(e))),t=e.length/2;for(let i=0;i<t;i+=1)this.gainPairs.push([e[2*i],e[2*i+1]]);this.gain=-1}else this.gain=Number(i);else this.gain=i}loadedAudible(){return this.definition.loadedAudible()}get muted(){return 0===this.gain||!V.positive(this.gain)&&this.gainPairs===[[0,0],[1,0]]}startOptions(e,t){const i=this.timeRange(t);let s=e+i.seconds,n=i.lengthSeconds;const r=ft.audibleContext.currentTime;if(r>s){const e=r-s;s=r,n-=e}return{start:s,duration:n}}toJSON(){const e=super.toJSON();return this.gain!==u.instance.audio.gain&&(e.gain=this.gain),e}}}function bt(t){return class extends t{constructor(...t){super(...t),this.audible=!1,this.frame=0,this.frames=-1,this.track=-1,this.trackType=e.TrackType.Video,this.visible=!1;const[i]=t,{frame:s,frames:n,track:r}=i;void 0!==s&&V.positive(s)&&(this.frame=s),n&&V.aboveZero(n)&&(this.frames=n),void 0!==r&&(this.track=r)}definitionTime(e,t){const i=super.definitionTime(e,t),s=this.time(e).scale(i.fps),n=this.endTime(e).scale(i.fps),r=Math.max(Math.min(i.frame,n.frame),s.frame);return i.withFrame(r-s.frame)}get endFrame(){return this.frame+this.frames}endTime(e){return $e.fromArgs(this.endFrame,e)}loadClip(e,t,i){const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.definition.loadDefinition(e,s,n)}clipUrls(e,t,i){const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.definition.definitionUrls(s,n)}maxFrames(e,t){return 0}time(e){return $e.fromArgs(this.frame,e)}timeRange(e){return Le.fromArgs(this.frame,e,this.frames)}timeRangeRelative(e,t){const i=this.timeRange(t).scale(e.fps),s=Math.max(0,e.frame-i.frame);return i.withFrame(s)}toJSON(){const e=super.toJSON();return e.id=this.id,e}}}function wt(e){return class extends e{constructor(...e){super(...e),this.loop=u.instance.audio.loop,this.trim=u.instance.audio.trim;const[t]=e,{loop:i,trim:s}=t;void 0!==s&&V.integer(s)&&(this.trim=s),void 0!==i&&V.integer(i)&&(this.loop=i)}definitionTime(e,t){const i=super.definitionTime(e,t);if(!V.aboveZero(this.trim))return i;const s=this.trimTime(e).scale(i.fps);return i.withFrame(i.frame+s.frame)}maxFrames(e,t){const i=t||this.trim;return Math.floor(this.definition.duration*e)-i}startOptions(e,t){const i=this.timeRange(t);let s=0,n=e+i.seconds,r=i.lengthSeconds;this.trim&&(i.frame=this.trim,s=i.seconds);const o=ft.audibleContext.currentTime;if(o>n){const e=o-n;n=o,s+=e,r-=e}return{start:n,offset:s,duration:r}}trimTime(e){return $e.fromArgs(this.trim,e)}toJSON(){const e=super.toJSON();return this.trim!==u.instance.audio.trim&&(e.trim=this.trim),this.loop!==u.instance.audio.loop&&(e.loop=this.loop),e}}}const Tt=wt(vt(bt(gt)));class xt extends Tt{constructor(){super(...arguments),this.trackType=e.TrackType.Audio}}const Ct=[{name:"frame",type:e.DataType.Integer,value:0},{name:"frames",type:e.DataType.Integer,value:-1},{name:"track",type:e.DataType.Integer,value:-1}];function St(e){return class extends e{constructor(...e){super(...e),this.audible=!1,this.streamable=!1,this.visible=!1;const t=Ct.map((e=>new ge(e)));this.properties.push(...t)}get duration(){if(!this._duration){const e=u.definition;this._duration=Number(e[this.type].duration)}return this._duration}set duration(e){this._duration=e}frames(e){return $e.fromSeconds(this.duration,e,"floor").frame}}}class Ft extends pt{constructor(){super(...arguments),this.type=e.LoadType.Audio}async requestUrl(e){return new Promise(((t,i)=>{this.arrayBufferPromiseFromUrl(e).then((e=>this.audioBufferPromiseFromArrayBuffer(e))).then(t).catch(i)}))}}class _t extends pt{constructor(){super(...arguments),this.type=e.LoadType.Font}requestUrl(e){return new Promise(((t,i)=>{console.debug(this.constructor.name,"requestUrl",e);const s=ft.key(e);this.arrayBufferPromiseFromUrl(e).then((e=>new FontFace(s,e).load())).then((e=>{document.fonts.add(e),t(e)})).catch((e=>i(e)))}))}}class It extends pt{constructor(){super(...arguments),this.type=e.LoadType.Image}requestUrl(e){const t=new Image;return t.crossOrigin="Anonymous",t.src=e,t.decode().then((()=>Promise.resolve(t)))}}class At extends pt{constructor(){super(...arguments),this.type=e.LoadType.Video}requestUrl(e){return new Promise(((t,i)=>this.videoPromiseFromUrl(e).then((i=>this.arrayBufferPromiseFromUrl(e).then((e=>this.audioBufferPromiseFromArrayBuffer(e).then((e=>{t({video:i,audio:e,sequence:[]})})))))).catch(i)))}videoPromiseFromUrl(e){return new Promise(((t,i)=>{const s=this.videoFromUrl(e);s.ondurationchange=()=>{s.ondurationchange=null,s.width=s.videoWidth,s.height=s.videoHeight,t(s)},s.onerror=i,s.load()}))}videoFromUrl(e){const t=document.createElement("video");return t.crossOrigin="anonymous",t.src=e,t}}const Dt={Audio:Ft,Font:_t,Image:It,Video:At};const kt=new class{audio(){return new Dt.Audio}font(){return new Dt.Font}image(){return new Dt.Image}install(e,t){Dt[ye(e)]=t}video(){return new Dt.Video}};function Ot(t){return class extends t{constructor(...t){super(...t),this.audible=!0,this.loops=!1,this.stream=!1;const[i]=t,{stream:s,url:n,audio:r,source:o,waveform:a}=i,c=r||n||o||"";if(!c)throw g.invalid.definition.audio;this.urlAudible=c,s&&(this.stream=!0),o&&(this.source=o),a&&(this.waveform=a),this.properties.push(new ge({name:"gain",type:e.DataType.Number,value:1}))}get absoluteUrl(){return We(this.urlAudible)}loadDefinition(e,t,i){if(!i)return;const s=this.absoluteUrl;return ft.cached(s)?void 0:ft.caching(s)?ft.get(s):kt.audio().loadUrl(s)}definitionUrls(){return[this.absoluteUrl]}loadedAudible(){const e=ft.get(this.absoluteUrl);if(e&&!(e instanceof Promise))return console.debug(this.constructor.name,"loadedAudible",e.constructor.name),ft.audibleContext.createBufferSource(e)}toJSON(){const e=super.toJSON();return e.audio=this.urlAudible,this.source&&(e.source=this.source),this.waveform&&(e.waveform=this.waveform),e}unload(e=[]){super.unload(e),e.length&&e.some((e=>2===e.length))||ft.cached(this.absoluteUrl)&&ft.remove(this.absoluteUrl)}}}function Mt(t){return class extends t{constructor(...t){super(...t),this.loops=!1;const[i]=t,{loops:s,duration:n}=i;if(!n)throw g.invalid.definition.duration;this.duration=Number(n),s&&(this.properties.push(new ge({name:"loop",type:e.DataType.Integer,value:1})),this.loops=!0),this.properties.push(new ge({name:"trim",type:e.DataType.Integer,value:0}))}toJSON(){const e=super.toJSON();return e.duration=this.duration,this.loops&&(e.loops=!0),e}}}const Et=Mt(Ot(St(yt)));class zt extends Et{constructor(...t){super(...t),this.trackType=e.TrackType.Audio,this.type=e.DefinitionType.Audio,me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){const t={...this.instanceObject,...e};return new xt(t)}}const Vt={},jt=e=>{const{id:t}=e;if(!t)throw g.id;return me.installed(t)?me.fromId(t):new zt(e)},Nt=e=>jt({id:e}),Pt=e=>jt(e).instanceFromObject(e),Rt=e=>Pt({id:e}),qt=()=>{},Ut=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),jt(e)},Bt=e=>{const t=Ut(e);return t.retain=!0,t},Jt={define:Ut,definition:jt,definitionFromId:Nt,fromId:Rt,initialize:qt,install:Bt,instance:Pt};Vt[e.DefinitionType.Audio]=Jt;class $t extends gt{constructor(...e){super(...e),this.parameters=[];const[t]=e;if(!V.populatedObject(t))throw g.invalid.object+"filter";const{parameters:i}=t;i&&this.parameters.push(...i.map((e=>new y(e))))}drawFilter(e){this.definition.scopeSet(e);const t=this.evaluated(e);return console.log(this.constructor.name,"drawFilter",t),this.definition.draw(e,t)}evaluated(e){const t={},i=[...this.parameters];return this.definition.parameters.forEach((e=>{i.find((t=>t.name===e.name))||i.push(e)})),V.populatedArray(i)?(i.forEach((i=>{const{name:s,value:n}=i;if(!V.populatedString(s))return;const r=e.evaluate(n);return t[s]=r,e.set(s,r),`${s}=>${r}`})),t):t}toJSON(){const e={id:this.id};return this.parameters.length&&(e.parameters=this.parameters),e}}class Lt extends yt{constructor(...t){super(...t),this.parameters=[],this.retain=!0,this.type=e.DefinitionType.Filter,me.install(this)}draw(e,t){throw g.unimplemented}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new $t({...this.instanceObject,...e})}scopeSet(e){}}class Zt extends Lt{draw(t,i){const{context:s,mergeContext:n}=t;if(void 0===n)throw g.internal+"BlendFilter mergeContext";const r=pe.propertyType(e.DataType.Mode).values;if(void 0===r)throw g.unknown.mode;const o=r.find((e=>e.id===i.all_mode));if(void 0===o)throw g.unknown.mode;const{identifier:a}=o;return n.drawWithComposite(s.drawingSource,a),n}}class Wt extends Lt{constructor(){super(...arguments),this.parameters=[new y({name:"color",value:"color"}),new y({name:"similarity",value:"similarity"}),new y({name:"blend",value:"blend"})]}draw(e,t){const{context:i}=e,{width:s,height:n}=i.size,{accurate:r}=t,o=Number(t.similarity),a=Number(t.blend),c=String(t.color),l=c.substr(4,c.length-5).split(",").map((e=>Number(e))),h={r:l[0],g:l[1],b:l[2]},u=d.rgb2yuv(h),m=i.imageData,f=m.data,p=r?this.yuvsFromPixelsAccurate(f,s,n):this.yuvsFromPixels(f);let g=0;return p.reverse().forEach((e=>{f[g+3]=d.yuvBlend(e,u,o,a),g+=4})),i.drawImageData(m),i}yuvsFromPixels(e){const t=[];for(let i=e.length/4-1;i>0;i-=1)t.push([d.rgb2yuv(Pe.rgbaAtIndex(4*i,e))]);return t}yuvsFromPixelsAccurate(e,t,i){const s=[];for(let n=e.length/4-1;n>0;n-=1){const r={width:t,height:i};s.push(Pe.neighboringRgbas(4*n,e,r).map((e=>d.rgb2yuv(e))))}return s}}class Kt extends Lt{constructor(){super(...arguments),this.parameters=[new y({name:"color",value:"color"}),new y({name:"size",value:"mm_dimensions"}),new y({name:"duration",value:"mm_duration"}),new y({name:"rate",value:"mm_fps"})]}draw(e,t){const{context:i}=e,{color:s}=t;return M(s)?(i.drawFill(Pe.color(s)),i):i}}class Gt extends Lt{draw(e,t){const i=Object.fromEntries(Object.entries(t).map((e=>{const[t,i]=e;return[t,Number(i)]}))),{context:s}=e,n="rgba".split("");n.forEach((e=>{n.forEach((t=>{const s=`${e}${t}`;null===i[s]&&(i[s]=e===t?1:0)}))}));const{imageData:r}=s,{data:o}=r;return o.forEach(((e,t)=>{const s=o[t+1],n=o[t+2],r=o[t+3];o[t]=e*i.rr+s*i.rg+n*i.rb+r*i.ra,o[t+1]=e*i.gr+s*i.gg+n*i.gb+r*i.ga,o[t+2]=e*i.br+s*i.bg+n*i.bb+r*i.ba,o[t+3]=e*i.ar+s*i.ag+n*i.ab+r*i.aa})),s.drawImageData(r),s}}const Ht="rgba";class Xt extends Lt{draw(e,t){const i=(e=>{const t={bias:{},rdiv:{},matrix:{}};return Ht.split("").forEach(((i,s)=>{const n=e[`${s}m`].split(" ").map((e=>parseInt(e)));if(t.matrix[i]=n,t.rdiv[i]=e[`${s}rdiv`]||1,String(t.rdiv[i]).includes("/")){const e=String(t.rdiv[i]).split("/");t.rdiv[i]=parseFloat(e[0])/parseFloat(e[1])}else t.rdiv[i]=parseFloat(String(t.rdiv[i]));t.bias[i]=e[`${s}bias`]||0})),t})(t),{context:s}=e,{size:n}=s,{width:r,height:o}=n,a=s.imageData,c=s.imageDataFresh,l=a.data,h=c.data,d=r*o;for(let e=0;e<d;e+=1){const t=Ee(e,l,n);Ht.split("").forEach(((s,n)=>{const r=i.rdiv[s],o=i.matrix[s],a=i.bias[s];let c=0;for(let e=0;e<9;e+=1)c+=t[e][s]*o[e];c=Math.floor(c*r+a+.5),h[4*e+n]=c}))}return s.drawImageData(c),s}}class Yt extends Lt{draw(e,t){const{context:i}=e,s=t.x||0,n=t.y||0,r=e.inputSize;let o=t.w||t.out_w||0,a=t.h||t.out_h||0;if(o+a<2)throw g.eval.outputSize;-1===o&&(o=r.width*(a/r.height)),-1===a&&(a=r.height*(o/r.width));const c={width:o,height:a},l={x:s,y:n,...c},h=mt.toSize(c);return h.drawInRectFromSize(i.drawingSource,l,c),h}scopeSet(e){e.setInputSize(e.context.size),e.initialize("x","((in_w - out_w) / 2)"),e.initialize("y","((in_h - out_h) / 2)")}}class Qt extends Lt{draw(e,t){const{context:i}=e,s=M(t.color)?t.color:"black",n=t.x||0,r=t.y||0,o=t.width||i.size.width,a=t.height||i.size.height;return i.drawFillInRect(Pe.color(s),{x:n,y:r,width:o,height:a}),i}}class ei extends gt{}class ti extends yt{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Font;const[i]=t,{source:s}=i;if(!s)throw g.invalid.definition.source+JSON.stringify(i);this.source=s,me.install(this)}get absoluteUrl(){return We(this.source)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new ei({...this.instanceObject,...e})}loadDefinition(){const e=this.absoluteUrl;if(!ft.cached(e))return ft.caching(e)?ft.get(e):kt.font().loadUrl(e)}definitionUrls(e,t){return[We(this.source)]}loadedVisible(){return ft.get(We(this.source))}toJSON(){return{...super.toJSON(),source:this.source}}}var ii={label:"Lobster",id:"com.moviemasher.font.default",type:"font",source:"https://fonts.gstatic.com/s/lobster/v23/neILzCirqoswsqX9zoKmM4MwWJU.woff2"};const si="com.moviemasher.font.default",ni=t=>{const{id:i}=t,s=i&&V.populatedString(i)?i:si;return me.installed(s)||new ti({...t,type:e.DefinitionType.Font,id:s}),me.fromId(s)},ri=e=>ni({id:e}),oi=e=>ni(e).instanceFromObject(e),ai=e=>oi({id:e}),ci=()=>{ni(ii)},li=e=>{const{id:t}=e,i=t&&V.populatedString(t)?t:si;return me.uninstall(i),ni(e)},hi={define:li,install:li,definition:ni,definitionFromId:ri,fromId:ai,initialize:ci,instance:oi};Vt[e.DefinitionType.Font]=hi;const di=e=>{if(!V.populatedString(e))throw g.id;return ri(e).absoluteUrl},ui=e=>String(e),mi=e=>ft.key(di(e));class fi extends Lt{constructor(){super(...arguments),this.parameters=[new y({name:"fontcolor",value:"#000000"}),new y({name:"shadowcolor",value:"#FFFFFF"}),new y({name:"fontsize",value:"mm_vert(20)"}),new y({name:"x",value:"0"}),new y({name:"y",value:"0"}),new y({name:"shadowx",value:"mm_horz(5)"}),new y({name:"shadowy",value:"mm_vert(5)"}),new y({name:"fontfile",value:"mmFontFile('com.moviemasher.font.default')"}),new y({name:"textfile",value:"Hello World"})]}draw(e,t){const{context:i}=e,s=String(e.get("fontface")),n=mi(s),{x:r,y:o,fontsize:a,fontcolor:c,text:l,textfile:h,shadowcolor:d,shadowx:u,shadowy:m}=t;if(!a||!V.aboveZero(a))throw g.eval.number+" fontsize";const f={height:Number(a),family:n,color:String(c||"black"),shadow:String(d||""),shadowPoint:{x:Number(u||0),y:Number(m||0)}},p={x:Number(r||0),y:Number(o||0)},y=String(l||h);return i.drawTextAtPoint(y,f,p),i}scopeSet(e){e.set("text_w",0),e.set("text_h",0),e.set("mmFontFamily",mi),e.set("mmTextFile",ui),e.set("mmFontFile",di),e.set("mm_fontfamily",mi),e.set("mm_textfile",ui),e.set("mm_fontfile",di)}}class pi extends Lt{draw(e){const{context:t}=e,i=mt.toSize(t.size),s=Number(e.get("alpha")||e.position),n="in"===String(e.get("type")||"in")?s:1-s;return i.drawWithAlpha(t.drawingSource,n),i}}class gi extends Lt{draw(e,t){const{x:i,y:s}=t,{context:n,mergeContext:r}=e;if(void 0===r)throw g.internal+"OverlayFilter mergeContext";return r.drawAtPoint(n.drawingSource,{x:i||0,y:s||0}),r}scopeSet(e){const{width:t,height:i}=e.context.size;e.set("overlay_w",t),e.set("overlay_h",i)}}class yi extends Lt{draw(e,t){const{context:i}=e;let s=t.w||t.width||0,n=t.h||t.height||0;if(s+n<2)return i;const r={width:Number(e.get("mm_in_w")),height:Number(e.get("mm_in_h"))};-1===s?s=r.width*(n/r.height):-1===n&&(n=r.height*(s/r.width));const o={width:s,height:n},a=mt.toSize(o);return a.drawInSizeFromSize(i.drawingSource,r,o),a}scopeSet(e){const{width:t,height:i}=e.context.size;e.set("in_h",i),e.set("mm_in_h",i),e.set("in_w",t),e.set("mm_in_w",t)}}class vi extends Lt{draw(e,t){return e.context}}const bi=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;if(me.installed(t))return me.fromId(t);throw g.invalid.definition.id+" filterDefinition "+t},wi=e=>bi({id:e}),Ti=e=>bi(e).instanceFromObject(e),xi=e=>Ti({id:e}),Ci=()=>{new Xt({id:"convolution",type:e.DefinitionType.Filter}),new vi({id:"setsar",type:e.DefinitionType.Filter}),new Zt({id:"blend",type:e.DefinitionType.Filter}),new Wt({id:"chromakey",type:e.DefinitionType.Filter}),new Kt({id:"color",type:e.DefinitionType.Filter}),new Gt({id:"colorchannelmixer",type:e.DefinitionType.Filter}),new Yt({id:"crop",type:e.DefinitionType.Filter}),new Qt({id:"drawbox",type:e.DefinitionType.Filter}),new fi({id:"drawtext",type:e.DefinitionType.Filter}),new pi({id:"fade",type:e.DefinitionType.Filter}),new gi({id:"overlay",type:e.DefinitionType.Filter}),new yi({id:"scale",type:e.DefinitionType.Filter})},Si=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.invalid.definition.id+"filterDefine";return me.uninstall(t),bi(e)},Fi={define:Si,install:Si,definition:bi,definitionFromId:wi,fromId:xi,initialize:Ci,instance:Ti};function _i(e){return class extends e{constructor(...e){super(...e),this.filters=[],this.retain=!0;const[t]=e,{properties:i,filters:s}=t;if(i){const e=Object.entries(i).map((e=>{const[t,i]=e;if(!V.object(i))throw g.invalid.property+"name "+t;const s=Object.assign(i,{name:t,custom:!0});return new ge(s)}));this.properties.push(...e)}if(s){const e=s.map((e=>{const{id:t}=e;if(!t)throw g.id;return Ti(e)}));this.filters.push(...e)}}drawFilters(e,t,i,s,n){let r=i;return this.filters.forEach((i=>{const o=this.evaluator(e,t,r,s,n);r=i.drawFilter(o)})),r}evaluator(e,t,i,s,n){const r=new _e(t,i,s,n);return this.propertiesCustom.forEach((t=>{const i=e.value(t.name);r.set(t.name,i)})),r}get propertiesCustom(){return this.properties.filter((e=>e.custom))}toJSON(){const e=super.toJSON();this.filters.length&&(e.filters=this.filters);const t=this.propertiesCustom.map((e=>[e.name,e]));return t.length&&(e.properties=Object.fromEntries(t)),e}}}function Ii(e){return class extends e{constructor(...e){super(...e);const[t]=e;this.constructProperties(t)}constructProperties(e={}){this.definition.properties.forEach((t=>{const{name:i}=t;void 0!==e[i]?this[i]=e[i]:void 0===this[i]&&(this[i]=t.value)}))}get definitions(){return[...super.definitions,...this.modularDefinitions]}loadModular(e,t,i){const s=[],n=this.definitionTime(e,t),r=i?this.definitionTime(e,i):i;return this.modularDefinitions.forEach((t=>{const i=t.loadDefinition(e,n,r);i&&s.push(i)})),Promise.all(s).then()}modularUrls(e,t,i){const s=this.definitionTime(e,t),n=i?this.definitionTime(e,i):i;return this.modularDefinitions.flatMap((e=>e.definitionUrls(s,n)))}get modularDefinitions(){return this.definition.propertiesModular.map((e=>String(this.value(e.name)))).map((e=>me.fromId(e)))}}}Vt[e.DefinitionType.Filter]=Fi;const Ai=Ii(gt);class Di extends Ai{toJSON(){const e=super.toJSON();return e.id=this.id,e}}const ki=_i(yt);class Oi extends ki{constructor(...t){super(...t),this.type=e.DefinitionType.Effect,me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Di({...this.instanceObject,...e})}}var Mi={label:"Blur",type:"effect",id:"com.moviemasher.effect.blur",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"1 1 1 1 1 1 1 1 1"},{name:"1m",value:"1 1 1 1 1 1 1 1 1"},{name:"2m",value:"1 1 1 1 1 1 1 1 1"},{name:"3m",value:"1 1 1 1 1 1 1 1 1"},{name:"0rdiv",value:"1/9"},{name:"1rdiv",value:"1/9"},{name:"2rdiv",value:"1/9"},{name:"3rdiv",value:"1/9"}]}]};var Ei={label:"Chromakey",type:"effect",id:"com.moviemasher.effect.chromakey",properties:{accurate:{type:"number",value:0},chroma_blend:{type:"number",value:.01},chroma_similarity:{type:"number",value:.5},chroma_color:{type:"rgb",value:"rgb(0,255,0)"}},filters:[{id:"chromakey",parameters:[{name:"color",value:"chroma_color"},{name:"blend",value:"chroma_blend"},{name:"similarity",value:"chroma_similarity"}]}]};var zi={label:"Emboss",type:"effect",id:"com.moviemasher.effect.emboss",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"1m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"2m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"3m",value:"-2 -1 0 -1 1 1 0 1 2"}]}]};var Vi={label:"Grayscale",type:"effect",id:"com.moviemasher.effect.grayscale",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.3},{name:"rg",value:.4},{name:"rb",value:.3},{name:"ra",value:0},{name:"gr",value:.3},{name:"gg",value:.4},{name:"gb",value:.3},{name:"ga",value:0},{name:"br",value:.3},{name:"bg",value:.4},{name:"bb",value:.3},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var ji={label:"Sepia",type:"effect",id:"com.moviemasher.effect.sepia",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.393},{name:"rg",value:.769},{name:"rb",value:.189},{name:"ra",value:0},{name:"gr",value:.349},{name:"gg",value:.686},{name:"gb",value:.168},{name:"ga",value:0},{name:"br",value:.272},{name:"bg",value:.534},{name:"bb",value:.131},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var Ni={label:"Sharpen",type:"effect",id:"com.moviemasher.effect.sharpen",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"1m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"2m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"3m",value:"0 -1 0 -1 5 -1 0 -1 0"}]}]};var Pi={label:"Text Box",type:"effect",id:"com.moviemasher.effect.text",properties:{string:{type:"string",value:"Text Box"},size:{type:"fontsize",value:.2},color:{type:"rgba",value:"rgba(255,0,0,1)"},fontface:{type:"font",value:"com.moviemasher.font.default"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},x:{type:"number",value:0},y:{type:"number",value:0}},filters:[{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]};const Ri=t=>{const{id:i}=t;if(!i||!V.populatedString(i))throw g.id;return me.installed(i)?me.fromId(i):new Oi({...t,type:e.DefinitionType.Effect})},qi=e=>Ri({id:e}),Ui=e=>Ri(e).instanceFromObject(e),Bi=e=>Ui({id:e}),Ji=()=>{new Oi(Mi),new Oi(Ei),new Oi(zi),new Oi(Vi),new Oi(ji),new Oi(Ni),new Oi(Pi)},$i=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),Ri(e)},Li={define:$i,definition:Ri,definitionFromId:qi,fromId:Bi,initialize:Ji,install:$i,instance:Ui};Vt[e.DefinitionType.Effect]=Li;class Zi{static get[e.DefinitionType.Audio](){const t=Vt[e.DefinitionType.Audio];if(!t)throw g.invalid.factory+e.DefinitionType.Audio;return t}static get context(){return mt}static get[e.DefinitionType.Effect](){const t=Vt[e.DefinitionType.Effect];if(!t)throw g.invalid.factory+e.DefinitionType.Effect;return t}static get[e.DefinitionType.Filter](){const t=Vt[e.DefinitionType.Filter];if(!t)throw g.invalid.factory+e.DefinitionType.Filter;return t}static get[e.DefinitionType.Font](){const t=Vt[e.DefinitionType.Font];if(!t)throw g.invalid.factory+e.DefinitionType.Font;return t}static get[e.DefinitionType.Image](){const t=Vt[e.DefinitionType.Image];if(!t)throw g.invalid.factory+e.DefinitionType.Image;return t}static get[e.DefinitionType.Mash](){const t=Vt[e.DefinitionType.Mash];if(!t)throw g.invalid.factory+e.DefinitionType.Mash;return t}static get[e.DefinitionType.Masher](){const t=Vt[e.DefinitionType.Masher];if(!t)throw g.invalid.factory+e.DefinitionType.Masher;return t}static get[e.DefinitionType.Merger](){const t=Vt[e.DefinitionType.Merger];if(!t)throw g.invalid.factory+e.DefinitionType.Merger;return t}static get[e.DefinitionType.Scaler](){const t=Vt[e.DefinitionType.Scaler];if(!t)throw g.invalid.factory+e.DefinitionType.Scaler;return t}static get[e.DefinitionType.Theme](){const t=Vt[e.DefinitionType.Theme];if(!t)throw g.invalid.factory+e.DefinitionType.Theme;return t}static get[e.DefinitionType.Transition](){const t=Vt[e.DefinitionType.Transition];if(!t)throw g.invalid.factory+e.DefinitionType.Transition;return t}static get[e.DefinitionType.Video](){const t=Vt[e.DefinitionType.Video];if(!t)throw g.invalid.factory+e.DefinitionType.Video;return t}static get[e.DefinitionType.VideoSequence](){const t=Vt[e.DefinitionType.VideoSequence];if(!t)throw g.invalid.factory+e.DefinitionType.VideoSequence;return t}static get[e.DefinitionType.VideoStream](){const t=Vt[e.DefinitionType.VideoStream];if(!t)throw g.invalid.factory+e.DefinitionType.VideoStream;return t}constructor(){}}const Wi=Ii(gt);class Ki extends Wi{get id(){return this.definition.id}set id(e){this.definition=Zi.merger.definitionFromId(e),this.constructProperties()}}const Gi=_i(yt);class Hi extends Gi{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Merger,this.properties.push(new ge({name:"id",type:e.DataType.String,value:""})),me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Ki({...this.instanceObject,...e})}}var Xi={label:"Blend",id:"com.moviemasher.merger.blend",type:"merger",properties:{mode:{type:"mode",value:"normal"}},filters:[{id:"blend",parameters:[{name:"all_mode",value:"mode"},{name:"repeatlast",value:"0"}]}]};var Yi={label:"Center",id:"com.moviemasher.merger.center",type:"merger",filters:[{id:"overlay",parameters:[{name:"x",value:"floor((mm_width - overlay_w) / 2)"},{name:"y",value:"floor((mm_height - overlay_h) / 2)"}]}]};var Qi={label:"Constrained",type:"merger",id:"com.moviemasher.merger.constrained",properties:{left:{type:"pixel",value:0},top:{type:"pixel",value:0}},filters:[{id:"overlay",parameters:[{name:"x",value:"left*(mm_width-overlay_w)"},{name:"y",value:"top*(mm_height-overlay_h)"}]}]};var es={label:"Top Left",id:"com.moviemasher.merger.default",type:"merger",filters:[{id:"overlay",parameters:[{name:"x",value:"0"},{name:"y",value:"0"}]}]};var ts={label:"Overlay",id:"com.moviemasher.merger.overlay",type:"merger",properties:{left:{type:"pixel",value:.5},top:{type:"pixel",value:.5}},filters:[{id:"overlay",parameters:[{name:"x",value:"((mm_width + overlay_w) * left) - overlay_w"},{name:"y",value:"((mm_height + overlay_h) * top) - overlay_h"}]}]};const is="com.moviemasher.merger.default",ss=t=>{const{id:i}=t,s=i&&V.populatedString(i)?i:is;return me.installed(s)?me.fromId(s):new Hi({...t,type:e.DefinitionType.Merger,id:s})},ns=e=>ss({id:e}),rs=e=>ss(e).instanceFromObject(e),os=e=>rs({id:e}),as=()=>{new Hi(Xi),new Hi(Yi),new Hi(Qi),new Hi(es),new Hi(ts)},cs=e=>{const{id:t}=e,i=t&&V.populatedString(t)?t:is;return me.uninstall(i),ss(e)},ls={define:cs,install:cs,definition:ss,definitionFromId:ns,fromId:os,initialize:as,instance:rs};Vt[e.DefinitionType.Merger]=ls;const hs=Ii(gt);class ds extends hs{get id(){return this.definition.id}set id(e){this.definition=Zi.scaler.definitionFromId(e),this.constructProperties()}}const us=_i(yt);class ms extends us{constructor(...t){super(...t),this.retain=!0,this.type=e.DefinitionType.Scaler,this.properties.push(new ge({name:"id",type:e.DataType.String,value:""})),me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new ds({...this.instanceObject,...e})}}var fs={label:"Stretch",id:"com.moviemasher.scaler.default",type:"scaler",filters:[{id:"scale",parameters:[{name:"width",value:"mm_width"},{name:"height",value:"mm_height"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var ps={label:"Pan",type:"scaler",id:"com.moviemasher.scaler.pan",properties:{scale:{type:"number",value:1.25},direction:{type:"direction8",value:1}},filters:[{id:"crop",description:"crop down diagonals and center",parameters:[{name:"out_w",value:[{condition:"direction < 4",value:"mm_input_width"},{condition:"true",value:"mm_horz(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"out_h",value:[{condition:"direction < 4",value:"mm_input_height"},{condition:"true",value:"mm_vert(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"x",value:"(mm_input_width-out_w)/2"},{name:"y",value:"(mm_input_height-out_h)/2"}]},{id:"scale",description:"scale (proudly for diagonals)",parameters:[{name:"w",value:[{condition:"direction < 4",value:"mm_input_width * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_horz(scale, true)"}]},{name:"h",value:[{condition:"direction < 4",value:"mm_input_height * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_vert(scale, true)"}]}]},{id:"crop",description:"crop down and position over time",parameters:[{name:"w",value:"mm_width"},{name:"h",value:"mm_height"},{name:"x",value:[{condition:"direction",in:[0,2],value:"(in_w-mm_width)/2"},{condition:"direction",in:[1,5],value:"(in_w-mm_width)*mm_t"},{condition:"direction",is:4,value:"(in_w-mm_width)*mm_t"},{condition:"direction",in:[3,7],value:"(in_w-mm_width)-((in_w-mm_width)*mm_t)"},{condition:"direction",is:6,value:"floor(((in_w-mm_width)*(1.0-mm_t)))"}]},{name:"y",value:[{condition:"direction",in:[1,3],value:"(in_h-mm_height)/2"},{condition:"direction",in:[2,5],value:"(in_h-mm_height)*mm_t"},{condition:"direction",is:6,value:"ceil((in_h-mm_height)*mm_t)"},{condition:"direction",in:[0,7],value:"(in_h-mm_height)-((in_h-mm_height)*mm_t)"},{condition:"direction",is:4,value:"(in_h-mm_height)-((in_h-mm_height) * mm_t)"}]}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var gs={label:"Scale",type:"scaler",id:"com.moviemasher.scaler.scale",properties:{scale:{type:"number",value:1}},filters:[{id:"scale",parameters:[{name:"width",value:"scale * mm_input_width * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"},{name:"height",value:"scale * mm_input_height * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};const ys="com.moviemasher.scaler.default",vs=t=>{const{id:i}=t,s=i&&V.populatedString(i)?i:ys;return me.installed(s)?me.fromId(s):new ms({...t,type:e.DefinitionType.Scaler,id:s})},bs=e=>vs({id:e}),ws=e=>vs(e).instanceFromObject(e),Ts=e=>ws({id:e}),xs=()=>{new ms(fs),new ms(ps),new ms(gs)},Cs=e=>{const{id:t}=e,i=t&&V.populatedString(t)?t:ys;return me.uninstall(i),vs(e)},Ss={define:Cs,install:Cs,definitionFromId:bs,definition:vs,instance:ws,fromId:Ts,initialize:xs};function Fs(e){return class extends e{constructor(...e){super(...e),this.effects=[];const[t]=e,{merger:i,effects:s,scaler:n}=t;if(this.merger=rs(i||{}),this.scaler=ws(n||{}),s){const e=s.map((e=>Ui(e)));this.effects.push(...e)}}get definitions(){return[...super.definitions,...this.merger.definitions,...this.scaler.definitions,...this.effects.flatMap((e=>e.definitions))]}effectedContextAtTimeToSize(e,t,i){const s=this.scaledContextAtTimeToSize(e,t,i);if(!s)return;let n=s;if(!this.effects)return n;const r=this.timeRangeRelative(e,t);return r?(this.effects.reverse().every((e=>n=e.definition.drawFilters(e,r,n,i))),n):void 0}loadClip(e,t,i){const s=[super.loadClip(e,t,i),this.loadTransformable(e,t,i)].filter(Boolean);switch(s.length){case 0:return;case 1:return s[0];default:return Promise.all(s).then()}}loadTransformable(e,t,i){const s=[this.merger.loadModular(e,t,i),this.scaler.loadModular(e,t,i),...this.effects.map((s=>s.loadModular(e,t,i)))].filter(Boolean);switch(s.length){case 0:return;case 1:return s[0];default:return Promise.all(s).then()}}mergeContextAtTime(e,t,i){const s=this.effectedContextAtTimeToSize(e,t,i.size);if(!s)return;const n=this.timeRangeRelative(e,t);this.merger.definition.drawFilters(this.merger,n,s,i.size,i)}get propertyValues(){return{merger:this.merger.propertyValues,scaler:this.scaler.propertyValues,...super.propertyValues}}scaledContextAtTimeToSize(e,t,i){const s=this.contextAtTimeToSize(e,t,i);if(!s)return;const n=this.timeRangeRelative(e,t);return V.undefined(n)?s:this.scaler.definition.drawFilters(this.scaler,n,s,i)}toJSON(){const e=super.toJSON();return this.effects.length&&(e.effects=this.effects),e}}}function _s(t){return class extends t{constructor(){super(...arguments),this.trackType=e.TrackType.Video,this.visible=!0}contextAtTimeToSize(e,t,i){const s=this.definitionTime(t,e),n=this.loadedVisible(t,s);if(!n)return void console.error(this.constructor.name,"contextAtTimeToSize not loaded",this.id);const r=Number(n.width),o=Number(n.height),a=mt.toSize({width:r,height:o});return a.draw(n),a}loadedVisible(e,t){return this.definition.loadedVisible(e,t)}mergeContextAtTime(e,t,i){}}}Vt[e.DefinitionType.Scaler]=Ss;const Is=Fs(_s(bt(gt)));class As extends Is{}function Ds(t){return class extends t{constructor(){super(...arguments),this.trackType=e.TrackType.Video,this.visible=!0}loadedVisible(){}}}const ks=Ds(St(yt)),Os=Ds(ks);class Ms extends Os{constructor(...t){super(...t),this.source="",this.type=e.DefinitionType.Image;const[i]=t;if(!i)throw g.unknown.definition;const{url:s,source:n}=i;if(!s)throw g.invalid.definition.url;this.urlVisible=s,n&&(this.source=n),me.install(this)}get absoluteUrl(){return We(this.urlVisible)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new As({...this.instanceObject,...e})}loadDefinition(e,t,i){const s=[],n=super.loadDefinition(e,t,i);n&&s.push(n);const r=this.absoluteUrl;switch(ft.cached(r)||(ft.caching(r)?s.push(ft.get(r)):s.push(kt.image().loadUrl(r))),s.length){case 0:return;case 1:return s[0];default:return Promise.all(s).then()}}definitionUrls(e,t){return[this.absoluteUrl]}loadedVisible(){return ft.get(this.absoluteUrl)}toJSON(){const e=super.toJSON();return e.url=this.urlVisible,this.source&&(e.source=this.source),e}unload(e=[]){super.unload(e),e.length||ft.cached(this.urlVisible)&&ft.remove(this.urlVisible)}}const Es=e=>{const{id:t}=e;if(!t)throw g.id;return me.installed(t)?me.fromId(t):new Ms(e)},zs=e=>Es({id:e}),Vs=e=>Es(e).instanceFromObject(e),js=e=>Vs({id:e}),Ns=()=>{},Ps=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),Es(e)},Rs=e=>{const t=Ps(e);return t.retain=!0,t},qs={define:Ps,install:Rs,definition:Es,definitionFromId:zs,fromId:js,initialize:Ns,instance:Vs};Vt[e.DefinitionType.Image]=qs;class Us{constructor(t){this.clips=[],this.index=0,this.type=e.TrackType.Video;const{clips:i,index:s,type:n}=t;s&&(this.index=s),n&&(this.type=n),i&&this.clips.push(...i)}get frames(){if(!this.clips.length)return 0;const e=this.clips[this.clips.length-1];return e.frame+e.frames}get isMainVideo(){return!this.index&&this.type===e.TrackType.Video}addClips(e,t=0){let i=t||0;this.isMainVideo||(i=0);const s=i,n=[],r=this.clips.filter(((t,r)=>{const o=e.includes(t);return o&&n.push(t),s&&o&&r<s&&(i-=1),!o}));r.splice(i,0,...e),this.sortClips(r);e.filter((e=>!n.includes(e))).forEach((e=>{e.track=this.index})),this.clips.splice(0,this.clips.length,...r)}frameForClipsNearFrame(e,t=0){if(this.isMainVideo)return t;const i=this.clips.filter((i=>!e.includes(i)&&i.endFrame>t));if(!i.length)return t;const s=Math.min(...e.map((e=>e.frame))),n=Math.max(...e.map((e=>e.endFrame)))-s;let r=t;return i.find((e=>{if(e.frame>=r+n)return!0;r=e.endFrame})),r}removeClips(e){const t=this.clips.filter((t=>!e.includes(t)));if(t.length===this.clips.length)throw g.internal+"removeClips";e.forEach((e=>{e.track=-1})),this.sortClips(t),this.clips.splice(0,this.clips.length,...t)}sortClips(t){if(this.isMainVideo){let i=0;t.forEach(((t,s)=>{const n=t.type===e.DefinitionType.Transition;s&&n&&(i-=t.frames),t.frame=i,n||(i+=t.frames)}))}t.sort(Re)}toJSON(){return{type:this.type,index:this.index,clips:this.clips}}}class Bs{constructor(e){this.buffer=u.mash.buffer,this._gain=u.mash.gain,this.playing=!1,this.quantize=u.mash.quantize,this.sourcesByClip=new Map,this.startedMashAt=0,this.startedContextAt=0;const{backcolor:t,buffer:i,gain:s,quantize:n}=e;t&&(this.backcolor=t),n&&V.aboveZero(n)&&(this.quantize=n),void 0!==s&&V.positive(s)&&(this._gain=s),i&&V.aboveZero(i)&&(this.buffer=i)}adjustSourceGain(e){const t=this.sourcesByClip.get(e);if(!t)return;const{gainNode:i}=t;if(0===this.gain)return void(i.gain.value=0);const s=e.gain;if(V.positive(s))return void(i.gain.value=this.gain*s);const n=e.startOptions(this.startedContextAt-this.startedMashAt,this.quantize),{start:r,duration:o}=n;console.log(this.constructor.name,"adjustSourceGain",e.label,n,this.startedContextAt-this.startedMashAt,this.quantize),i.gain.cancelScheduledValues(0),e.gainPairs.forEach((e=>{const[t,s]=e;i.gain.linearRampToValueAtTime(this.gain*s,r+t*o)}))}compositeAudible(e){return!!this.createSources(e)&&(this.destroySources(e),!0)}compositeVisible(t,i){const s=i.filter((e=>0===e.track));if(this.drawBackground(),s.length>1){const i=s.find((t=>t.type===e.DefinitionType.Transition));if(!i)throw g.mainTrackOverlap;const n=s.filter((t=>t.type!==e.DefinitionType.Transition));i.mergeClipsIntoContextAtTime(n,ft.visibleContext,t,this.quantize,this.backcolor)}else{const[e]=s;e&&e.mergeContextAtTime(t,this.quantize,ft.visibleContext)}i.filter((e=>!s.includes(e))).sort(qe).forEach((e=>{e.mergeContextAtTime(t,this.quantize,ft.visibleContext)})),ft.audibleContext.emit(e.EventType.Draw)}compositeVisibleRequest(e,t){V.populatedArray(t)?requestAnimationFrame((()=>this.compositeVisible(e,t))):this.drawBackground()}createSources(e){return e.filter((e=>!this.sourcesByClip.has(e))).every((e=>{const t=e.loadedAudible();if(!t)return console.debug(this.constructor.name,"createSources loadedAudible undefined",e.id),!1;const i=e.startOptions(this.startedContextAt-this.startedMashAt,this.quantize),{start:s,duration:n,offset:r}=i;if(console.log(this.constructor.name,"createSources",e.label,i,this.startedContextAt-this.startedMashAt,this.quantize),V.positive(s)&&V.aboveZero(n)){t.loop=e.definition.loops;const i=ft.audibleContext.createGain();t.connect(i),i.connect(ft.audibleContext.destination),t.start(s,r,n),this.sourcesByClip.set(e,{gainSource:t,gainNode:i}),this.adjustSourceGain(e)}return!0}))}destroySources(e=[]){const t=[...this.sourcesByClip.keys()].filter((t=>!e.includes(t)));t.forEach((e=>{const t=this.sourcesByClip.get(e);if(!t)return;const{gainSource:i,gainNode:s}=t;s.disconnect(ft.audibleContext.destination),i.disconnect(s)})),t.forEach((e=>this.sourcesByClip.delete(e)))}drawBackground(){ft.visibleContext.clear(),this.backcolor&&ft.visibleContext.drawFill(ze(this.backcolor))}get gain(){return this._gain}set gain(t){this._gain!==t&&(this._gain=t,this.playing&&[...this.sourcesByClip.keys()].forEach((e=>this.adjustSourceGain(e))),ft.audibleContext.emit(e.EventType.Volume))}get seconds(){return ft.audibleContext.currentTime-this.startedContextAt+this.startedMashAt}startContext(){if(this.bufferSource)throw g.internal+"bufferSource startContext";if(this.playing)throw g.internal+"playing";const e=ft.audibleContext.createBuffer(1);this.bufferSource=ft.audibleContext.createBufferSource(e),this.bufferSource.loop=!0,this.bufferSource.connect(ft.audibleContext.destination),this.bufferSource.start(0)}startPlaying(e,t){if(!this.bufferSource)throw g.internal+"bufferSource startPlaying";if(this.playing)throw g.internal+"playing";const{seconds:i}=e;return this.playing=!0,this.startedMashAt=i,this.startedContextAt=ft.audibleContext.currentTime,console.log(this.constructor.name,"startPlaying startedContextAt",this.startedContextAt),!!this.createSources(t)||(this.stopPlaying(),!1)}stopPlaying(){this.playing&&(this.playing=!1,this.bufferSource&&this.bufferSource.stop(),this.destroySources(),this.startedMashAt=0,this.startedContextAt=0,this.bufferSource&&(this.bufferSource.disconnect(ft.audibleContext.destination),delete this.bufferSource))}}class Js extends gt{constructor(...t){super(...t),this.audio=[],this._backcolor=u.mash.backcolor,this._buffer=u.mash.buffer,this.drawnSeconds=0,this._gain=u.mash.gain,this.loop=!1,this._paused=!0,this._playing=!1,this.quantize=u.mash.quantize,this.video=[],this._id||=Ie();const i=t[0]||{},{audio:s,backcolor:n,label:r,loop:o,media:a,quantize:c,video:l,buffer:h,gain:d}=i;"boolean"==typeof o&&(this.loop=o),c&&V.aboveZero(c)&&(this.quantize=c),r&&V.populatedString(r)&&(this.label=r),n&&V.populatedString(n)&&(this._backcolor=n),a&&a.forEach((e=>{const{id:t,type:i}=e;if(!i||!V.populatedString(i))throw g.type+"Mash.constructor media";const s=i;if(!B.includes(s))throw g.type+s;if(!t||!V.populatedString(t))throw g.invalid.definition.id+JSON.stringify(e);return Zi[s].definition(e)})),s?this.audio.push(...s.map(((t,i)=>new Us(this.trackOptions(t,i,e.TrackType.Audio))))):this.audio.push(new Us({type:e.TrackType.Audio})),l?this.video.push(...l.map(((t,i)=>new Us(this.trackOptions(t,i,e.TrackType.Video))))):this.video.push(new Us({type:e.TrackType.Video})),h&&V.aboveZero(h)&&(this.buffer=h),void 0!==d&&V.positive(d)&&(this._gain=d),this.setDrawInterval()}addClipsToTrack(e,t=0,i=0,s){this.assureClipsHaveFrames(e);const[n]=e,r=this.clipTrackAtIndex(n,t);if(!r)throw g.invalid.track;const o=V.positive(n.track)&&this.clipTrack(n);this.emitIfFramesChange((()=>{o&&o!==r&&o.removeClips(e),s&&e.forEach(((e,t)=>{e.frame=s[t]})),r.addClips(e,i)}))}addTrack(t){const i=this[t],s={type:t,index:i.length},n=new Us(s);return i.push(n),ft.audibleContext.emit(e.EventType.Track),n}assureClipsHaveFrames(e){e.filter((e=>!V.positive(e.frames))).forEach((e=>{const t=e.definition;e.frames=t.frames(this.quantize)}))}get backcolor(){return this._backcolor}set backcolor(e){this._backcolor=e,this._composition&&(this.composition.backcolor=e)}get buffer(){return this._buffer}set buffer(e){if(!V.aboveZero(e))throw g.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this._composition&&(this.composition.buffer=e))}get bufferFrames(){return this.buffer*this.quantize}bufferStart(){this._bufferTimer||(this._bufferTimer=setInterval((()=>{this.loadPromise}),Math.round(1e3*this.buffer/2)))}bufferStop(){this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer)}get bufferTime(){return $e.fromSeconds(this.buffer)}changeClipFrames(e,t){let i=Math.max(1,t);const s=e.maxFrames(this.quantize);V.aboveZero(s)&&(i=Math.min(s,i));const n=this.clipTrack(e);this.emitIfFramesChange((()=>{e.frames=i,n.sortClips(n.clips)}))}changeClipTrimAndFrames(e,t,i){let s=Math.max(0,t);const n=e.maxFrames(this.quantize,1);V.aboveZero(n)&&(s=Math.min(n,s));const r=i-s,o=this.clipTrack(e);this.emitIfFramesChange((()=>{e.trim=s,e.frames=r,o.sortClips(o.clips)}))}clearDrawInterval(){this.drawInterval&&(clearInterval(this.drawInterval),this.drawInterval=void 0)}clipIntersects(e,t){return e.timeRange(this.quantize).intersects(t)}clipTrack(e){return this.clipTrackAtIndex(e,e.track)}clipTrackAtIndex(e,t=0){return this.trackOfTypeAtIndex(e.trackType,t)}get clips(){return this.clipsInTracks()}clipsAtTimes(e,t){const i=this.clipsVisible(e,t);return t&&i.push(...this.clipsAudible(e,t)),[...new Set(i)]}clipsAudible(e,t){const i=t&&Le.fromTimes(e,t);return this.clipsAudibleInTracks.filter((t=>{const s=t.timeRange(this.quantize);return i?s.intersects(i):s.intersectsTime(e)}))}clipsInTracks(e){return(e||this.tracks).map((e=>e.clips)).flat()}filterIntersecting(e,t){const i=t.scale(this.quantize);return e.filter((e=>this.clipIntersects(e,i)))}get clipsAudibleInTracks(){return this.clipsInTracks().filter((e=>e.audible&&!e.muted))}clipsAudibleInTimeRange(e){return this.filterIntersecting(this.clipsAudibleInTracks,e)}get clipsVideo(){return this.video.flatMap((e=>e.clips))}clipsVisible(e,t){const i=t&&Le.fromTimes(e,t);return this.clipsVideo.filter((t=>{const s=t.timeRange(this.quantize);return i?s.intersects(i):s.intersectsTime(e)}))}clipsVisibleAtTime(e){return this.clipsVisibleInTimeRange(Le.fromTime(e))}clipsVisibleInTimeRange(e){const t=e.scale(this.quantize);return this.clipsVideo.filter((e=>this.clipIntersects(e,t)))}compositeAudible(e){const t=e||this.clipsAudibleInTimeRange(this.timeRangeToBuffer);return this.composition.compositeAudible(t)}compositeAudibleClips(e){if(this._paused)return;const t=e.filter((e=>e.audible&&!e.muted));t.length&&this.compositeAudible(t)}get composition(){if(!this._composition){const e={backcolor:this.backcolor,buffer:this.buffer,gain:this.gain,quantize:this.quantize};this._composition=new Bs(e)}return this._composition}compositeVisible(){const{time:e}=this;this.composition.compositeVisible(e,this.clipsVisibleAtTime(e))}compositeVisibleRequest(e){const{time:t,composition:i}=this;i.compositeVisibleRequest(t,e||this.clipsVisibleAtTime(t))}destroy(){this.paused=!0,this.clearDrawInterval(),delete this._composition}drawTime(t){const i=t!==this.time;this.drawnTime=t,this.compositeVisibleRequest(),ft.audibleContext.emit(i?e.EventType.Time:e.EventType.Loaded)}drawWhileNotPlaying(){const e=performance.now();if(e-this.drawnSeconds<1/this.quantize)return;this.drawnSeconds=e;const{time:t}=this,i=this.clipsVisible(t);if(!i.filter((e=>e.definition.streamable)).length)return;i.some((e=>e.clipUrls(this.quantize,t).some((e=>!ft.cached(e)))))||this.compositeVisibleRequest()}drawWhilePlaying(){const{seconds:t}=this.composition,i=this.time.withFrame(this.time.frame+1);if(t>=this.endTime.seconds)this.loop?this.seekToTime(this.time.withFrame(0)):(this.paused=!0,ft.audibleContext.emit(e.EventType.Ended));else if(t>=i.seconds){const e=$e.fromSeconds(t,this.time.fps),i=e.frame-this.time.frame;i>1&&console.debug(this.constructor.name,"drawWhilePlaying dropped frames",i-1),this.drawTime(e)}}get duration(){return this.endTime.seconds}emitIfFramesChange(t){const i=this.frames;t();const{frames:s}=this;i!==s&&(ft.audibleContext.emit(e.EventType.Duration),this.frame>s&&this.seekToTime($e.fromArgs(s,this.quantize)))}get endTime(){return $e.fromArgs(this.frames,this.quantize)}get frame(){return this.time.scale(this.quantize,"floor").frame}get frames(){return Math.max(0,...this.tracks.map((e=>e.frames)))}get gain(){return this._gain}set gain(e){if(!V.positive(e))throw g.invalid.argument+"gain "+e;this._gain!==e&&(this._gain=e,this.composition.gain=e)}handleAction(t){if(ft.audibleContext.emit(e.EventType.Action),t instanceof Xe){const e=t,{property:i}=e;if("gain"===i)return void(this.playing&&V.aboveZero(this.gain)&&this.composition.adjustSourceGain(e.target))}this.stopLoadAndDraw()}handleDrawInterval(){this._playing?this.drawWhilePlaying():this.drawWhileNotPlaying()}seqmentsAtTimes(e,t,i){const s=this.clipsAtTimes(t,i),n=t.scale(this.quantize);if(!i)return[{clips:s,timeRange:Le.fromTime(n)}];const r=[],o=i.scale(this.quantize),a=Le.fromTimes(n,o),{times:c}=a;let l,h="~";return c.forEach((e=>{const t=Le.fromTime(e),i=this.filterIntersecting(s,t),n=i.map((e=>e.identifier)).join("~");h===n?l.timeRange=l.timeRange.addFrames(1):(h=n,l={timeRange:t,clips:i},r.push(l))})),r}inputCommand(e,t,i){return this.seqmentsAtTimes(e,t,i).map((({clips:e,timeRange:t})=>({inputs:[]})))}inputCommandPromise(e,t,i){return new Promise((s=>{const n=this.clipsAtTimes(t,i).map((e=>e.loadClip(this.quantize,t,i))).filter(Boolean);n.length?Promise.all(n).then((()=>{s(this.inputCommand(e,t,i))})):s(this.inputCommand(e,t,i))}))}get loadPromise(){const[e,t]=this.startAndEnd,i=this.clipsAtTimes(e,t),s=i.map((i=>i.loadClip(this.quantize,e,t))).filter(Boolean);if(s.length)return Promise.all(s).then((()=>{this.compositeAudibleClips(i)}));this.compositeAudibleClips(i)}get loadUrls(){const[e,t]=this.startAndEnd;return this.clipsAtTimes(e,t).flatMap((i=>i.clipUrls(this.quantize,e,t)))}get loadedDefinitions(){const e=new Map,[t,i]=this.startAndEnd;return this.clipsAtTimes(t,i).forEach((s=>{const{definitions:n}=s,r=[s.definitionTime(this.quantize,t)];i&&r.push(s.definitionTime(this.quantize,i)),n.forEach((t=>{e.has(t)||e.set(t,[]);const i=e.get(t);if(!i)throw g.internal;i.push(r)}))})),e}maxTracks(e){return e?this[e].length:this.audio.length+this.video.length}get media(){return[...new Set(this.clipsInTracks().flatMap((e=>e.definitions)))]}get paused(){return this._paused}set paused(t){const i=t||!this.frames;if(this._paused!==i)if(this._paused=i,i)this.playing=!1,this.bufferStop(),this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer),ft.audibleContext.emit(e.EventType.Pause);else{this.composition.startContext(),this.bufferStart();const t=this.loadPromise;t?t.then((()=>{this.playing=!0})):this.playing=!0,ft.audibleContext.emit(e.EventType.Play)}}get playing(){return this._playing}set playing(t){if(this._playing!==t)if(this._playing=t,t){const t=this.clipsAudibleInTimeRange(this.timeRangeToBuffer);if(!this.composition.startPlaying(this.time,t))return void(this._playing=!1);ft.audibleContext.emit(e.EventType.Playing)}else this.composition.stopPlaying()}removeClipsFromTrack(e){const[t]=e,i=this.clipTrack(t);this.emitIfFramesChange((()=>{i.removeClips(e)}))}removeTrack(t){const i=this[t];this.emitIfFramesChange((()=>{i.pop()})),ft.audibleContext.emit(e.EventType.Track)}restartAfterStop(t,i,s){t===this.time&&(s&&(delete this.seekTime,ft.audibleContext.emit(e.EventType.Seeked)),this.drawTime(t),i||(this.composition.startContext(),this.playing=!0))}seekToTime(t){return this.seekTime!==t&&(this.seekTime=t,ft.audibleContext.emit(e.EventType.Seeking),ft.audibleContext.emit(e.EventType.Time)),this.stopLoadAndDraw(!0)}setDrawInterval(){this.clearDrawInterval(),this.drawInterval=setInterval((()=>{this.handleDrawInterval()}),500/this.time.fps)}get stalled(){return!this.paused&&!this.playing}get startAndEnd(){const{time:e}=this,t=[e];return this.paused||t.push(e.add(this.bufferTime)),t}stopLoadAndDraw(e){const{time:t,paused:i,playing:s}=this;s&&(this.playing=!1);const n=this.loadPromise;if(n)return n.then((()=>{this.restartAfterStop(t,i,e)}));this.restartAfterStop(t,i,e)}get time(){return this.seekTime||this.drawnTime||$e.fromArgs(0,this.quantize)}get timeRange(){return Le.fromTime(this.time,this.endTime.scale(this.time.fps).frame)}get timeRangeToBuffer(){const{time:e,quantize:t,buffer:i,paused:s}=this;if(s){return Le.fromArgs(e.scale(t,"floor").frame,t,1)}return Le.fromTimes(e,$e.fromSeconds(i+e.seconds,e.fps))}toJSON(){return{label:this.label,quantize:this.quantize,backcolor:this.backcolor||"",id:this.id,media:this.media,audio:this.audio,video:this.video}}trackOfTypeAtIndex(e,t=0){if(!V.positive(t))throw console.error(g.invalid.track,t,t?.constructor.name),g.invalid.track;return this[e][t]}trackOptions(e,t,i){const{clips:s}=e;if(!s||!V.populatedArray(s))return{type:i,index:t};const n=s.map((e=>{const{id:i}=e;if(!i)throw g.id;const s=me.fromId(i),n={track:t,...e};return s.instanceFromObject(n)}));return this.assureClipsHaveFrames(n),{type:i,index:t,clips:n}}get tracks(){return Object.values(e.TrackType).map((e=>this[e])).flat()}}class $s extends yt{constructor(...t){super(...t),this.id="com.moviemasher.mash.default",this.retain=!0,this.type=e.DefinitionType.Mash,this.properties.push(new ge({name:"backcolor",type:e.DataType.Rgba,value:"#00000000"})),me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Js({...this.instanceObject,...e})}}const Ls="com.moviemasher.mash.default",Zs=e=>{const{id:t}=e,i=t&&V.populatedString(t)&&me.installed(t)?t:Ls;return me.fromId(i)},Ws=e=>Zs({id:e}),Ks=e=>Zs(e).instanceFromObject(e),Gs=e=>Ks({id:e}),Hs=()=>{new $s({id:Ls})},Xs=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),Zs(e)},Ys=e=>{const t=Xs(e);return t.retain=!0,t},Qs={define:Xs,install:Ys,definition:Zs,definitionFromId:Ws,fromId:Gs,initialize:Hs,instance:Ks};Vt[e.DefinitionType.Mash]=Qs;const en={AddTrack:He,AddClipsToTrack:it,MoveClips:st,AddEffect:tt,Change:Xe,ChangeFrames:Qe,ChangeTrim:et,Split:rt,Freeze:Ye,MoveEffects:ot,RemoveClips:nt};const tn=new class{createFromObject(e){const{type:t}=e;if("string"!=typeof t)throw g.type+JSON.stringify(e);return new(en[ye(t)])(e)}};class sn extends gt{constructor(...e){super(...e),this.autoplay=u.masher.autoplay,this._buffer=u.masher.buffer,this._fps=u.masher.fps,this._loop=u.masher.loop,this._muted=!1,this._paused=!0,this.precision=u.masher.precision,this.selectedClipObject={},this._selectedClips=[],this._selectedEffects=[],this._volume=u.masher.volume,this._id||=Ie();const[t]=e,{autoplay:i,precision:s,loop:n,fps:r,volume:o,buffer:a,mash:c}=t;void 0!==i&&(this.autoplay=i),void 0!==s&&(this.precision=s),void 0!==n&&(this._loop=n),void 0!==r&&(this._fps=r),void 0!==o&&(this._volume=o),void 0!==a&&(this._buffer=a),c&&(this.mash=c)}actionCreate(e){const t=e.mash||this.mash,i=e.actions||this.actions,s=e.undoSelectedClips||this.selectedClips,n=e.undoSelectedEffects||this.selectedEffects,r=e.redoSelectedClips||this.selectedClips,o=e.redoSelectedEffects||this.selectedEffects,a={...e,actions:i,mash:t,undoSelectedClips:s,undoSelectedEffects:n,redoSelectedClips:r,redoSelectedEffects:o},c=tn.createFromObject(a);this.actions.add(c),this.handleAction(this.actions.redo())}get actions(){return this._actions||(this._actions=new at({mash:this.mash})),this._actions}add(t,i=0,s=0){if(!V.populatedObject(t))throw g.argument+"add";const{id:n}=t,r=!(!n||!me.installed(n))&&me.fromId(n),o=t.type||r&&r.type;if(!o)throw g.type+"Masher.add "+n+JSON.stringify(r);if(o===e.DefinitionType.Effect){const e=Zi.effect.definition(t).instance;return this.addEffect(e,i).then((()=>e))}const a=o;if(!q.includes(a))throw g.type+o;const c=Zi[o].definition(t).instanceFromObject(t);return this.addClip(c,i,s).then((()=>c))}addClip(t,i=0,s=0){const{trackType:n}=t,r=[t],o={clip:t,type:e.ActionType.AddClipsToTrack,redoSelectedClips:r,trackType:n},a=this.mash.trackOfTypeAtIndex(n,s),c=this.mash[n].length;return a.isMainVideo?(o.insertIndex=i,o.createTracks=Math.min(1,Math.max(0,1-c))):(o.trackIndex=s,t.frame=a.frameForClipsNearFrame(r,i),o.createTracks=Math.max(0,s+1-c)),this.actionCreate(o),this.loadMashAndDraw()}addEffect(t,i=0){const{effects:s}=this.selectedClipOrThrow;if(!s)throw g.selection;const n=[...s],r=[...s],o=[t];r.splice(i,0,t);const a={effects:s,undoEffects:n,redoEffects:r,redoSelectedEffects:o,type:e.ActionType.MoveEffects};return this.actionCreate(a),this.loadMashAndDraw()}addTrack(t=e.TrackType.Video){this.actionCreate({trackType:t,type:e.ActionType.AddTrack})}get buffer(){return this._buffer}set buffer(e){const t=Number(e);this._buffer!==t&&(this._buffer=t,this.mash.buffer=t)}can(t){const i=this._selectedClips.length;switch(t){case"save":return this.actions.canSave;case"undo":return this.actions.canUndo;case"redo":return this.actions.canRedo;case"copy":return i>0;case"cut":case"remove":return!!i;case"split":return 1===i&&this.clipCanBeSplit(this.selectedClipOrThrow,this.time,this.mash.quantize);case"freeze":return 1===i&&e.DefinitionType.Video===this.selectedClipOrThrow.type&&this.clipCanBeSplit(this.selectedClipOrThrow,this.time,this.mash.quantize);default:throw g.argument}}change(e,t){V.populatedObject(this.selectedClip)?V.populatedObject(this.selectedEffect)?this.changeEffect(e,t,this.selectedEffect):this.changeClip(e,t,this.selectedClipOrThrow):this.changeMash(e,t)}changeClip(t,i,s){if(!V.populatedString(t))throw g.property+"changeClip "+t;const[n,r]=t.split(".");if(r)return void this.changeTransformer(n,r,i);const o=s||this.selectedClipOrThrow,a=void 0===i?o.value(t):i;if(this.currentActionReusable(o,t)){const e=this.actions.currentAction;return e.updateAction(a),void this.handleAction(e)}const c=void 0===i?this.pristineOrThrow[t]:o.value(t),l={property:t,target:o,redoValue:a,undoValue:c};switch(l.property){case"frames":l.type=e.ActionType.ChangeFrames;break;case"trim":l.type=e.ActionType.ChangeTrim,l.frames=o.frames+l.undoValue;break;default:l.type=e.ActionType.Change}this.actionCreate(l)}changeEffect(t,i,s){if(!V.populatedString(t))throw g.property;const n=s||this.selectedEffectOrThrow,r=void 0===i?n.value(t):i;if(this.currentActionReusable(n,t)){const e=this.actions.currentAction;return e.updateAction(r),void this.handleAction(e)}const o=void 0===i?this.pristineEffectOrThrow[t]:n.value(t),a={type:e.ActionType.Change,target:n,property:t,redoValue:r,undoValue:o};this.actionCreate(a)}changeMash(t,i){if(!this.mash.propertyNames.includes(t))throw g.unknownMash;if(!this._pristine)throw g.internal;const s=this.mash,n=void 0===i?s.value(t):i;if(this.currentActionReusable(s,t)){const e=this.actions.currentAction;return e.updateAction(n),void this.handleAction(e)}const r=void 0===i?this._pristine[t]:s.value(t),o={target:s,property:t,redoValue:n,undoValue:r,type:e.ActionType.Change};this.actionCreate(o)}changeTransformer(t,i,s){if(!V.populatedString(t))throw g.type+"changeTransformer "+t;if(!V.populatedString(i))throw g.property+"changeTransformer "+i;if(!this._pristine)throw g.internal+"changeTransformer _pristine";const n=t,r=this.selectedClipOrThrow;if(!Y.includes(n))throw g.property+"type "+t;const o=r[n],a=void 0===s?o.value(i):s,c=this._pristine[n];if("object"!=typeof c)throw g.internal+JSON.stringify(this._pristine);const l=c[i];if(void 0===l)throw g.property+"pristine "+i+JSON.stringify(c);const h={property:i,target:o,redoValue:a,undoValue:l,type:e.ActionType.Change};if(this.currentActionReusable(o,i)){const e=this.actions.currentAction;return e.updateAction(a),void this.handleAction(e)}this.actionCreate(h)}get clip(){return V.populatedObject(this.selectedClip)?this.selectedClip:void 0}set clip(e){this.selectedClips=e?[e]:[]}clipCanBeSplit(e,t,i){if(!V.object(e))return!1;const s=Le.fromTime(t),n=e.timeRange(i);if(!n.intersects(s))return!1;const r=s.scale(n.fps);return r.frame!==n.frame&&r.end!==n.end}get clips(){return this.mash.clips}currentActionReusable(e,t){if(!this.actions.currentActionLast)return!1;const i=this.actions.currentAction;return i instanceof Xe&&(i.target===e&&i.property===t)}get currentTime(){return this.mash.drawnTime?this.mash.drawnTime.seconds:0}get definitions(){return this.mash.media}destroy(){Zi.masher.destroy(this)}get duration(){return this.mash.duration}get effect(){return V.populatedObject(this.selectedEffect)?this.selectedEffect:void 0}set effect(e){this.selectedEffects=e?[e]:[]}get endTime(){return this.mash.endTime.scale(this.fps,"floor")}get eventTarget(){return ft.audibleContext.context}filterClipSelection(t){const i=Array.isArray(t)?t:[t],[s]=i;if(!s)return[];const{trackType:n,track:r}=s,o=i.filter((e=>e.track===r&&e.trackType===n)).sort(Re);if(r||n===e.TrackType.Audio)return o;let a=!0;return o.filter(((e,t)=>!!a&&(t===o.length-1||(a=e.frame+e.frames===o[t+1].frame),!0)))}get fps(){return this._fps||this.mash.quantize}set fps(t){const i=Number(t);this._fps!==i&&(this._fps=i,ft.audibleContext.emit(e.EventType.Fps),this.time=this.time.scale(this.fps))}get frame(){return this.time.frame}set frame(e){this.goToTime($e.fromArgs(Number(e),this.fps))}get frames(){return this.endTime.frame}freeze(){const t=this.selectedClipOrThrow;if(!this.clipCanBeSplit(t,this.time,this.mash.quantize))throw g.invalid.action;if(e.DefinitionType.Video!==t.type)throw g.invalid.action;const i=t,s=this.time.scale(this.mash.quantize),n=this.mash.clipTrack(i).clips,r=i.copy,o=i.copy,a={frames:i.frames-(s.frame-i.frame),freezeClip:i,frozenClip:o,insertClip:r,trackClips:n,redoSelectedClips:[o],index:1+n.indexOf(i),type:e.ActionType.Freeze};o.frame=s.frame,o.frames=1,o.trim=i.trim+(s.frame-i.frame),r.frame=s.frame+1,r.frames=a.frames-1,r.trim=o.trim+1,this.actionCreate(a)}get gain(){return this.muted?0:this.volume}goToTime(e){const{fps:t}=this,i=(e?e.scaleToFps(t):$e.fromArgs(0,t)).min(this.endTime);if(e&&i.equalsTime(this.time))return Promise.resolve();const s=this.mash.seekToTime(i);return s||Promise.resolve()}handleAction(e){this.mash.handleAction(e),this.selectedClips=e.selectedClips,this.selectedEffects=e.selectedEffects}get imageData(){return ft.visibleContext.imageData}get imageSize(){return ft.visibleContext.size}set imageSize(e){const{width:t,height:i}=e;if(!V.aboveZero(t)||!V.aboveZero(i))throw g.invalid.size;ft.visibleContext.size=e,this.loadMashAndDraw()}isSelected(e){return e instanceof Di?this.selectedEffects.includes(e):this.selectedClips.includes(e)}loadMashAndDraw(){const e=this.mash.loadPromise;return e?e.then((()=>{this.mash.compositeVisible()})):(this.mash.compositeVisible(),Promise.resolve())}get loadedDefinitions(){return this.mash.loadedDefinitions}get loop(){return this._loop}set loop(e){const t=!!e;this._loop=t,this._mash&&(this.mash.loop=t)}get mash(){return this._mash||(this._mash=Zi.mash.instance(this.mashOptions())),this._mash}set mash(t){this._mash!==t&&(console.log(this.constructor.name,"mash=",t.identifier),this.paused=!0,this._mash&&this._mash.destroy(),this._selectedEffects=[],this._mash=t,this._mash.buffer=this.buffer,this._mash.gain=this.gain,this._mash.loop=this.loop,this._actions&&(this._actions.destroy(),this._actions.mash=this._mash),this.selectedClips=[],ft.audibleContext.emit(e.EventType.Mash),ft.audibleContext.emit(e.EventType.Track),ft.audibleContext.emit(e.EventType.Duration),ft.audibleContext.emit(e.EventType.Action),this.goToTime(),this.autoplay&&(this.paused=!1))}mashOptions(e={}){return{...e,buffer:this.buffer,gain:this.gain,loop:this.loop}}move(t,i,s=0,n=0){if(!V.object(t))throw g.argument+"move";i!==e.MoveType.Effect?this.moveClips(t,s,n):this.moveEffects(t,s)}moveClips(t,i=0,s=0){if(!V.positive(i))throw g.argument+"moveClips frameOrIndex";if(!V.positive(s))throw g.argument+"moviClips trackIndex";const n=this.filterClipSelection(t);if(!V.populatedArray(n))throw g.argument+"moveClips clips";const[r]=n,{trackType:o,track:a}=r,c={clips:n,trackType:o,trackIndex:s,undoTrackIndex:a,type:e.ActionType.MoveClips},l=this.mash.trackOfTypeAtIndex(o,s),h=this.mash.trackOfTypeAtIndex(o,a),d=l.clips.indexOf(r);if(l.isMainVideo&&(c.insertIndex=i),h.isMainVideo&&(c.undoInsertIndex=d,i<d&&(c.undoInsertIndex+=n.length)),!l.isMainVideo||!h.isMainVideo){const e=n.map((e=>e.frame)),t=l.frameForClipsNearFrame(n,i)-r.frame;if(!t)return;c.undoFrames=e,c.redoFrames=e.map((e=>e+t))}this.actionCreate(c)}moveEffects(t,i=0){if(!V.positive(i))throw g.argument;const s=(Array.isArray(t)?t:[t]).filter((e=>e instanceof Di));if(!V.populatedArray(s))throw g.argument;const{effects:n}=this.selectedClipOrThrow,r=[...n],o=[];r.forEach(((e,t)=>{t===i&&o.push(...s),s.includes(e)||o.push(e)}));const a={effects:n,undoEffects:r,redoEffects:o,type:e.ActionType.MoveEffects};this.actionCreate(a)}get muted(){return this._muted}set muted(e){const t=!!e;this._muted!==t&&(this._muted=t,this.mash.gain=this.gain)}pause(){this.paused=!0}get paused(){return this.mash.paused}set paused(e){this._mash&&(this.mash.paused=!!e)}play(){this.paused=!1}get position(){let e=0;return this.time.frame&&(e=this.time.seconds/this.duration,1!==e&&(e=parseFloat(e.toFixed(this.precision)))),e}set position(e){this.goToTime($e.fromSeconds(this.duration*Number(e),this.fps))}get positionStep(){return parseFloat(`0.${"0".repeat(this.precision-1)}1`)}get pristineOrThrow(){if(!this._pristine)throw g.internal;return this._pristine}get pristineEffectOrThrow(){if(!this._pristineEffect)throw g.internal;return this._pristineEffect}redo(){this.actions.canRedo&&this.handleAction(this.actions.redo())}remove(t,i){if(!V.object(t))throw g.argument;i!==e.MoveType.Effect?this.removeClips(t):this.removeEffects(t)}removeClips(t){const i=this.filterClipSelection(t);if(!V.populatedArray(i))throw g.argument;const[s]=i,n=this.mash.clipTrack(s),r={redoSelectedClips:[],clips:i,track:n,index:n.clips.indexOf(s),type:e.ActionType.RemoveClips};this.actionCreate(r)}removeEffects(t){const i=(Array.isArray(t)?t:[t]).filter((e=>e instanceof Di));if(!V.populatedArray(i))throw g.argument;const{effects:s}=this.selectedClipOrThrow,n=[...s],r=s.filter((e=>!i.includes(e))),o={redoSelectedEffects:[],effects:s,undoEffects:n,redoEffects:r,type:e.ActionType.MoveEffects};this.actionCreate(o)}save(){this.actions.save()}select(t,i){if(!t)return void(this.selectedClips=[]);if(t instanceof Di)return void this.selectEffect(t,i);const{type:s}=t;s!==e.DefinitionType.Mash?this.selectClip(t,i):this.selectMash()}get selectedClipsOrEffects(){return this.selectedEffects.length?this.selectedEffects:this.selectedClips}selectClip(e,t){const i=[];if(e)if(t){i.push(...this.selectedClips);const t=this.selectedClips.indexOf(e);t>-1?i.splice(t,1):i.push(e)}else this.selectedClips.includes(e)?i.push(...this.selectedClips):i.push(e);this.selectedClips=i}selectEffect(e,t){const i=[];if(e)if(t){i.push(...this.selectedEffects);const t=this.selectedEffects.indexOf(e);t>-1?i.splice(t,1):i.push(e)}else i.push(e);this.selectedEffects=i}selectMash(){this.selectedClips=[]}get selected(){const e=this.selectedEffect;return V.populatedObject(e)?e:this.selectedClipOrMash}get selectedClip(){return 1===this._selectedClips.length?this.selectedClipOrThrow:this.selectedClipObject}set selectedClip(e){if(e&&V.populatedObject(e)){const t=e,{type:i}=t,s=String(i);if(!q.includes(s))return;this.selectedClips=[t]}else this.selectedClips=[]}get selectedClipOrMash(){const e=this.selectedClip;return V.populatedObject(e)?this.selectedClipOrThrow:this.mash}get selectedClipOrThrow(){const e=this._selectedClips[0];if(!e)throw g.selection;return e}get selectedClips(){return this._selectedClips}set selectedClips(t){const i=this.filterClipSelection(t),s=this.selectedClipOrMash.propertyValues;this._selectedClips!==i&&(this._selectedClips=i,this._pristine=s,this.selectedEffects.length?this.selectedEffects=[]:ft.audibleContext.emit(e.EventType.Selection))}get selectedEffect(){return 1!==this._selectedEffects.length?{}:this._selectedEffects[0]}set selectedEffect(t){if(t&&V.populatedObject(t)){const i=t,{type:s}=i;if(s!==e.DefinitionType.Effect)return;this.selectedEffects=[i]}else this.selectedEffects=[]}get selectedEffectOrThrow(){const e=this.selectedEffect;if(!V.populatedObject(e))throw g.selection;return e}get selectedEffects(){return this._selectedEffects}set selectedEffects(t){const i=[],s={};if(t.length){const{effects:e}=this.selectedClipOrMash;if(e){const n=e;i.push(...t.filter((e=>n.includes(e)))),1===i.length&&Object.assign(s,i[0].propertyValues)}}this._selectedEffects!==i&&(this._selectedEffects=i,this._pristineEffect=s,ft.audibleContext.emit(e.EventType.Selection))}get selectionObjects(){return this.selectedClipsOrEffects.map((e=>e.propertyValues))}split(){const t=this.selectedClipOrThrow;if(!this.clipCanBeSplit(t,this.time,this.mash.quantize))throw g.invalid.action;const i=this.time.scale(this.mash.quantize),s=t.frames,n=i.frame-t.frame,r=t.copy;r.frames=s-n,r.frame=i.frame,t.propertyNames.includes("trim")&&(r.trim+=n);const o=this.mash.clipTrack(t).clips,a={type:e.ActionType.Split,splitClip:t,insertClip:r,trackClips:o,redoFrames:n,undoFrames:s,index:1+o.indexOf(t),redoSelectedClips:[r],undoSelectedClips:[t]};this.actionCreate(a)}get time(){return this.mash.time}set time(e){this.goToTime(e)}get timeRange(){return this.mash.timeRange}undo(){this.actions.canUndo&&this.handleAction(this.actions.undo())}get volume(){return this._volume}set volume(e){const t=Number(e);if(this._volume!==t){if(!V.positive(t))throw g.invalid.volume;this._volume=t,V.aboveZero(t)&&(this.muted=!1),this.mash.gain=this.gain}}}class nn extends yt{constructor(...t){super(...t),this.id="com.moviemasher.masher.default",this.retain=!0,this.type=e.DefinitionType.Masher,this.properties.push(new ge({name:"autoplay",type:e.DataType.Boolean,value:u.masher.autoplay})),this.properties.push(new ge({name:"precision",type:e.DataType.Number,value:u.masher.precision})),this.properties.push(new ge({name:"loop",type:e.DataType.Boolean,value:u.masher.loop})),this.properties.push(new ge({name:"fps",type:e.DataType.Number,value:u.masher.fps})),this.properties.push(new ge({name:"volume",type:e.DataType.Number,value:u.masher.volume})),this.properties.push(new ge({name:"buffer",type:e.DataType.Number,value:u.masher.buffer})),me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new sn({...this.instanceObject,...e})}}const rn="com.moviemasher.masher.default";let on;const an=[],cn=e=>{const t=an.indexOf(e);t<0||(an.splice(t,1),an.length||hn())},ln=()=>{on||(on=setInterval((()=>(()=>{const e=an.flatMap((e=>e.mash.loadUrls));ft.flush(e);const t=an.flatMap((e=>e.mash.media));me.map.forEach((e=>{t.includes(e)||e.retain||me.uninstall(e.id)}))})()),1e4))},hn=()=>{on&&(clearInterval(on),on=void 0)},dn=e=>{const{id:t}=e,i=t&&V.populatedString(t)&&me.installed(t)?t:rn;return me.fromId(i)},un=e=>dn({id:e}),mn=(e={})=>{const t=dn(e).instanceFromObject(e);var i;return i=t,an.length||ln(),an.push(i),t},fn=e=>mn({id:e}),pn=()=>{new nn({id:rn})},gn=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.invalid.definition.id+"masherDefine";return me.uninstall(t),dn(e)},yn={define:gn,install:gn,definition:dn,definitionFromId:un,destroy:cn,fromId:fn,initialize:pn,instance:mn};Vt[e.DefinitionType.Masher]=yn;const vn=Fs(_s(bt(Ii(gt))));class bn extends vn{contextAtTimeToSize(e,t,i){const s=mt.toSize(i),n=this.timeRangeRelative(e,t);return this.definition.drawFilters(this,n,s,i)}clipUrls(e,t){const i=super.clipUrls(e,t);return i.push(...this.modularUrls(e,t)),i}loadClip(e,t,i){const s=[],n=super.loadClip(e,t,i);n&&s.push(n);const r=this.loadModular(e,t,i);switch(r&&s.push(r),s.length){case 0:return;case 1:return s[0];default:return Promise.all(s).then()}}}const wn=Ds(St(_i(yt)));class Tn extends wn{constructor(...t){super(...t),this.type=e.DefinitionType.Theme,me.install(this)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){const t={...this.instanceObject,...e};return new bn(t)}}var xn={label:"Color",type:"theme",id:"com.moviemasher.theme.color",properties:{color:{type:"rgb",value:"#FFFF00"}},filters:[{id:"color"}]};var Cn={label:"Text",type:"theme",id:"com.moviemasher.theme.text",properties:{string:{type:"string",value:"Text"},size:{type:"fontsize",value:.3},x:{type:"number",value:0},y:{type:"number",value:0},color:{type:"rgba",value:"rgba(255,0,0,1)"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},background:{type:"rgba",value:"rgba(0,0,0,0)"},fontface:{type:"font",value:"com.moviemasher.font.default"}},filters:[{id:"color",parameters:[{name:"color",value:"background"},{name:"size",value:"mm_dimensions"},{name:"duration",value:"mm_duration"},{name:"rate",value:"mm_fps"}]},{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]};const Sn=t=>{const{id:i}=t;if(!i||!V.populatedString(i))throw g.id;return me.installed(i)?me.fromId(i):new Tn({...t,type:e.DefinitionType.Theme})},Fn=e=>Sn({id:e}),_n=e=>Sn(e).instanceFromObject(e),In=e=>_n({id:e}),An=()=>{new Tn(xn),new Tn(Cn)},Dn=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),Sn(e)},kn={define:Dn,install:Dn,definition:Sn,definitionFromId:Fn,fromId:In,initialize:An,instance:_n};Vt[e.DefinitionType.Theme]=kn;const On=_s(bt(Ii(gt)));class Mn extends On{constructor(){super(...arguments),this.trackType=e.TrackType.Video}contextAtTimeToSize(e,t,i){}mergeClipsIntoContextAtTime(e,t,i,s,n){V.aboveZero(e.length)&&this.definition.drawVisibleFilters(e,this,i,s,t,n)}}const En=Ds(St(_i(yt)));class zn extends En{constructor(...t){super(...t),this.fromFilters=[],this.fromMerger=rs({}),this.fromScaler=ws({}),this.toFilters=[],this.toMerger=rs({}),this.toScaler=ws({}),this.type=e.DefinitionType.Transition;const[i]=t,{to:s,from:n}=i;if(s){const{filters:e,merger:t,scaler:i}=s;e&&this.toFilters.push(...e.map((e=>Ti(e)))),t&&(this.toMerger=rs(t)),i&&(this.toScaler=ws(i))}if(n){const{filters:e,merger:t,scaler:i}=n;e&&this.fromFilters.push(...e.map((e=>Ti(e)))),t&&(this.fromMerger=rs(t)),i&&(this.fromScaler=ws(i))}me.install(this)}drawVisibleFilters(e,t,i,s,n,r){const{size:o}=n,a=[...e].sort(Re);let c=a[0],l=a[1];!l&&c.frame>=t.frame&&(l=c,c=void 0);let h=mt.toSize(o),d=mt.toSize(o);r&&(h.drawFill(r),d.drawFill(r));const u=t.timeRangeRelative(i,s);c&&c.mergeContextAtTime(i,s,h),this.filters=this.fromFilters,h=this.drawFilters(t,u,h,o),l&&l.mergeContextAtTime(i,s,d),this.filters=this.toFilters,d=this.drawFilters(t,u,d,o),h=this.fromScaler.definition.drawFilters(this.fromScaler,u,h,o),this.fromMerger.definition.drawFilters(this.fromMerger,u,h,o,n),d=this.toScaler.definition.drawFilters(this.toScaler,u,d,o),this.toMerger.definition.drawFilters(this.toMerger,u,d,o,n)}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new Mn({...this.instanceObject,...e})}toJSON(){return{...super.toJSON(),to:{filters:this.toFilters},from:{filters:this.fromFilters}}}}var Vn={label:"Crossfade",type:"transition",id:"com.moviemasher.transition.crossfade",to:{filters:[{id:"fade",parameters:[{name:"alpha",value:"1"},{name:"type",value:"in"},{name:"duration",value:"mm_duration"}]}]}};const jn=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.installed(t)?me.fromId(t):new zn(e)},Nn=e=>jn({id:e}),Pn=e=>jn(e).instanceFromObject(e),Rn=e=>Pn({id:e}),qn=()=>{jn(Vn)},Un=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),jn(e)},Bn={define:Un,install:Un,definition:jn,definitionFromId:Nn,fromId:Rn,initialize:qn,instance:Pn};Vt[e.DefinitionType.Transition]=Bn;const Jn=Fs(_s(wt(vt(bt(gt))))),$n=class extends Jn{constructor(...e){super(...e),this.speed=u.instance.video.speed;const[t]=e,{speed:i}=t;i&&V.aboveZero(i)&&(this.speed=i)}get copy(){return super.copy}definitionTime(e,t){const i=super.definitionTime(e,t);return this.speed===u.instance.video.speed?i:i.divide(this.speed)}toJSON(){const e=super.toJSON();return this.speed!==u.instance.video.speed&&(e.speed=this.speed),e}},Ln=Ds(Mt(Ot(St(yt)))),Zn=class extends Ln{constructor(...t){super(...t),this.fps=u.definition.video.fps,this.pattern="%.jpg",this.source="",this.trackType=e.TrackType.Video,this.type=e.DefinitionType.Video;const[i]=t,{url:s,fps:n,source:r}=i;if(!s)throw g.invalid.definition.url;this.url=s,r&&(this.source=r),n&&(this.fps=n),this.properties.push(new ge({name:"speed",type:e.DataType.Number,value:1})),me.install(this)}get absoluteUrl(){return We(this.url)}get cachedOrThrow(){const e=ft.get(this.absoluteUrl);if(!e)throw g.internal;return e}definitionUrls(e,t){return[this.absoluteUrl]}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new $n({...this.instanceObject,...e})}framePromise(e,t){const{video:i,sequence:s}=t,n=s[e.frame];if(n instanceof Promise)return n;if(n)return Promise.resolve();const r=this.seekPromise(e,i).then((()=>{if(s[e.frame]&&!(s[e.frame]instanceof Promise))return void console.debug(this.constructor.name,"framePromise already captured",e.toString());const t=mt.toSize(i);t.draw(i),s[e.frame]=t.canvas,console.debug(this.constructor.name,"framePromise capturing",e.toString())}));return s[e.frame]=r,r}needTimes(e,t,i){const{sequence:s}=e;return(i?Le.fromTimes(t,i).times:[t]).filter((e=>!s[e.frame]||s[e.frame]instanceof Promise))}framesPromise(e,t){const i=this.cachedOrThrow,s=this.needTimes(i,e,t);return this.timesPromise(s)}timesPromise(e){if(!e.length)return Promise.resolve();const t=this.cachedOrThrow,i=e.shift();if(!i)throw g.internal;let s=this.framePromise(i,t);return e.forEach((e=>{s=s.then((()=>this.framePromise(e,t)))})),s}loadDefinition(e,t,i){const s=this.fps||e,n=t.scale(s),r=i?i.scale(s):i,o=this.absoluteUrl;if(ft.cached(o)){const e=this.cachedOrThrow,t=this.needTimes(e,n,r);if(!t.length)return;return console.debug(this.constructor.name,"loadDefinition cached and returning promises",t.join(", ")),this.timesPromise(t)}const a=ft.caching(o)?ft.get(o):kt.video().loadUrl(o);return ft.caching(o)?console.debug(this.constructor.name,"loadDefinition caching and returning framesPromise",n,r):console.debug(this.constructor.name,"loadDefinition uncached and returning framesPromise",n,r),a.then((()=>this.framesPromise(n,r)))}loadedAudible(){const e=ft.get(this.absoluteUrl);if(!e)return;const{audio:t}=e;return ft.audibleContext.createBufferSource(t)}loadedVisible(e,t){const i=this.fps||e,s=t.scale(i);console.debug(this.constructor.name,"loadedVisible",s.toString(),t.toString());const n=ft.get(this.absoluteUrl);if(!n)return void console.debug(this.constructor.name,"loadedVisible no cached");const{sequence:r}=n,o=r[s.frame];if(o&&!(o instanceof Promise))return o;console.debug(this.constructor.name,"loadedVisible source issue",o)}seek(e,t){if(!t)throw g.internal;t.currentTime=e.seconds}seekNeeded(e,t){const{currentTime:i}=t;return!$e.fromSeconds(i,e.fps).equalsTime(e)}seekPromise(e,t){return new Promise((i=>{if(!this.seekNeeded(e,t))return i();t.onseeked=()=>{t.onseeked=null,i()},this.seek(e,t)}))}toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),this.fps!==u.definition.video.fps&&(e.fps=this.fps),e}unload(e){}},Wn=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.installed(t)?me.fromId(t):new Zn(e)},Kn=e=>Wn({id:e}),Gn=e=>Wn(e).instanceFromObject(e),Hn=e=>Gn({id:e}),Xn=()=>{},Yn=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),Wn(e)},Qn=e=>{const t=Yn(e);return t.retain=!0,t},er={define:Yn,install:Qn,definition:Wn,definitionFromId:Kn,fromId:Hn,initialize:Xn,instance:Gn};Vt[e.DefinitionType.Video]=er;const tr=vt(bt(gt));var ir;const sr=Fs(_s((ir=tr,class extends ir{constructor(...e){super(...e);const[t]=e,{something:i}=t;i&&(this.something=i)}maxFrames(e,t){return 0}toJSON(){const e=super.toJSON();return this.something&&(e.something=this.something),e}})));class nr extends sr{constructor(...e){super(...e)}get copy(){return super.copy}toJSON(){return super.toJSON()}}const rr=function(e){return class extends e{constructor(...e){super(...e),this.format="hls",this.streamable=!0;const[t]=e,{format:i}=t;i&&(this.format=i)}toJSON(){const e=super.toJSON();return e.format=!0,e}}}(Ds(Ot(St(yt))));class or extends rr{constructor(...t){super(...t),this.source="",this.trackType=e.TrackType.Video,this.type=e.DefinitionType.VideoStream;const[i]=t,{url:s,source:n}=i;if(!s)throw g.invalid.definition.url;this.url=s,n&&(this.source=n),me.install(this)}get absoluteUrl(){return We(this.url)}frames(e){return $e.fromSeconds(u.definition.videostream.duration,e,"floor").frame}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new nr({...this.instanceObject,...e})}loadDefinition(){const e=this.absoluteUrl;if(!ft.cached(e))return ft.caching(e)?ft.get(e):kt.video().loadUrl(e)}definitionUrls(e,t){return[this.absoluteUrl]}loadedVisible(){return ft.get(this.absoluteUrl)}toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),e}unload(e){!e&&ft.cached(this.url)&&ft.remove(this.url)}}const ar=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.installed(t)?me.fromId(t):new or(e)},cr=e=>ar({id:e}),lr=e=>ar(e).instanceFromObject(e),hr=e=>lr({id:e}),dr=()=>{},ur=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),ar(e)},mr=e=>{const t=ur(e);return t.retain=!0,t},fr={define:ur,install:mr,definition:ar,definitionFromId:cr,fromId:hr,initialize:dr,instance:lr};Vt[e.DefinitionType.VideoStream]=fr;const pr=Fs(_s(wt(vt(bt(gt)))));class gr extends pr{constructor(...e){super(...e),this.speed=u.instance.video.speed;const[t]=e,{speed:i}=t;i&&V.aboveZero(i)&&(this.speed=i)}get copy(){return super.copy}definitionTime(e,t){const i=super.definitionTime(e,t);return this.speed===u.instance.video.speed?i:i.divide(this.speed)}toJSON(){const e=super.toJSON();return this.speed!==u.instance.video.speed&&(e.speed=this.speed),e}}const yr=Ds(Mt(Ot(St(yt))));class vr extends yr{constructor(...t){super(...t),this.begin=u.definition.videosequence.begin,this.fps=u.definition.videosequence.fps,this.increment=u.definition.videosequence.increment,this.pattern="%.jpg",this.source="",this.trackType=e.TrackType.Video,this.type=e.DefinitionType.VideoSequence;const[i]=t,{padding:s,url:n,begin:r,fps:o,increment:a,pattern:c,source:l}=i;if(!n)throw g.invalid.definition.url;if(this.url=n,l&&(this.source=l),void 0!==r&&(this.begin=r),o&&(this.fps=o),a&&(this.increment=a),c&&(this.pattern=c),s)this.padding=s;else{const e=this.begin+(this.increment*this.framesMax-this.begin);this.padding=String(e).length}this.properties.push(new ge({name:"speed",type:e.DataType.Number,value:1})),me.install(this)}definitionUrls(e,t){return this.framesArray(e,t).map((e=>this.urlForFrame(e)))}framesArray(e,t){const i=[],s=Math.min(this.framesMax,e.scale(this.fps,"floor").frame);if(t){const e=Math.min(this.framesMax,t.scale(this.fps,"ceil").frame);for(let t=s;t<=e;t+=1)i.push(t)}else i.push(s);return i}get framesMax(){return Math.floor(this.fps*this.duration)-2}get instance(){return this.instanceFromObject(this.instanceObject)}instanceFromObject(e){return new gr({...this.instanceObject,...e})}loadDefinition(e,t,i){const s=[],n=i?super.loadDefinition(e,t,i):null;n&&s.push(n);switch(this.definitionUrls(t,i).filter((e=>!ft.cached(e))).forEach((e=>{ft.caching(e)?s.push(ft.get(e)):s.push(kt.image().loadUrl(e))})),s.length){case 0:return;case 1:return s[0];default:return Promise.all(s).then()}}loadedVisible(e,t){const[i]=this.urls(t);return ft.get(i)}toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),this.pattern!==u.definition.videosequence.pattern&&(e.pattern=this.pattern),this.increment!==u.definition.videosequence.increment&&(e.increment=this.increment),this.begin!==u.definition.videosequence.begin&&(e.begin=this.begin),this.fps!==u.definition.videosequence.fps&&(e.fps=this.fps),this.padding!==u.definition.videosequence.padding&&(e.padding=this.padding),e}unload(e){const t=$e.fromArgs(0,this.fps),i=this.urls(t,t.withFrame(this.framesMax)),s=new Set(i.filter((e=>ft.cached(e))));e&&e.forEach((e=>{const[t,i]=e;this.framesArray(t,i).map((e=>this.urlForFrame(e))).filter((e=>s.has(e))).forEach((e=>{s.delete(e)}))})),s.forEach((e=>{ft.remove(e)}))}urlForFrame(e){let t=String(e*this.increment+this.begin);return this.padding&&(t=t.padStart(this.padding,"0")),We((this.url+this.pattern).replaceAll("%",t))}urls(e,t){return this.framesArray(e,t).map((e=>this.urlForFrame(e)))}}const br=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.installed(t)?me.fromId(t):new vr(e)},wr=e=>br({id:e}),Tr=e=>br(e).instanceFromObject(e),xr=e=>Tr({id:e}),Cr=()=>{},Sr=e=>{const{id:t}=e;if(!t||!V.populatedString(t))throw g.id;return me.uninstall(t),br(e)},Fr=e=>{const t=Sr(e);return t.retain=!0,t},_r={define:Sr,install:Fr,definition:br,definitionFromId:wr,fromId:xr,initialize:Cr,instance:Tr};Vt[e.DefinitionType.VideoSequence]=_r,B.forEach((e=>{Zi[e].initialize()})),e.Action=Ge,e.Actions=at,e.AddClipToTrackAction=it,e.AddEffectAction=tt,e.AddTrackAction=He,e.AudibleContext=ct,e.AudibleDefinitionMixin=Ot,e.AudibleFileDefinitionMixin=Mt,e.AudibleFileMixin=wt,e.AudibleMixin=vt,e.AudioClass=xt,e.AudioDefinitionClass=zt,e.AudioFactoryImplementation=Jt,e.AudioLoader=Ft,e.Cache=ft,e.Capitalize=ye,e.ChangeAction=Xe,e.ChangeFramesAction=Qe,e.ChangeTrimAction=et,e.ClipDefinitionMixin=St,e.ClipMixin=bt,e.ClipTypes=q,e.Color=d,e.CommandTypes=ee,e.ContextFactory=mt,e.DataTypes=H,e.Default=u,e.DefinitionBase=yt,e.DefinitionTypes=B,e.Definitions=me,e.DefinitionsMap=ie,e.EffectClass=Di,e.EffectDefinitionClass=Oi,e.EffectFactoryImplementation=Li,e.Element=we,e.Errors=g,e.Evaluator=_e,e.Factories=Vt,e.Factory=Zi,e.FilterClass=$t,e.FilterDefinitionClass=Lt,e.FilterFactoryImplementation=Fi,e.FontClass=ei,e.FontDefinitionClass=ti,e.FontFactoryImplementation=hi,e.FontLoader=_t,e.FreezeAction=Ye,e.Id=Ie,e.ImageClass=As,e.ImageDefinitionClass=Ms,e.ImageFactoryImplementation=qs,e.ImageLoader=It,e.InstanceBase=gt,e.Is=V,e.Job=class{constructor(){this.inputs=[],this.outputs=[]}},e.Loader=pt,e.MashClass=Js,e.MashDefinitionClass=$s,e.MashFactoryImplementation=Qs,e.MashTypes=$,e.MasherClass=sn,e.MasherDefinitionClass=nn,e.MasherFactoryImplementation=yn,e.MergerClass=Ki,e.MergerDefinitionClass=Hi,e.MergerFactoryImplementation=ls,e.ModularDefinitionMixin=_i,e.ModularMixin=Ii,e.ModuleTypes=Z,e.MoveClipsAction=st,e.MoveEffectsAction=ot,e.Parameter=y,e.Pixel=Pe,e.Property=ge,e.RemoveClipsAction=nt,e.Round=ke,e.ScalerClass=ds,e.ScalerDefinitionClass=ms,e.ScalerFactoryImplementation=Ss,e.Seconds=(e,t,i)=>{let s,n,r,o="";return i||(i=e),s=3600,n=2,i>=s&&(e>=s?(o+=String(Math.floor(e/s)).padStart(n,"0"),r=!0,e%=s):o+="00:"),s=60,(r||i>=s)&&(r&&(o+=":"),e>=s?(o+=String(Math.floor(e/s)).padStart(n,"0"),r=!0,e%=s):o+="00:"),s=1,r||i>=s?(r&&(o+=":"),e>=s?(o+=String(Math.floor(e/s)).padStart(n,"0"),r=!0,e%=s):o+="00"):o+="00",t>1&&(10===t&&(n=1),o+=".",e?(e=1===n?Math.floor(10*e)/10:Math.floor(100*e)/100,e=Number(String(e).substr(2,2)),o+=String(e).padStart(n,"0")):o+="0".padStart(n,"0")),o},e.Sort=Be,e.SplitAction=rt,e.ThemeClass=bn,e.ThemeDefinitionClass=Tn,e.ThemeFactoryImplementation=kn,e.Time=$e,e.TimeRange=Le,e.TrackClass=Us,e.TrackRange=Ze,e.TransformTypes=Y,e.TransformableMixin=Fs,e.TransitionClass=Mn,e.TransitionDefinitionClass=zn,e.TransitionFactoryImplementation=Bn,e.Type=fe,e.TypeValue=te,e.Types=pe,e.Url=Ke,e.VideoClassImplementation=$n,e.VideoDefinitionClassImplementation=Zn,e.VideoFactoryImplementation=er,e.VideoLoader=At,e.VideoSequenceClass=gr,e.VideoSequenceDefinitionClass=vr,e.VideoSequenceFactoryImplementation=_r,e.VideoStreamClass=nr,e.VideoStreamDefinitionClass=or,e.VideoStreamFactoryImplementation=fr,e.VisibleContext=ht,e.VisibleDefinitionMixin=Ds,e.VisibleMixin=_s,e.audioDefine=Ut,e.audioDefinition=jt,e.audioDefinitionFromId=Nt,e.audioFromId=Rt,e.audioInitialize=qt,e.audioInstall=Bt,e.audioInstance=Pt,e.byFrame=Re,e.byLabel=Ue,e.byTrack=qe,e.colorRgb2hex=r,e.colorRgb2yuv=a,e.colorStrip=c,e.colorTransparent=h,e.colorValid=l,e.colorYuv2rgb=n,e.colorYuvBlend=o,e.definitionsByType=ne,e.definitionsClear=re,e.definitionsFont=oe,e.definitionsFromId=ae,e.definitionsInstall=ce,e.definitionsInstalled=le,e.definitionsMerger=he,e.definitionsScaler=de,e.definitionsUninstall=ue,e.effectDefine=$i,e.effectDefinition=Ri,e.effectDefinitionFromId=qi,e.effectFromId=Bi,e.effectInitialize=Ji,e.effectInstall=$i,e.effectInstance=Ui,e.elementScrollMetrics=be,e.filterDefine=Si,e.filterDefinition=bi,e.filterDefinitionFromId=wi,e.filterFromId=xi,e.filterInitialize=Ci,e.filterInstall=Si,e.filterInstance=Ti,e.fontDefine=li,e.fontDefinition=ni,e.fontDefinitionFromId=ri,e.fontFromId=ai,e.fontInitialize=ci,e.fontInstall=li,e.fontInstance=oi,e.imageDefine=Ps,e.imageDefinition=Es,e.imageDefinitionFromId=zs,e.imageFromId=js,e.imageInitialize=Ns,e.imageInstall=Rs,e.imageInstance=Vs,e.isAboveZero=D,e.isArray=k,e.isBoolean=x,e.isDefined=S,e.isFloat=I,e.isInteger=_,e.isMethod=C,e.isNan=F,e.isNumber=T,e.isObject=v,e.isPopulatedArray=z,e.isPopulatedObject=E,e.isPopulatedString=M,e.isPositive=A,e.isString=b,e.isUndefined=w,e.mashDefine=Xs,e.mashDefinition=Zs,e.mashDefinitionFromId=Ws,e.mashFromId=Gs,e.mashInitialize=Hs,e.mashInstall=Ys,e.mashInstance=Ks,e.masherDefine=gn,e.masherDefinition=dn,e.masherDefinitionFromId=un,e.masherDestroy=cn,e.masherFromId=fn,e.masherInitialize=pn,e.masherInstall=gn,e.masherInstance=mn,e.mergerDefaultId=is,e.mergerDefine=cs,e.mergerDefinition=ss,e.mergerDefinitionFromId=ns,e.mergerFromId=os,e.mergerInitialize=as,e.mergerInstall=cs,e.mergerInstance=rs,e.pixelColor=ze,e.pixelFromFrame=je,e.pixelNeighboringRgbas=Ee,e.pixelPerFrame=Ve,e.pixelRgbaAtIndex=Oe,e.pixelToFrame=Ne,e.roundMethod=Ae,e.roundWithMethod=De,e.scalerDefaultId=ys,e.scalerDefine=Cs,e.scalerDefinition=vs,e.scalerDefinitionFromId=bs,e.scalerFromId=Ts,e.scalerInitialize=xs,e.scalerInstall=Cs,e.scalerInstance=ws,e.themeDefine=Dn,e.themeDefinition=Sn,e.themeDefinitionFromId=Fn,e.themeFromId=In,e.themeInitialize=An,e.themeInstall=Dn,e.themeInstance=_n,e.timeEqualizeRates=Je,e.transitionDefine=Un,e.transitionDefinition=jn,e.transitionDefinitionFromId=Nn,e.transitionFromId=Rn,e.transitionInitialize=qn,e.transitionInstall=Un,e.transitionInstance=Pn,e.urlAbsolute=We,e.videoDefine=Yn,e.videoDefinition=Wn,e.videoDefinitionFromId=Kn,e.videoFromId=Hn,e.videoInitialize=Xn,e.videoInstall=Qn,e.videoInstance=Gn,e.videoSequenceDefine=Sr,e.videoSequenceDefinition=br,e.videoSequenceDefinitionFromId=wr,e.videoSequenceFromId=xr,e.videoSequenceInitialize=Cr,e.videoSequenceInstall=Fr,e.videoSequenceInstance=Tr,e.videoStreamDefine=ur,e.videoStreamDefinition=ar,e.videoStreamDefinitionFromId=cr,e.videoStreamFromId=hr,e.videoStreamInitialize=dr,e.videoStreamInstall=mr,e.videoStreamInstance=lr}));
//# sourceMappingURL=moviemasher.min.js.map
