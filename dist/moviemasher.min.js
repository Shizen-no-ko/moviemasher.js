!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MovieMasher={})}(this,(function(e){"use strict";const t={buffer:10,fps:30,loop:!0,volume:.75,precision:3,autoplay:!1,mash:{label:"Untitled Mash",quantize:10,backcolor:"rgb(0,0,0)"},media:{frame:{duration:2},image:{duration:2},theme:{duration:3},transition:{duration:1}}},i="deprecated in 4.1",s="Internal Error ",r={mash:"Expected mash",action:"Expected Action",actions:"Expected Actions",internal:s,argument:"Invalid argument ",type:"Invalid type ",selection:"Invalid selection ",unknown:{type:"Unknown type ",merger:"Unknown merger ",effect:"Unknown effect ",filter:"Unknown filter ",font:"Unknown font ",scaler:"Unknown scalar "},uncached:"Uncached URL ",object:"Invalid argument object ",array:"Invalid argument array ",media:"Invalid argument media ",id:"Invalid argument id ",frame:"Invalid argument frame ",frames:"Invalid property frames ",fps:"Invalid argument fps ",seconds:"Invalid argument seconds ",url:"Invalid argument url ",time:"Invalid argument Time",timeRange:"Invalid argument TimeRange",mainTrackOverlap:`${s}: main track clips overlap without transition`,unknownMash:"Unknown Mash property ",property:"Invalid argument property ",deprecation:{property_types:`property_types ${i} - please get MovieMasher.Property.types instead`,addModulesOfType:`addModulesOfType ${i} for unsupported type `,configure:{get:`configure ${i} - please get MovieMasher.defaults instead`,set:`configure ${i} - please supply mash.quantize and media.duration instead`},canvas_context:{get:`canvas_context ${i} - please get videoContext instead`,set:`canvas_context ${i} - please set videoContext instead`}},wrongClass:"Expected instance of "},n=(e,t)=>e.frame-t.frame,a=(e,t)=>e.track-t.track,o=(e,t)=>e.label<t.label?-1:e.label>t.label?1:0,c="audio",l="effect",h="font",u="image",m="merger",d="scaler",f="theme",p="transition",g="video",_=e=>[e,e],v=[c,g,u,f,p,"frame"],y=Object.fromEntries(v.map(_)),b=["action","load","duration","truncate","add","undo","redo"],w=Object.fromEntries(b.map(_)),x=[c,u,g,f,p,d,m,l,h,"filter"],T=Object.fromEntries(x.map(_)),C=[h,l,d,m,f,p],j=Object.fromEntries(C.map(_)),F=[h,u,c,"module"],k=Object.fromEntries(F.map(_)),I=[c,g],O=Object.fromEntries(I.map(_)),E=[l,...I],M=Object.fromEntries(E.map(_)),A=[m,d],S=Object.fromEntries(A.map(_));var z={label:"Blackout Two AM",id:"com.moviemasher.font.default",type:"font",source:"../examples/javascript/media/font/blackout/theleagueof-blackout/webfonts/blackout_two_am-webfont.ttf",family:"Blackout Two AM"};var R={label:"Blur",type:"effect",id:"com.moviemasher.effect.blur",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"1 1 1 1 1 1 1 1 1"},{name:"1m",value:"1 1 1 1 1 1 1 1 1"},{name:"2m",value:"1 1 1 1 1 1 1 1 1"},{name:"3m",value:"1 1 1 1 1 1 1 1 1"},{name:"0rdiv",value:"1/9"},{name:"1rdiv",value:"1/9"},{name:"2rdiv",value:"1/9"},{name:"3rdiv",value:"1/9"}]}]};var V={label:"Chromakey",type:"effect",id:"com.moviemasher.effect.chromakey",properties:{chroma_blend:{type:"number",value:.01},chroma_similarity:{type:"number",value:.5},chroma_color:{type:"rgb",value:"rgb(0,255,0)"}},filters:[{id:"chromakey",parameters:[{name:"color",value:"chroma_color"},{name:"blend",value:"chroma_blend"},{name:"similarity",value:"chroma_similarity"}]}]};var P={label:"Emboss",type:"effect",id:"com.moviemasher.effect.emboss",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"1m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"2m",value:"-2 -1 0 -1 1 1 0 1 2"},{name:"3m",value:"-2 -1 0 -1 1 1 0 1 2"}]}]};var B={label:"Grayscale",type:"effect",id:"com.moviemasher.effect.grayscale",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.3},{name:"rg",value:.4},{name:"rb",value:.3},{name:"ra",value:0},{name:"gr",value:.3},{name:"gg",value:.4},{name:"gb",value:.3},{name:"ga",value:0},{name:"br",value:.3},{name:"bg",value:.4},{name:"bb",value:.3},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var q={label:"Sepia",type:"effect",id:"com.moviemasher.effect.sepia",properties:{},filters:[{id:"colorchannelmixer",parameters:[{name:"rr",value:.393},{name:"rg",value:.769},{name:"rb",value:.189},{name:"ra",value:0},{name:"gr",value:.349},{name:"gg",value:.686},{name:"gb",value:.168},{name:"ga",value:0},{name:"br",value:.272},{name:"bg",value:.534},{name:"bb",value:.131},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var N={label:"Sharpen",type:"effect",id:"com.moviemasher.effect.sharpen",properties:{},filters:[{id:"convolution",parameters:[{name:"0m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"1m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"2m",value:"0 -1 0 -1 5 -1 0 -1 0"},{name:"3m",value:"0 -1 0 -1 5 -1 0 -1 0"}]}]};var D={label:"Text Box",type:"effect",id:"com.moviemasher.effect.textbox",properties:{string:{type:"string",value:"Text Box"},size:{type:"fontsize",value:.2},color:{type:"rgba",value:"rgba(255,0,0,1)"},fontface:{type:"font",value:"com.moviemasher.font.default"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},x:{type:"number",value:0},y:{type:"number",value:0}},filters:[{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]};var $={label:"Blend",id:"com.moviemasher.merger.blend",properties:{mode:{type:"mode",value:"normal"}},filters:[{id:"blend",parameters:[{name:"all_mode",value:"mode"},{name:"repeatlast",value:"0"}]}]};var U={label:"Center",id:"com.moviemasher.merger.center",filters:[{id:"overlay",parameters:[{name:"x",value:"floor((mm_width - overlay_w) / 2)"},{name:"y",value:"floor((mm_height - overlay_h) / 2)"}]}]};var L={label:"Constrained",type:"merger",id:"com.moviemasher.merger.constrained",properties:{left:{type:"pixel",value:0},top:{type:"pixel",value:0}},filters:[{id:"overlay",parameters:[{name:"x",value:"left*(mm_width-overlay_w)"},{name:"y",value:"top*(mm_height-overlay_h)"}]}]};var W={label:"Top Left",id:"com.moviemasher.merger.default",filters:[{id:"overlay",parameters:[{name:"x",value:"0"},{name:"y",value:"0"}]}]};var G={label:"Overlay",id:"com.moviemasher.merger.overlay",properties:{left:{type:"pixel",value:.5},top:{type:"pixel",value:.5}},filters:[{id:"overlay",parameters:[{name:"x",value:"((mm_width + overlay_w) * left) - overlay_w"},{name:"y",value:"((mm_height + overlay_h) * top) - overlay_h"}]}]};var J={label:"Stretch",id:"com.moviemasher.scaler.default",filters:[{id:"scale",parameters:[{name:"width",value:"mm_width"},{name:"height",value:"mm_height"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var H={label:"Pan",type:"scaler",id:"com.moviemasher.scaler.pan",properties:{scale:{type:"size1",value:1.25},direction:{type:"direction8",value:1}},filters:[{id:"crop",description:"crop down diagonals and center",parameters:[{name:"out_w",value:[{condition:"direction < 4",value:"mm_input_width"},{condition:"true",value:"mm_horz(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"out_h",value:[{condition:"direction < 4",value:"mm_input_height"},{condition:"true",value:"mm_vert(scale, true) / mm_max(mm_horz(scale, true) / mm_input_width, mm_vert(scale, true) / mm_input_height)"}]},{name:"x",value:"(mm_input_width-out_w)/2"},{name:"y",value:"(mm_input_height-out_h)/2"}]},{id:"scale",description:"scale (proudly for diagonals)",parameters:[{name:"w",value:[{condition:"direction < 4",value:"mm_input_width * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_horz(scale, true)"}]},{name:"h",value:[{condition:"direction < 4",value:"mm_input_height * mm_max(mm_horz(scale) / mm_input_width, mm_vert(scale) / mm_input_height)"},{condition:"true",value:"mm_vert(scale, true)"}]}]},{id:"crop",description:"crop down and position over time",parameters:[{name:"w",value:"mm_width"},{name:"h",value:"mm_height"},{name:"x",value:[{condition:"direction",in:[0,2],value:"(in_w-mm_width)/2"},{condition:"direction",in:[1,5],value:"(in_w-mm_width)*mm_t"},{condition:"direction",is:4,value:"(in_w-mm_width)*mm_t"},{condition:"direction",in:[3,7],value:"(in_w-mm_width)-((in_w-mm_width)*mm_t)"},{condition:"direction",is:6,value:"floor(((in_w-mm_width)*(1.0-mm_t)))"}]},{name:"y",value:[{condition:"direction",in:[1,3],value:"(in_h-mm_height)/2"},{condition:"direction",in:[2,5],value:"(in_h-mm_height)*mm_t"},{condition:"direction",is:6,value:"ceil((in_h-mm_height)*mm_t)"},{condition:"direction",in:[0,7],value:"(in_h-mm_height)-((in_h-mm_height)*mm_t)"},{condition:"direction",is:4,value:"(in_h-mm_height)-((in_h-mm_height) * mm_t)"}]}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var X={label:"Scale",type:"scaler",id:"com.moviemasher.scaler.scale",properties:{scale:{type:"size1",value:1}},filters:[{id:"scale",parameters:[{name:"width",value:"scale * mm_input_width * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"},{name:"height",value:"scale * mm_input_height * mm_max(mm_width / mm_input_width, mm_height / mm_input_height)"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]};var K={label:"Color",type:"theme",id:"com.moviemasher.theme.color",properties:{color:{type:"rgb",value:"#FFFF00"}},filters:[{id:"color"}]};var Y={label:"Title",type:"theme",id:"com.moviemasher.theme.text",properties:{string:{type:"string",value:"Title"},size:{type:"fontsize",value:.3},x:{type:"number",value:0},y:{type:"number",value:0},color:{type:"rgba",value:"rgba(255,0,0,1)"},shadowcolor:{type:"rgba",value:"rgba(0,0,0,0)"},shadowx:{type:"number",value:.015},shadowy:{type:"number",value:.015},background:{type:"hex",value:"#ffffff"},fontface:{type:"font",value:"com.moviemasher.font.default"}},filters:[{id:"color",parameters:[{name:"color",value:"background"},{name:"size",value:"mm_dimensions"},{name:"duration",value:"mm_duration"},{name:"rate",value:"mm_fps"}]},{id:"drawtext",parameters:[{name:"fontcolor",value:"color"},{name:"shadowcolor",value:"shadowcolor"},{name:"fontsize",value:"mm_vert(size)"},{name:"x",value:"mm_horz(x)"},{name:"y",value:"mm_vert(y)"},{name:"shadowx",value:"mm_horz(shadowx)"},{name:"shadowy",value:"mm_vert(shadowy)"},{name:"fontfile",value:"mm_fontfile(fontface)"},{name:"textfile",value:"mm_textfile(string)"}]}]};const Q=new class{constructor(){this.defaults={font:z,merger:W,scaler:J},this[j.theme]=[K,Y],this[j.effect]=[R,V,P,B,q,N,D],this[j.font]=[this.defaults.font],this[j.merger]=[$,U,L,G,this.defaults.merger],this[j.scaler]=[H,X,this.defaults.scaler],C.forEach((e=>this[e]||=[]))}addModulesOfType(e,t){if(!C.includes(t))return void console.warn(r.deprecation.addModulesOfType+t);const i=this[t];let s=!1;return e.forEach((e=>{const{id:r}=e,n=r==="com.moviemasher."+t+".default",a=this[t].find((e=>e.id===r));a&&i.splice(i.indexOf(a),1),i.push(e),n&&(this.defaults[t]=e),s=!0})),s&&i.sort(o),s}fontById(e){return this.ofType(e,j.font)}scalerById(e){return this.ofType(e,j.scaler)}mergerById(e){return this.ofType(e,j.merger)}effectById(e){return this.ofType(e,j.effect)}themeById(e){return this.ofType(e,j.theme)}defaultOfType(e){return{...this.defaults[e],type:e}}objectWithDefaultId(e){const t=this.defaultOfType(e);if(t)return{id:t.id,type:e}}ofType(e,t){if(!C.includes(t))return void console.warn("Module.ofType unsupported type",t);this[t]||console.log(this.constructor.name,"ofType",t);const i=this[t].find((t=>t.id===e));return i?{...i,type:t}:void 0}},Z=e=>ue(Array.isArray)?Array.isArray(e):instance(e,Array),ee=e=>"object"==typeof e,te=e=>"string"==typeof e,ie=e=>void 0===e,se=e=>"number"==typeof e,re=e=>Number.isInteger(e),ne=e=>!!e.length,ae=e=>null===e,oe=e=>ie(e)||ae(e),ce=e=>oe(e)||!te(e)||!ne(e),le=e=>oe(e)||!Z(e)||!ne(e),he=e=>oe(e)||!ee(e)||!ne(Object.keys(e)),ue=e=>!me.undefined(e),me={nonobject:e=>"Object"!==e.constructor.name,empty:e=>!!oe(e)||(Z(e)?le(e):te(e)?ce(e):he(e)),emptyarray:le,emptyobject:he,emptystring:ce,float:e=>se(e)&&!re(e),object:ee,undefined:ie,boolean:e=>"boolean"==typeof e,number:se,integer:re,string:te,array:Z,instanceOf:(e,t)=>me.object(e)&&e instanceof t,defined:ue,method:e=>"function"==typeof e,nan:e=>se(e)&&isNaN(e),nil:ae,not:oe,objectStrict:e=>ee(e)&&!(oe(e)||Z(e)),positive:e=>re(e)&&e>=0};class de{}Object.defineProperties(de.prototype,{modularPropertyTypeIds:{get:function(){if(me.undefined(this.__modularPropertyTypeIds)){const e=Object.keys(this.propertyTypes);this.__modularPropertyTypeIds=e.filter((e=>this.propertyTypes[e].modular))}return this.__modularPropertyTypeIds}},orDefault:{value:function(e){const{value:t,type:i}=e;return me.defined(t)?t:this.propertyTypeDefault(t,i)}},property_types:{get:function(){return console.warn(r.deprecation.property_types),this.propertyTypes}},propertyType:{value:function(e){return this.propertyTypes[e]}},propertyTypeDefault:{value:function(e){if(!me.string(e)||me.empty(e))return;const t=this.propertyType(e);return me.object(t)?me.defined(t.value)?t.value:t.type?new t.type:void 0:void 0}},propertyTypes:{value:{number:{type:Number,value:0},integer:{type:Number,value:0},rgba:{type:String,value:"#000000FF"},rgb:{type:String,value:"#000000"},font:{type:String,value:"com.moviemasher.font.default",modular:!0},fontsize:{type:Number,value:13},direction4:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"}],value:0},direction8:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"},{id:4,identifier:"top_right",label:"Top Right"},{id:5,identifier:"bottom_right",label:"Bottom Right"},{id:6,identifier:"bottom_left",label:"Bottom Left"},{id:7,identifier:"top_left",label:"Top Left"}],value:0},string:{type:String,value:""},pixel:{type:Number,value:0},mode:{type:String,value:"normal",values:[{id:"burn",composite:"color-burn",label:"Color Burn"},{id:"dodge",composite:"color-dodge",label:"Color Dodge"},{id:"darken",composite:"darken",label:"Darken"},{id:"difference",composite:"difference",label:"Difference"},{id:"exclusion",composite:"exclusion",label:"Exclusion"},{id:"hardlight",composite:"hard-light",label:"Hard Light"},{id:"lighten",composite:"lighter",label:"Lighten"},{id:"multiply",composite:"multiply",label:"Multiply"},{id:"normal",composite:"normal",label:"Normal"},{id:"overlay",composite:"overlay",label:"Overlay"},{id:"screen",composite:"screen",label:"Screen"},{id:"softlight",composite:"soft-light",label:"Soft Light"},{id:"xor",composite:"xor",label:"Xor"}]},text:{type:String,value:""}}}});const fe=new de,pe=function(e,t,i,s){var r,n,a,o=0,c=e.length;for(a=0;a<c;a++)r=e[a].u-t.u,n=e[a].v-t.v,o+=Math.sqrt((r*r+n*n)/65025);return o/=Number(c),s>1e-4?255*Math.min(1,Math.max(0,(o-i)/s)):o>i?255:0},ge=function(e){var t,i={};for(t in e)e[t]=parseInt(e[t]);for(t in i.y=.299*e.r+.587*e.g+.114*e.b,i.u=-.168736*e.r+-.331264*e.g+.5*e.b+128,i.v=.5*e.r+-.418688*e.g+-.081312*e.b+128,i)i[t]=Math.floor(i[t]);return i};const _e=new class{createDrawing(e,t){const i=this.createVideo();return 1<=e&&(i.canvas.width=e),1<=t&&(i.canvas.height=t),i}createDrawingLike(e){return this.createDrawing(e.canvas.width,e.canvas.height)}createAudio(){const e=window.AudioContext||window.webkitAudioContext;if(e)return new e}createCanvas(){return document&&document.createElement("canvas")}createVideo(e){const t=e||this.createCanvas();return t&&t.getContext("2d")}};function ve(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>{const t=new Uint8Array(1);return(e^crypto.getRandomValues(t)[0]&15>>e/4).toString(16)}))}const ye=(e,t)=>{if(!(e<0||e>t.length-4))return{r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}},be=(e,t,i,s,r)=>{const n=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e,s);return n.x=Math.max(0,Math.min(s-1,n.x+t)),n.y=Math.max(0,Math.min(r-1,n.y+i)),((e,t)=>e.y*t+e.x)(n,s)},we=e=>{const t=String(e);return"0x"===t.slice(0,2)?"#"+t.slice(2):t},xe=ye,Te=(e,t,i,s,r)=>((e,t,i,s=3)=>{const r=[],n=Math.floor(s/2);for(let a=0;a<s;a++)for(let o=0;o<s;o++)r.push(be(e,o-n,a-n,t,i));return r})(e,i,s,r).map((e=>((e,t)=>ye((e=>4*e)(e),t))(e,t))),Ce=(e,t,i)=>{if(!me.instanceOf(e,t))throw i||r.wrongClass+t.name};class je{static get zero(){return new je}static scaleTimes(e,t,i="round"){if(e.fps===t.fps)return[e,t];var s,r,n=(s=e.fps,r=t.fps,s*r/((e,t)=>{for(var i;0!==t;)i=t,t=e%t,e=i;return e})(s,r));return[e.scale(n,i),t.scale(n,i)]}constructor(e=0,t=1){if(!me.integer(e)||e<0)throw r.frame;if(!me.integer(t)||t<1)throw r.fps;this.frame=e,this.fps=t}add(e){const[t,i]=je.scaleTimes(this,e);return new je(t.frame+i.frame,t.fps)}addFrames(e){const t=this.copy;return t.frame+=e,t}get copy(){return new je(this.frame,this.fps)}get description(){return`${this.frame}@${this.fps}`}divide(e,t="round"){if(!me.number(e))throw r.argument;return new je(Math[t](Number(this.frame)/e),this.fps)}equalsTime(e){if(!(e instanceof je))throw r.time;const[t,i]=je.scaleTimes(this,e);return t.frame===i.frame}min(e){if(!e instanceof je)throw r.time;const[t,i]=je.scaleTimes(this,e);return new je(Math.min(t.frame,i.frame),t.fps)}scale(e=1,t="round"){if(this.fps===e)return this;const i=Number(this.frame/this.fps)*Number(e);return new je(Math[t](i),e)}get seconds(){return Number(this.frame)/Number(this.fps)}subtract(e){if(!e instanceof je)throw r.argument;const[t,i]=je.scaleTimes(this,e);var s=i.frame;return s>t.frame&&(s-=s-t.frame),new je(t.frame-s,t.fps)}subtractFrames(e){const t=this.copy;return t.frame-=e,t}toString(){return`[${this.description}]`}withFrame(e){const t=this.copy;return t.frame=e,t}}class Fe{static createFromFrame(e,t){return new je(e,t)}static createFromSeconds(e=0,t=1,i="round"){if(!me.number(e)||e<0)throw r.seconds;if(!me.integer(t)||t<1)throw r.fps;const s=this.roundingFunction(i)(e*t);return this.createFromFrame(s,t)}static roundingFunction(e="round"){switch(e){case"ceil":return Math.ceil;case"floor":return Math.floor;default:return Math.round}}}class ke extends je{constructor(e=0,t=1,i=1){if(!(me.integer(i)&&i>=0))throw i;super(e,t),this.frames=i}get description(){return`${this.frame}-${this.frames}@${this.fps}`}get end(){return this.frame+this.frames}get endTime(){return Fe.createFromFrame(this.end,this.fps)}get lengthSeconds(){return Number(this.frames)/Number(this.fps)}get position(){return Number(this.frame)/Number(this.frames)}get startTime(){return Fe.createFromFrame(this.frame,this.fps)}get copy(){return new ke(this.frame,this.fps,this.frames)}scale(e=1,t="round"){if(this.fps===e)return this.copy;const i=Number(this.frames)/(Number(this.fps)/Number(e)),s=super.scale(e,t);return new ke(s.frame,s.fps,Math.max(1,Math[t](i)))}intersects(e){const[t,i]=je.scaleTimes(this,e);return!(t.frame>=i.end)&&t.end>i.frame}minEndTime(e){const[t,i]=je.scaleTimes(this,e);return t.frames=Math.min(t.frames,i.frame),t}withFrame(e){const t=this.copy;return t.frame=e,t}withFrames(e){const t=this.copy;return t.frames=e,t}}const Ie=(e,t,i="id")=>{if(!me.array(e))throw r.array;if(me.undefined(i))throw r.argument;const s=me.object(t)?t[i]:t;if(me.undefined(s))throw r.argument;return e.find((e=>e[i]===s))},Oe=(e,t)=>{me.array(e)&&e.includes(t)&&e.splice(e.indexOf(t),1)},Ee=e=>{const t=me.string(e)?e:String(e);return me.emptystring(t)?t:`${t[0].toUpperCase()}${t.substr(1)}`};class Me{constructor(e={}){if(!me.objectStrict(e))throw r.object;this.object=e}toJSON(){return this.object}toString(){return`[${this.constructor.name}]`}}class Ae{constructor(e){if(!me.objectStrict(e))throw r.argument+e;const t=Object.keys(e).map((t=>[t,{value:e[t]}]));Object.defineProperties(this,Object.fromEntries(t))}get events(){return this.mash.events}get selectedClips(){return this.done?this.redoSelectedClips:this.undoSelectedClips}get selectedEffects(){return this.done?this.redoSelectedEffects:this.undoSelectedEffects}redo(){this.redoAction(),this.done=!0,this.events&&this.events.emit(w.action,{action:this})}redoAction(){}undo(){this.undoAction(),this.done=!1,this.events&&this.events.emit(w.action,{action:this})}undoAction(){}}class Se extends Ae{redoAction(){this.mash.addTrack(this.trackType)}undoAction(){this.mash.removeTrack(this.trackType)}}class ze extends Ae{constructor(e){const t=e.redoValue;delete e.redoValue,super(e),this.__redoValue=t}get redoValue(){return this.__redoValue}redoAction(){this.target[this.property]=this.redoValue}undoAction(){this.target[this.property]=this.undoValue}updateAction(e){this.__redoValue=e,this.redo()}}class Re extends Ae{redoAction(){this.trackClips.splice(this.index,0,this.insertClip,this.frozenClip),this.freezeClip.frames-=this.frames}undoAction(){this.freezeClip.frames+=this.frames,this.trackClips.splice(this.index,2)}}class Ve extends ze{redoAction(){this.mash.changeClipFrames(this.target,this.redoValue)}undoAction(){this.mash.changeClipFrames(this.target,this.undoValue)}}class Pe extends ze{redoAction(){this.mash.changeClipTrim(this.target,this.redoValue,this.frames+this.undoValue)}undoAction(){this.mash.changeClipTrim(this.target,this.undoValue,this.frames+this.undoValue)}}class Be extends Ae{redoAction(){this.effects.splice(this.index,0,this.effect)}undoAction(){Oe(this.effects,this.effect)}}class qe extends Se{get clips(){return this.track.clips}get track(){return this.mash[this.trackType][this.trackIndex]}redoAction(){for(let e=0;e<this.createTracks;e++)super.redoAction();this.mash.addClipsToTrack([this.clip],this.trackIndex,this.insertIndex)}undoAction(){this.mash.removeClipsFromTrack([this.clip]);for(let e=0;e<this.createTracks;e++)super.undoAction()}}class Ne extends Ae{addClips(e,t){this.mash.addClipsToTrack(this.clips,e,t)}redoAction(){this.redoFrames&&this.clips.forEach(((e,t)=>e.frame=this.redoFrames[t])),this.addClips(this.trackIndex,this.insertIndex)}undoAction(){this.undoFrames&&this.clips.forEach(((e,t)=>e.frame=this.undoFrames[t])),this.addClips(this.undoTrackIndex,this.undoInsertIndex)}}const De={track:{get:function(){if(me.undefined(this.__track)){const e=this.object.track;this.__track=me.defined(e)?e:-1}return this.__track},set:function(e){this.__track=e}}};class $e extends Ae{get trackIndex(){return De.index}redoAction(){this.mash.removeClipsFromTrack(this.clips)}undoAction(){this.mash.addClipsToTrack(this.clips,this.trackIndex,this.index)}}class Ue extends Ae{redoAction(){this.trackClips.splice(this.index,0,this.insertClip),this.splitClip.frames=this.redoFrames}undoAction(){this.splitClip.frames=this.undoFrames,this.trackClips.splice(this.index,1)}}class Le extends Ae{redoAction(){this.effects.splice(0,this.effects.length,...this.redoEffects)}undoAction(){this.effects.splice(0,this.effects.length,...this.undoEffects)}}class We extends Me{constructor(e){super(e),this.actions=[],this.index=-1}get canRedo(){return this.index<this.actions.length-1}get canUndo(){return this.index>-1}get currentAction(){return this.actions[this.index]}get currentActionLast(){return this.canUndo&&!this.canRedo}get mash(){return this.object.mash}get masher(){return this.object.masher}do(e){if(!me.instanceOf(e,Ae))throw r.action;e.actions=this;const t=this.actions.length-(this.index+1),i=t?this.actions.splice(this.index+1,t):[];return this.actions.push(e),this.redo(),i}redo(){this.index++;const e=this.currentAction;return e.redo(),e}undo(){const e=this.currentAction;return this.index--,e.undo(),e}}const Ge={id:{get:function(){return this.__id||=this.initializeId}},initializeId:{get:function(){return this.object.id||ve()}}};class Je{constructor(e){this.baseClass=e||Me,this.classesByType=new Map}typeClass(e){const t=this.classesByType.get(e);return t||this.baseClass}create(e){return"string"==typeof e?this.createFromType(e):this.createFromObject(e)}createFromObject(e){if(!me.object(e))throw r.object;const t=this.typeClass(e.type);return me.instanceOf(e,t)?e:new t(e)}createFromType(e){return new(this.typeClass(e))({type:e})}install(e,t){this.classesByType.set(e,t)}}const He={property:{value:function(e){return this[e]||this.object[e]}}},Xe={...He,toJSON:{value:function(){return this.object}},...Ge,label:{get:function(){return this.object.label}},properties:{get:function(){return me.undefined(this.__properties)&&(this.__properties=this.propertiesInitialize),this.__properties}},propertyNames:{get:function(){return Object.keys(this.properties)}},propertiesInitialize:{get:function(){const e={label:{type:"string"}};return this.propertiesTiming&&Object.assign(e,this.propertiesTiming),this.propertiesAudible&&Object.assign(e,this.propertiesAudible),this.propertiesModular&&Object.assign(e,this.propertiesModular),e}},source:{get:function(){return this.object.source}},initializeInstance:{value:function(e,t){const i=this.properties;if(!me.object(i)||me.empty(i))return;const s=this.propertyNames.filter((t=>!Reflect.has(e,t)));if(!me.emptyarray(s)){const r=s.map((e=>[e,{get:function(){const t=`__${e}`;if(me.undefined(this[t])){const s=i[e];this[t]=fe.orDefault(s)}return this[t]},set:function(t){this[`__${e}`]=t}}]));Object.defineProperties(e,Object.fromEntries(r)),this.propertyNames.forEach((i=>{me.defined(t[i])&&(e[i]=t[i])}))}}}};class Ke extends Me{get audioContext(){return this.object.audioContext}process(e,t){return new Promise(((e,i)=>this.audioContext.decodeAudioData(t,(t=>e(t)),(e=>i(e)))))}}const Ye=new class{constructor(){this.__cached_urls={},this.__urls_by_md5={}}add(e,t){const i=this.key(e);this.__cached_urls[i]=t,this.__urls_by_md5[i]=e}cached(e){return!!this.get(e)}get(e){const t=this.key(e);return this.__cached_urls[t]}key(e){if(!me.string(e)||me.empty(e))throw r.url+e;return e}remove(e){const t=this.key(e);delete this.__cached_urls[t],delete this.__urls_by_md5[t]}urls(){return Object.values(this.__urls_by_md5)}};class Qe{process(e,t){const i=Ye.key(e),s=new FontFace(i,t),r=s.load();return r.then((()=>(document.fonts.add(s),{family:i}))),r}}class Ze{process(e,t){console.log("ImageProcessor.process",e)}}class et{process(e,t){}}const tt=new class extends Je{constructor(){super(),this.install(k.audio,Ke),this.install(k.font,Qe),this.install(k.image,Ze),this.install(k.module,et)}};class it extends Me{constructor(e){super(e),this.promises={}}get type(){return this.object.type}loadedUrl(e){return Ye.cached(e)}loadedUrls(e){return e.every((e=>this.loadedUrl(e)))}loadUrl(e){if(this.promises[e])return this.promises[e];if(Ye.cached(e))return Promise.resolve(Ye.get(e));const t=this.requestUrl(e);return this.promises[e]=t,t.then((t=>(Ye.add(e,t),delete this.promises[e],t)))}loadUrls(e){return Promise.all(e.map((e=>this.loadUrl(e))))}}class st extends it{constructor(e){super(e),this.object.type||=k.audio}get audioContext(){return this.object.audioContext}set audioContext(e){this.object.audioContext=e}async requestUrl(e){return fetch(e).then((t=>(console.log("AudioLoader.requestUrl fetch",e,t.constructor.name),t.arrayBuffer()))).then((t=>{console.log("AudioLoader.requestUrl arrayBuffer",e,t.constructor.name);const i={type:this.type,audioContext:this.audioContext};return tt.createFromObject(i).process(e,t)}))}}class rt extends it{constructor(e){super(e),this.object.type||=k.font}async requestUrl(e){return fetch(e).then((e=>e.arrayBuffer())).then((t=>tt.create(this.type).process(e,t)))}}class nt extends it{constructor(e){super(e),this.object.type||=k.image}requestUrl(e){return new Promise(((t,i)=>{const s=new Image;return s.onload=e=>t(e.target),s.onerror=e=>i(e),s.crossOrigin="Anonymous",s.src=e,s}))}}class at extends it{constructor(e){super(e),this.object.type||=k.module}requestUrl(e){return import(e)}}const ot=new class extends Je{constructor(){super(),this.install(k.audio,st),this.install(k.font,rt),this.install(k.image,nt),this.install(k.module,at)}};class ct{static get none(){return ht}constructor(){this.loaders={}}get loaded(){return this.urls.every((e=>Ye.cached(e)))}get urls(){return F.flatMap((e=>this[e]))}get urlsUnloaded(){return this.urls.filter((e=>!Ye.cached(e)))}concat(e){me.instanceOf(e,ct)?F.forEach((t=>{const i=this[t];i.splice(0,i.length,...new Set([...i,...e[t]]))})):console.warn(this.constructor.name,"concat",e)}load(e){const t=F.flatMap((t=>{const i=this[t];if(0===i.length)return[];if(me.undefined(this.loaders[t])){const i={type:t,audioContext:e};this.loaders[t]=ot.createFromObject(i)}return this.loaders[t].loadUrls(i)}));return t.length?Promise.all(t):Promise.resolve()}}const lt=Object.fromEntries(F.map((e=>[e,{get:function(){const t=`__${e}`;return me.undefined(this[t])&&(this[t]=[]),this[t]}}])));Object.defineProperties(ct.prototype,lt);const ht=new ct,ut={audible:{value:!1},urlsAudibleInTimeRangeForClipByType:{value:function(){return ct.none}}},mt={visible:{value:!0},trackType:{value:O.video}},dt={propertiesModular:{get:function(){return me.undefined(this.__propertiesModular)&&(this.__propertiesModular=this.object.properties||{}),this.__propertiesModular}},modularPropertiesByType:{get:function(){return me.undefined(this.__modularPropertiesByType)&&(this.__modularPropertiesByType=this.initializeModularPropertiesByType),this.__modularPropertiesByType}},initializeModularPropertiesByType:{get:function(){const e={};return fe.modularPropertyTypeIds.forEach((t=>{Object.keys(this.propertiesModular).forEach((i=>{t===this.propertiesModular[i].type&&(e[t]||=[],e[t].push(i))}))})),e}}},ft={modular:{value:!0},...dt};function pt(){}Object.defineProperties(pt.prototype,{scopeSet:{value:function(){}},draw:{value:function(e){return e.context}}});const gt=new class extends pt{draw(e,t,i){const s=e.context,r=((e,t,i,s)=>Ie(e,t,s)[i])(fe.propertyTypes.mode.values,t.all_mode,"composite");return i.globalCompositeOperation=r,i.drawImage(s.canvas,0,0),i.globalCompositeOperation="normal",i}};const _t=new class extends pt{get parameters(){return[{name:"color",value:"color"},{name:"similarity",value:"similarity"},{name:"blend",value:"blend"}]}draw(e,t){const i=e.context,s=i.canvas,{width:r,height:n}=s,{blend:a,color:o,similarity:c,accurate:l}=t,h=o.substr(4,o.length-5).split(",").map((e=>Number(e))),u={r:h[0],g:h[1],b:h[2]},m=ge(u),d=i.getImageData(0,0,r,n),f=d.data,p=l?this.yuvsFromPixelsAccurate(f,r,n):this.yuvsFromPixels(f);let g=0;return p.forEach((e=>{f[g+3]=pe(e,m,c,a),g+=4})),i.putImageData(d,0,0),i}yuvsFromPixelsAccurate(e,t,i){let s=e.length/4;const r=[];for(;s--;){const n=Te(4*s,e,t,i);r.push(n.map((e=>ge(e))))}return r}yuvsFromPixels(e){let t=e.length/4;const i=[];for(;t--;){const s=4*t;i.push([ge(xe(s,e))])}return i}};const vt=new class extends pt{draw(e,t){const{context:i}=e,{color:s}=t;if(!me.string(s))return i;const{canvas:r}=i,{width:n,height:a}=r;return i.fillStyle=we(s),i.fillRect(0,0,n,a),i}get parameters(){return[{name:"color",value:"color"},{name:"size",value:"mm_dimensions"},{name:"duration",value:"mm_duration"},{name:"rate",value:"mm_fps"}]}};const yt=new class extends pt{draw(e,t){const i=e.context,s="rgba".split("");var r,n,a,o,c,l,h,u,m,d,f,p,g,_=s.length;for(c=0;c<_;c++)for(n=s[c],o=0;o<_;o++)null===t[r=n+(a=s[o])]&&(t[r]=n===a?1:0);for(d=i.canvas.width,f=i.canvas.height,_=(g=(p=i.getImageData(0,0,d,f)).data).length,c=0;c<_;c+=4)l=g[c],h=g[c+1],u=g[c+2],m=g[c+3],g[c]=l*t.rr+h*t.rg+u*t.rb+m*t.ra,g[c+1]=l*t.gr+h*t.gg+u*t.gb+m*t.ga,g[c+2]=l*t.br+h*t.bg+u*t.bb+m*t.ba,g[c+3]=l*t.ar+h*t.ag+u*t.ab+m*t.aa;return i.putImageData(p,0,0),i}},bt="rgba";const wt=new class extends pt{draw(e,t){const i=(e=>{const t={bias:{},rdiv:{},matrix:{}};return bt.split("").forEach(((i,s)=>{const r=e[`${s}m`].split(" ").map((e=>parseInt(e)));if(t.matrix[i]=r,t.rdiv[i]=e[`${s}rdiv`]||1,String(t.rdiv[i]).includes("/")){const e=t.rdiv[i].split("/");t.rdiv[i]=parseFloat(e[0])/parseFloat(e[1])}else t.rdiv[i]=parseFloat(t.rdiv[i]);t.bias[i]=e[`${s}bias`]||0})),t})(t),s=e.context,r=s.canvas,{width:n,height:a}=r,o=s.getImageData(0,0,n,a),c=s.createImageData(n,a);return((e,t,i,s,r)=>{const n=s*r;for(let a=0;a<n;a++){const n=Te(a,t,s,r);bt.split("").forEach(((t,s)=>{const r=e.rdiv[t],o=e.matrix[t],c=e.bias[t];let l=0;for(let e=0;e<9;e++)l+=n[e][t]*o[e];l=Math.floor(l*r+c+.5),i[4*a+s]=l}))}})(i,o.data,c.data,n,a),s.putImageData(c,0,0),s}};const xt=new class extends pt{draw(e,t){const i=e.context,s=t.x||0,r=t.y||0,n=e.get("mm_input_width"),a=e.get("mm_input_height");let o=t.w||t.out_w,c=t.h||t.out_h;if(2>o+c)throw"crop.draw invalid output dimensions";if(!n||!a)throw"crop.draw invalid input dimensions";-1===o&&(o=n*(c/a)),-1===c&&(c=a*(o/n));const l=_e.createDrawing(o,c);return l.drawImage(i.canvas,s,r,o,c,0,0,o,c),[l]}scopeSet(e){const{width:t,height:i}=e.context.canvas;e.set("in_h",i),e.set("mm_input_height",i),e.set("in_w",t),e.set("mm_input_width",t),me.not(e.get("x"))&&e.set("x","((in_w - out_w) / 2)"),me.not(e.get("y"))&&e.set("y","((in_h - out_h) / 2)")}};const Tt=new class extends pt{draw(e,t){var i=e.context;const s=me.undefined(t.color)?"black":t.color,r=t.x||0,n=t.y||0,a=t.width||i.canvas.width,o=t.height||i.canvas.height;return i.fillStyle=we(s),i.fillRect(r,n,a,o),i}},Ct=e=>Q.fontById(e).source,jt=e=>e,Ft=e=>Ye.key(Ct(e));const kt=new class extends pt{get parameters(){return[{name:"fontcolor",value:"#000000"},{name:"shadowcolor",value:"#FFFFFF"},{name:"fontsize",value:"mm_vert(20)"},{name:"x",value:"0"},{name:"y",value:"0"},{name:"shadowx",value:"mm_horz(5)"},{name:"shadowy",value:"mm_vert(5)"},{name:"fontfile",value:"mm_fontfile('com.moviemasher.font.default')"},{name:"textfile",value:"Hello World"}]}draw(e,t){const i=e.context,s=Ft(e.get("fontface")),{x:r,y:n,fontsize:a,fontcolor:o,text:c,textfile:l,shadowcolor:h}=t;if(h){i.shadowColor=h;const{shadowx:e,shadowy:s}=t;i.shadowOffsetX=e||0,i.shadowOffsetY=s||0}return i.font=`${a}px "${s}"`,i.fillStyle=we(o),i.fillText(c||l,r,Number(n)+Number(a)),h&&(i.shadowColor=null,i.shadowOffsetX=0,i.shadowOffsetY=0),i}scopeSet(e){e.set("text_w",0),e.set("text_h",0),e.set("mm_fontfamily",Ft),e.set("mm_textfile",jt),e.set("mm_fontfile",Ct)}};const It=new class extends pt{draw(e){const t=e.context,i=_e.createDrawingLike(t);return i.globalAlpha=e.get("mm_t"),i.drawImage(t.canvas,0,0),i.globalAlpha=1,i}};const Ot=new class extends pt{draw(e,t,i){if(me.undefined(i))return;const{context:s}=e,{canvas:r}=s,{x:n,y:a}=t;return i.drawImage(r,n,a),i}scopeSet(e){const{context:t}=e;if(me.undefined(t))throw r.internal+e.constructor.name;const{width:i,height:s}=t.canvas;e.set("overlay_w",i),e.set("overlay_h",s)}};const Et=new class extends pt{draw(e,t){const i=e.context;let s=t.w||t.width,r=t.h||t.height;if(2>s+r)return i;const n=e.get("mm_input_width"),a=e.get("mm_input_height");-1===s?s=n*(r/a):-1===r&&(r=a*(s/n));const o=_e.createDrawing(s,r);return o.drawImage(i.canvas,0,0,n,a,0,0,s,r),o}scopeSet(e){const{context:t}=e;if(!t)throw"context";const{canvas:i}=t;if(!i)throw"canvas";const{width:s,height:r}=i;e.set("in_h",r),e.set("mm_input_height",r),e.set("in_w",s),e.set("mm_input_width",s)}};const Mt=new class extends pt{},At=["blend","chromakey","colorchannelmixer","color","convolution","crop","drawbox","drawtext","fade","overlay","scale","setsar"],St=Object.fromEntries(At.map((e=>[e,e])));class zt extends Je{constructor(){super(),this.install(St.blend,gt),this.install(St.chromakey,_t),this.install(St.colorchannelmixer,yt),this.install(St.color,vt),this.install(St.convolution,wt),this.install(St.crop,xt),this.install(St.drawbox,Tt),this.install(St.drawtext,kt),this.install(St.fade,It),this.install(St.overlay,Ot),this.install(St.scale,Et),this.install(St.setsar,Mt)}create(e){return this.typeClass(e)}createFromObject(e){return this.create(e.id)}}Object.defineProperties(zt.prototype,{type:{value:St},types:{value:At}});const Rt=new zt,Vt={drawFilters:{value:function(e,t){return this.coreFilter.scopeSet(e),this.coreFilter.draw(e,this.evaluateScope(e),t)}}};class Pt extends Me{}class Bt extends Pt{}Object.defineProperties(Bt.prototype,{type:{value:T.filter},...Xe,...ft,parameters:{get:function(){return this.object.parameters}},coreFilter:{get(){return me.undefined(this.__coreFilter)&&(this.__coreFilter=Rt.create(this.id),Ce(this.__coreFilter,pt)),this.__coreFilter}},evaluateScope:{value(e){const t={},i=this.parameters||this.coreFilter.parameters;return me.not(i)||i.forEach((i=>{const{name:s}=i;me.not(s)||(t[s]=e.evaluate(i.value),e.set(s,t[s]))})),t}},...Vt});const qt={filters:{get:function(){return this.__filters||=this.filtersInitialize}},filtersInitialize:{get:function(){return(this.object.filters||[]).map((e=>new Bt(e)))}}},Nt={html:{get:function(){return this.object.html}},inspector:{get:function(){return this.object.inspector}}},Dt={urlsVisibleInTimeRangeForClipByType:{value:function(e,t){const i=new ct,s=this.modularPropertiesByType;return Object.keys(s).forEach((e=>{s[e].forEach((s=>{const n=t.property(s);if(!me.defined(n))throw r.unknown.type+e;{const t=Q.ofType(n,e);me.defined(t)&&i[e].push(t.source)}}))})),i}}},$t={...qt,...Dt,...Nt,...ft};class Ut extends Pt{}Object.defineProperties(Ut.prototype,{type:{value:T.effect},...Xe,...$t,...ut,...mt});class Lt extends Pt{}Object.defineProperties(Lt.prototype,{type:{value:T.scaler},...Xe,...$t,...ut,...Vt});class Wt extends Pt{}Object.defineProperties(Wt.prototype,{type:{value:T.merger},...Xe,...$t,...ut,...Vt});const Gt={modular:{value:!1}},Jt={visible:{value:!1},urlsVisibleInTimeRangeForClipByType:{value:function(){return ct.none}}},Ht={duration:{get:function(){return me.undefined(this.__duration)&&(this.__duration=Number(this.object.duration),this.__duration||=t.media[this.type].duration),this.__duration}}},Xt={propertiesTiming:{value:{frame:{type:"number",value:0},frames:{type:"number",value:0}}}},Kt={audible:{value:!0},propertiesAudible:{value:{gain:{type:"number",value:1},trim:{type:"integer",value:0}}},...{urlsAudibleInTimeRangeForClipByType:{value:function(){const e=new ct,t=this.urlAudible;return t&&e.audio.push(t),e}}}};class Yt extends Pt{}Object.defineProperties(Yt.prototype,{type:{value:T.audio},trackType:{value:O.audio},...Xe,...Gt,...Jt,...Ht,urlAudible:{get:function(){return this.object.audio||this.object.url||this.object.source}},...Kt,...Xt});class Qt extends Pt{}Object.defineProperties(Qt.prototype,{type:{value:T.font},...Xe,...qt,...Dt,...ut});const Zt={urlAudible:{get:function(){switch(this.object.audio){case void 0:return this.object.source;case 0:return}return this.object.audio}}},ei={fps:{get:function(){return this.__fps||=this.object.fps||10}},framesMax:{get:function(){return Math.floor(this.fps*this.duration)}},begin:{get:function(){return this.__begin||=this.object.begin||1}},pattern:{get:function(){return this.__pattern||=this.object.pattern||"%.jpg"}},increment:{get:function(){return this.__increment||=this.object.increment||1}},zeropadding:{get:function(){return this.__zeropadding||=this.zeropaddingInitialize}},zeropaddingInitialize:{get:function(){const e=this.object.zeropadding;if(me.defined(e))return e;const t=this.begin+this.increment*this.framesMax;return String(t).length}},url:{get:function(){return this.__url||=this.object.url||""}},limitedTimeRange:{value:function(e){return e.minEndTime(Fe.createFromFrame(this.framesMax,this.fps))}},urlsVisibleInTimeRangeForClipByType:{value:function(e,t){const i=new ct,s=this.framesMax,r=this.limitedTimeRange(e);let n;for(let e=r.frame;e<r.end;e++){const t=Fe.createFromFrame(e,r.fps).scale(this.fps);if(e!==r.frame&&n===t.frame)continue;n=t.frame,n=Math.min(n,s-1);let a=String(Math.min(n,s)*this.increment+this.begin);this.zeropadding&&(a=a.padStart(this.zeropadding,"0"));const o=(this.url+this.pattern).replaceAll("%",a);i[k.image].push(o)}return i}}};class ti extends Pt{}Object.defineProperties(ti.prototype,{type:{value:T.video},...Xe,...Gt,...mt,...Ht,...Zt,...ei,...Kt,...Xt});const ii={urlsVisibleInTimeRange:{value:function(){return[this.urlVisible]}},urlsVisibleInTimeRangeForClipByType:{value:function(e,t){const i=new ct,s=this.urlVisible;return s&&i[k.image].push(s),i}}};class si extends Pt{}Object.defineProperties(si.prototype,{type:{value:T.image},...Xe,...Gt,...ut,...mt,...Ht,...Xt,urlVisible:{get:function(){return this.object.url}},...ii});class ri extends Pt{}Object.defineProperties(ri.prototype,{type:{value:T.theme},...Xe,...ft,...ut,...mt,...Ht,...qt,...dt,...Xt,...Nt,...Dt});const ni={urlsVisibleInTimeRangeForClipByType:{value:function(){return ct.none}},urlsVisibleInTimeRangeForClipByType:{value:function(){return ct.none}}};class ai extends Pt{}Object.defineProperties(ai.prototype,{type:{value:T.transition},...Xe,...ft,...ut,...mt,...Xt,...Ht,...ni});const oi=new class extends Je{constructor(){super(Pt),this.install(T.audio,Yt),this.install(T.video,ti),this.install(T.image,si),this.install(T.theme,ri),this.install(T.effect,Ut),this.install(T.scaler,Lt),this.install(T.merger,Wt),this.install(T.font,Qt),this.install(T.transition,ai)}create(e){if(me.instanceOf(e,Pt))return e;if(C.includes(e.type)){const t=Q.ofType(e.id,e.type);if(t)return super.create(t)}return super.create(e)}},ci=(e,t,i)=>new ke(e,t,i),li=(e,t)=>ci(e.frame,e.fps,t),hi=(e={})=>{if(me.instanceOf(e,ke))return e;if(me.instanceOf(e,je))return li(e);const{frame:t,fps:i,frames:s}=e;return ci(t,i,s)},ui=li,mi=(e,t)=>{const[i,s]=je.scaleTimes(e,t);if(s.frame<=i.frame)throw r.argument;return ci(i.frame,i.fps,s.frame-i.frame)},di={toJSON:{value:function(){const e={id:this.id,type:this.type,frame:this.frame};return me.array(this.effects)&&(e.effects=this.effects),{...this.propertyValues,...e}}}},fi={id:{get:function(){return this.object.id||this.media.id}}},pi={label:{get:function(){return this.__label||=this.labelInitialize},set:function(e){this.__label=e}},labelInitialize:{get:function(){return this.object.label||this.media.label}}},gi={media:{get:function(){return me.undefined(this.__media)&&(this.__media=oi.create(this.object.media)),this.__media}}},_i={propertyValues:{get:function(){return Object.fromEntries(Object.keys(this.properties).map((e=>{const t=this[e];return[e,A.includes(e)?t.id:t]})))}}},vi={properties:{get:function(){return this.media.properties}}},yi={...He,propertyNames:{get:function(){return Object.keys(this.properties)}},properties:{get:function(){return this.__properties||=this.propertiesInitialize}},propertiesInitialize:{get:function(){const e={...this.media.properties};return this.propertiesTransform&&Object.assign(e,this.propertiesTransform),e}}},bi={...yi,copy:{get:function(){return new this.constructor({...this.toJSON(),media:this.media})}},...di,...fi,...pi,...De,time:{value:function(e){return Fe.createFromFrame(this.frame,e)}},timeRange:{value:function(e){const t={frame:this.frame,quantize:e,frames:this.frames};return hi(t)}},timeRangeRelative:{value:function(e){const t=this.timeRange(e.fps),i=e.frame-this.frame;if(!(i<0))return t.withFrame(i);console.log(this.constructor.name,"timeRangeRelative",e,t)}},...gi,..._i,...vi,load:{value:function(e){return this.urlsVisibleInTimeRangeByType(e).load()}}},wi={audible:{value:!1},urlsAudibleInTimeRangeByType:{value:function(){return ct.none}}},xi={visible:{value:!0},trackType:{value:O.video},scaledContextAtTimeForDimensions:{value:function(e,t,...i){const s=this.contextAtTimeForDimensions(e,t,...i);if(!this.scaler)return s;const r=this.timeRangeRelative(e);return me.undefined(r)?void 0:this.scaler.drawMediaFilters(r,s,t)}},effectedContextAtTimeForDimensions:{value:function(e,t,...i){let s=this.scaledContextAtTimeForDimensions(e,t,...i);if(!this.effects)return s;const r=this.timeRangeRelative(e);return me.undefined(r)?void 0:(this.effects.reverse().forEach((e=>s=e.drawMediaFilters(r,s,t))),s)}},mergeContextAtTime:{value:function(e,t,...i){if(!this.merger)return t;const s=this.effectedContextAtTimeForDimensions(e,t.canvas,...i),r=this.timeRangeRelative(e);return me.undefined(r)?void 0:this.merger.drawMerger(r,s,t)}}},Ti={urlsVisibleInTimeRangeByType:{value:function(e){const t=this.mediaTimeRange(e),i=this.media.urlsVisibleInTimeRangeForClipByType(t,this);return this.merger&&i.concat(this.merger.urlsVisibleInTimeRangeByType(t)),this.scaler&&i.concat(this.scaler.urlsVisibleInTimeRangeByType(t)),this.effects&&this.effects.forEach((e=>i.concat(e.urlsVisibleInTimeRangeByType(t)))),i}}},Ci={id:{get:function(){return this.__id||=this.object.id},set:function(e){this.__id=e,this.__media=null}}},ji={urlsVisibleInTimeRangeByType:{value:function(e){return this.media.urlsVisibleInTimeRangeForClipByType(e,this)}}},Fi={media:{get:function(){return this.__media||=this.mediaInitialize}},mediaInitialize:{get:function(){if(this.object.media)return oi.create(this.object.media);const e=Q.ofType(this.id,this.type);if(!e)throw r.unknown[this.type]+this.type+" "+this.id;return oi.create(e)}}},ki=["mm_width","mm_height"],Ii=["mm_dimensions","mm_duration","mm_fps","mm_height","mm_t","mm_width","t"],Oi=["ceil","floor","mm_cmp","mm_horz","mm_max","mm_min","mm_vert",...Ii,...ki],Ei="evaluator";function Mi(e,t,i){if(!me.instanceOf(e,ke))throw r.argument+e;if(!me.object(e))throw r.argument+t;if(!me.object(i))throw r.argument+i;this.timeRange=e,this.context=t,this.dimensions=i,this.map=new Map}const Ai=e=>{const t=e.condition;if(me.defined(e.is))return`${t}==${e.is}`;const i=e.in;if(me.undefined(i))return t;const s=me.string(i)?i.split(","):i,r=me.string(s[0]),n=s.map((e=>r?`"${e}"`:e)),a=r?"String":"Number";return`([${n.join(",")}].includes(${a}(${t})))`},Si=e=>e.replaceAll(" or "," || ").replaceAll(" and "," && ");Object.defineProperties(Mi.prototype,{canvas:{get:function(){return this.context.canvas}},ceil:{value:Math.ceil},replaceKeys:{value:function(e){if(!me.string(e))return e;const t=Object.fromEntries(this.keys.map((e=>[e,new RegExp(`\\b${e}\\b`,"g")])));return Object.entries(t).forEach((([t,i])=>{e=e.replaceAll(i,`${Ei}.get("${t}")`)})),e}},conditionalValue:{value:function(e){if(!me.array(e))return e;let t=!1;for(let i of e){const e=Si(Ai(i));if(t=this.evaluateExpression(e),t)return i.value}throw r.internal+"no conditions were true"}},evaluate:{value:function(e){const t=this.conditionalValue(e);return this.evaluateExpression(t)}},evaluateExpression:{value:function(e){const t=`return ${this.replaceKeys(e)}`;try{return new Function(Ei,t)(this)}catch(t){return e}}},floor:{value:Math.floor},get:{value:function(e){if(this.map.has(e))return this.map.get(e);const t=this[e];return Ii.includes(e)?t:me.method(t)?t.bind(this):(console.log("Evaluator.get",e,t),t)}},keys:{get:function(){return[...new Set([...this.map.keys(),...Oi])]}},mm_cmp:{value:function(e,t,i,s){return e>t?i:s}},mm_dimensions:{get:function(){return`${this.mm_width}x${this.mm_height}`}},mm_duration:{get:function(){return this.timeRange.lengthSeconds}},mm_fps:{get:function(){return this.timeRange.fps}},mm_height:{get:function(){return this.dimensions.height}},mm_horz:{value:function(e,t){return this.sized(0,e,t)}},mm_max:{value:Math.max},mm_min:{value:Math.min},mm_t:{get:function(){return this.timeRange.position}},mm_vert:{value:function(e,t){return this.sized(1,e,t)}},mm_width:{get:function(){return this.dimensions.width}},set:{value:function(e,t){this.map.set(e,t)}},sized:{value:function(e,t,i){const s=me.float(t)?t:parseFloat(t),r=parseFloat(this[ki[e]]),n=r*s;if(!i)return n;const a=parseFloat(this[ki[Math.abs(e-1)]]);return a<=r?n:r+(s-1)*a}},t:{get:function(){return this.mm_duration}}});const zi={evaluator:{value:function(e,t,i){const s=new Mi(e,t,i);return this.media.properties&&Object.keys(this.media.properties).forEach((e=>{let t=this[e];if(me.undefined(t)){console.log("this lacked property",e,this);const i=this.media.properties[e];if(t=i.value,me.undefined(t)&&(console.log("Transform.draw media lacked property value",i),t=fe.propertyTypeDefault(i.type),me.undefined(t)))throw r.unknown.type+i.type}s.set(e,t)})),s}}},Ri={...yi,copy:{get:function(){return new this.constructor(this.toJSON())}},...Fi,...pi,..._i,...ji,...zi,toJSON:{value:function(){const e={id:this.id,type:this.type};return{...this.propertyValues,...e}}},...vi};class Vi{constructor(e){this.object=e,this.media.initializeInstance(this,e)}}Object.defineProperties(Vi.prototype,{...Ri});class Pi extends Vi{}Object.defineProperties(Pi.prototype,{type:{value:j.merger},...Ci,drawMerger:{value:function(e,t,i){return this.media.filters.forEach((s=>{s.drawFilters(this.evaluator(e,t,i.canvas),i)})),i}}});const Bi={drawMediaFilters:{value:function(e,t,i){return this.media.filters.forEach((s=>{t=s.drawFilters(this.evaluator(e,t,i))})),t}}};class qi extends Vi{}Object.defineProperties(qi.prototype,{type:{value:j.scaler},...Ci,...Bi});class Ni extends Vi{}Object.defineProperties(Ni.prototype,{type:{value:j.effect},...fi,...Bi});const Di={effects:{get:function(){return this.__effects||=this.effectsInitialize}},effectsInitialize:{get:function(){return(this.object.effects||[]).map((e=>new Ni(e)))}},merger:{get:function(){return this.__merger||=this.mergerInitialize},set:function(e){this.__merger=new Pi({id:e})}},mergerInitialize:{get:function(){const e=this.object.merger||Q.objectWithDefaultId(j.merger);return new Pi(e)}},scaler:{get:function(){return this.__scaler||=this.scalerInitialize},set:function(e){this.__scaler=new qi({id:e})}},scalerInitialize:{get:function(){const e=this.object.scaler||Q.objectWithDefaultId(j.scaler);return new qi(e)}},coreFilters:{get:function(){const e=[];return me.defined(this.media.filters)&&e.push(...this.media.filters),me.defined(this.merger)&&e.push(...this.merger.media.filters),me.defined(this.scaler)&&e.push(...this.scaler.media.filters),me.defined(this.effects)&&e.push(...this.effects.flatMap((e=>e.media.filters))),e}}},$i={contextAtTimeForDimensions:{value:function(e,t){const i=ui(e),s=this.media.urlsVisibleInTimeRangeForClipByType(i,this).image[0],n=Ye.get(s);if(!me.object(n))throw r.uncached+s+" contextAtTimeForDimensions";const{width:a,height:o}=n;let c=_e.createDrawing(a,o);return c.drawImage(n,0,0,a,o,0,0,a,o),c}}};class Ui{constructor(e){this.object=e,this.media.initializeInstance(this,e)}}const Li={mediaTime:{value:function(e){return e}},mediaTimeRange:{value:function(e){return e}}};class Wi extends Ui{}Object.defineProperties(Wi.prototype,{type:{value:y.image},...bi,...xi,...wi,...Ti,...Di,...$i,...Li});const Gi={visible:{value:!1},trackType:{value:O.audio},urlsVisibleInTimeRangeByType:{value:function(){return ct.none}}},Ji={audible:{get:function(){const e=this.media.audible&&!this.muted;return e||console.log(this.constructor.name,"audible false:",this.media.audible,!this.muted),e}},muted:{get:function(){switch(this.gain){case 0:case"0":case"0,0,1,0":return!0}return!1}},urlsAudibleInTimeRangeByType:{value:function(e){const t=this.mediaTimeRange(e);return this.media.urlsAudibleInTimeRangeForClipByType(t)}},mediaTime:{value:function(e,t=!1){const i=Fe.createFromFrame(this.frame+this.frames,e.quantize),s=e.min(i),r=Fe.createFromFrame(this.frame,e.quantize);let n=s.subtract(r);if(t){const e=this.speed?Math.ceil(this.speed):1;n=n.add(Fe.createFromFrame(e,this.quantize))}return this.trim&&(n=n.add(Fe.createFromFrame(this.trim,this.quantize))),this.speed&&(n=n.divide(this.speed,"ceil")),n}},mediaTimeRange:{value:function(e){const t=e.frames>1;return mi(this.mediaTime(e.startTime),this.mediaTime(e.endTime,t))}}},Hi={mediaTime:{value:function(e,t=!1){const i=Fe.createFromFrame(this.frame+this.frames,e.quantize),s=e.min(i),r=Fe.createFromFrame(this.frame,e.quantize);let n=s.subtract(r);if(t){const e=this.speed?Math.ceil(this.speed):1;n=n.add(Fe.createFromFrame(e,this.quantize))}return this.trim&&(n=n.add(Fe.createFromFrame(this.trim,this.quantize))),this.speed&&(n=n.divide(this.speed,"ceil")),n}},mediaTimeRange:{value:function(e){const t=e.frames>1;return mi(this.mediaTime(e.startTime),this.mediaTime(e.endTime,t))}}};class Xi extends Ui{}function Ki(e){this.object=e}Object.defineProperties(Xi.prototype,{type:{value:y.audio},...bi,...Gi,...Ji,...Hi}),Object.defineProperties(Ki.prototype,{type:{value:y.video},...bi,...xi,...Ji,...Ti,...Di,...Hi});class Yi extends Ui{}Object.defineProperties(Yi.prototype,{type:{value:y.theme},...bi,...wi,...xi,speed:{get:function(){return 1}},...Ti,...wi,...Di,...zi,...Bi,...Li,contextAtTimeForDimensions:{value:function(e,t){const i=_e.createDrawing(t.width,t.height),s=this.timeRangeRelative(e);if(!me.undefined(s))return this.drawMediaFilters(s,i,t)}}});const Qi=["to","from"],Zi=Object.fromEntries(Qi.map((e=>[e,e])));class es extends Ui{constructor(e){super(e),this.children=Object.fromEntries(Qi.map((e=>[e,{}])))}}const ts={type:{value:y.transition},...bi,...xi,...ji,...Li,contextAtTimeForDimensions:{value:function(e,t,i,s=[]){const r=s.sort(n),a=_e.createDrawing(t.width,t.height);vt.draw({context:a},{color:i});const[o,c]=r,l={[Zi.to]:me.object(c)&&c,[Zi.from]:me.object(o)&&o};return Qi.forEach((s=>{const r=l[s];if(!r)return;const n=_e.createDrawing(t.width,t.height);vt.draw({drawing:n},{color:i}),r.mergeContextAtTime(e,n);const o=this.child(s,S.merger),c=this.child(s,S.scaler),h=this.timeRangeRelative(e);if(me.undefined(h))return;const u=c.drawMediaFilters(h,n,t);o.drawMerger(h,u,a)})),a}},initializeChild:{value:function(e,t){return new(t===S.merger?Pi:qi)(this.object[e])}},child:{value:function(e,t){return this[`${e}${Ee(t)}`]}}};function is(e){this.object=e}Qi.forEach((e=>{ts[e]={get:function(){return me.undefined(this.children[e])&&(this.children[e]={}),this.children[e]}},A.forEach((t=>{ts[`${e}${Ee(t)}`]={get:function(){if(me.undefined(this.children[e][t])){const i=this.initializeChild(e,t);this.children[e][t]=i}return this.children[e][t]}}}))})),Object.defineProperties(es.prototype,ts),Object.defineProperties(is.prototype,{type:{value:y.frame},...bi,...xi,...Ti,...Li});const ss=new class extends Je{constructor(){super(Ui),this.install(y.audio,Xi),this.install(y.frame,is),this.install(y.image,Wi),this.install(y.theme,Yi),this.install(y.transition,es),this.install(y.video,Ki)}createFromObjectMedia(e={},t={},i={}){if(!me.object(e))throw r.object;if(!me.object(t))throw r.media;me.integer(e.frames)||(e.frames=Fe.createFromSeconds(t.duration,i.quantize,"floor").frame),e.media||=t;const s=e.type||t.type;if(t.type||=s,e.type||=s,!v.includes(s))throw r.unknown.type;return this.createFromObject(e)}createFromMedia(e,t){const i={id:e.id,type:e.type};return this.createFromObjectMedia(i,e,t)}};class rs extends Me{constructor(e,t){super(e),this.mash=t,this.object.index||=0,this.object.type||=O.video}get clips(){return this.__clips||=this.initializeClips}get initializeClips(){return(this.object.clips||[]).map((e=>{const t=this.mash.searchMedia(e.id);return ss.createFromObjectMedia({track:this.index,...e},t)}))}get frames(){if(!this.clips.length)return 0;const e=this.clips[this.clips.length-1];return e.frame+e.frames}get index(){return this.object.index}get isMainVideo(){return!this.index&&this.type==O.video}get type(){return this.object.type}addClips(e,t=0){t||=0,this.isMainVideo||(t=0);const i=t,s=[],r=this.clips.filter(((r,n)=>{const a=e.includes(r);return a&&s.push(r),i&&a&&n<i&&t--,!a}));r.splice(t,0,...e),this.sortClips(r);e.filter((e=>!s.includes(e))).forEach((e=>e.track=this.index)),this.clips.splice(0,this.clips.length,...r)}frameForClipsNearFrame(e,t=0){return this.clips.filter((t=>!e.includes(t))),t}removeClips(e){const t=this.clips.filter((t=>!e.includes(t)));if(t.length===this.clips.length)throw console.log("removeClips",this.type,this.index,this.clips),r.internal+JSON.stringify(e);e.forEach((e=>e.track=-1)),this.sortClips(t),this.clips.splice(0,this.clips.length,...t)}sortClips(e){if(e||=this.clips,this.isMainVideo){let t=0;e.forEach(((e,i)=>{const s=e.type===O.transition;i&&s&&(t-=e.frames),e.frame=t,s||(t+=e.frames)}))}e.sort(n)}toJSON(){return{type:this.type,index:this.index,clips:this.clips}}}const ns=new class extends Je{create(e,t){if(!me.object(e))throw r.object;return e instanceof rs?e:new rs(e,t)}},as={label:"label",backcolor:"backcolor"};class os extends Me{static get properties(){return Object.values(as)}get audio(){return this.__audio||=this.initializeAudio}get backcolor(){return this.__backcolor||=this.object.backcolor||t.mash.backcolor}set backcolor(e){this.__backcolor=e}get clips(){return this.tracks.map((e=>e.clips)).flat()}get clipsAudible(){return this.clips.filter((e=>e.audible))}get clipsAudio(){return this.audio.map((e=>e.clips)).flat()}get clipsVideo(){return this.video.flatMap((e=>e.clips))}get events(){return this.__events||=this.object.events}set events(e){this.__events=e}get frames(){return Math.max(0,...this.tracks.map((e=>e.frames)))}get initializeAudio(){return(this.object.audio||[{type:O.audio}]).map((e=>ns.create(e,this)))}get initializeMedia(){return(this.object.media||[]).map((e=>oi.create(e)))}get initializeVideo(){return(this.object.video||[{type:O.video}]).map((e=>ns.create(e,this)))}get initialMedia(){return this.__initialMedia||=this.initializeMedia}get label(){return this.__label||=this.object.label||t.mash.label}set label(e){this.__label=e}get media(){return[...new Set(this.clips.flatMap((e=>this.mediaForClip(e))))]}get propertyValues(){return Object.fromEntries(os.properties.map((e=>[e,this[e]])))}get quantize(){return this.__quantize||=this.object.quantize||t.mash.quantize}get tracks(){return I.map((e=>this[e])).flat()}get type(){return"mash"}get video(){return this.__video||=this.initializeVideo}addClipsToTrack(e,t=0,i=0){t||=0,i||=0;const[s]=e,r=this.clipTrackAtIndex(s,t),n=this.clipTrack(s);this.emitIfFramesChange((()=>{n&&n!==r&&n.removeClips(e),r.addClips(e,i)}))}addTrack(e){const t=this[e],i={type:e,index:t.length},s=ns.create(i,this);return t.push(s),s}changeClipFrames(e,t){let i=Math.max(1,t);if(I.includes(e.type)){const t=Math.floor(e.media.duration*this.quantize)-e.trim;i=Math.min(t,i)}const s=this.clipTrack(e);this.emitIfFramesChange((t=>{e.frames=i,s.sortClips()}))}changeClipTrim(e,t,i){let s=Math.max(0,t);if(I.includes(e.type)){const t=Math.floor(e.media.duration*this.quantize)-1;s=Math.min(t,s)}const r=i-s,n=this.clipTrack(e);this.emitIfFramesChange((()=>{e.trim=s,e.frames=r,n.sortClips()}))}clipIntersects(e,t){return e.timeRange(this.quantize).intersects(t)}clipTrack(e){return this.clipTrackAtIndex(e,e.track)}clipTrackAtIndex(e,t=0){return this.trackOfTypeAtIndex(e.trackType,t)}clipsAudibleAtTime(e){return this.clipsWithin(e,!0,!1)}clipsAudibleInTimeRange(e){const t=e.scale(this.quantize);return this.clips.filter((e=>e.audible&&this.clipIntersects(e,t)))}clipsVisibleAtTime(e){return this.clipsWithin(e,!1)}clipsVisibleInTimeRange(e){const t=e.scale(this.quantize);return this.clipsVideo.filter((e=>this.clipIntersects(e,t)))}clipsWithin(e,t=!0,i=!0){const s=hi(e);return t?i?this.clips.filter((e=>this.clipIntersects(e,s))):this.clipsAudibleInTimeRange(s):this.clipsVisibleInTimeRange(s)}emitDuration(){const e={value:Fe.createFromFrame(this.frames,this.quantize).seconds};this.events.emit(w.duration,e)}emitIfFramesChange(e){const t=this.events?this.frames:null;e(),this.events&&t!==this.frames&&this.emitDuration()}findInitialMedia(e){return this.initialMedia.find((t=>t.id===e))}findClipMedia(e){return this.media.find((t=>t.id===e))}findMedia(e){if(!me.string(e)||!e.length)return;const t=this.findInitialMedia(e);return t||this.findClipMedia(e)}filterClipSelection(e){const t=(me.array(e)?e:[e]).filter((e=>me.instanceOf(e,Ui))),[i]=t;if(!i)return[];const{trackType:s,track:r}=i,a=t.filter((e=>e.track===r&&e.trackType===s)).sort(n);if(r||s===O.audio)return a;let o=!0;return a.filter(((e,t)=>{if(o)return t===a.length-1||(o=e.frame+e.frames===a[t+1].frame,o||console.log(this.constructor.name,"filterClipSelection",e.frame+e.frames,"!==",a[t+1].frame)),!0}))}mediaForClip(e){const t=[],i=e.media;if(!me.object(i))throw"CLIP HAS NO MEDIA "+e;if(t.push(i),e.scaler&&t.push(e.scaler.media),e.merger&&t.push(e.merger.media),i.modular){const s=i.modularPropertiesByType;Object.keys(s).forEach((i=>{s[i].forEach((s=>{const r=this.searchMedia(e[s],i);r&&t.push(r)}))}))}switch(i.type){case T.transition:t.push(...this.mediaForClipTransform(e.to)),t.push(...this.mediaForClipTransform(e.from));break;case T.effect:case T.audio:break;default:{t.push(...this.mediaForClipTransform(e));const i=e.effects;if(!i)break;i.forEach((e=>{t.push(...this.mediaForClip(e))}))}}return t}mediaForClipTransform(e){const t=[];return me.object(e)&&[T.merger,T.scaler].forEach((i=>{const s=e[i];if(me.object(s)){const e=this.searchMedia(s.id,i);e&&t.push(e)}})),t}mediaReferences(){const e={};return this.clips.forEach((t=>{this.mediaForClip(t).forEach((t=>{e[t.id]||=0,e[t.id]++}))})),e}removeClipsFromTrack(e){const[t]=e,i=this.clipTrack(t);this.emitIfFramesChange((()=>i.removeClips(e)))}removeTrack(e){const t=this[e];this.emitIfFramesChange((()=>t.pop()))}searchMedia(e,t){const i=this.findInitialMedia(e);if(i)return i;switch(t){case T.filter:return Rt.created(e)?Rt.create(e):Q.defaultOfType(t)}const s=Q.defaultOfType(t);return s||this.findClipMedia(e)}toJSON(){return{label:this.label,quantize:this.quantize,backcolor:this.backcolor,id:this.id,media:this.media,audio:this.audio,video:this.video}}trackOfTypeAtIndex(e,t=0){if(!(t<0)){if(me.not(e))throw r.type;return this[e][t]}}urlsAudibleInTimeRangeForClipsByType(e,t){const i=e.scale(this.quantize),s=new ct;return t.forEach((e=>s.concat(e.urlsAudibleInTimeRangeByType(i)))),s}urlsForClipsWithin(e,t,i=!0,s=!0){const r=hi(t),n=new ct;return i||n.concat(this.urlsVisibleInTimeRangeForClipsByType(r,e)),s||n.concat(this.urlsAudibleInTimeRangeForClipsByType(r,e)),n}urlsVisibleInTimeRangeForClipsByType(e,t){const i=e.scale(this.quantize),s=new ct;return t.forEach((e=>s.concat(e.urlsVisibleInTimeRangeByType(i)))),s}urlsWithin(e,t=!0,i=!0){const s=this.clipsWithin(e,t,i);return this.urlsForClipsWithin(s,e,t,i)}}Object.defineProperties(os.prototype,{...Ge});class cs extends Me{constructor(e){super(e),this.methods=new Set}get target(){return this.object.target}set target(e){if(this.object.target!==e){if(!me.instanceOf(e,EventTarget))throw r.object;const t=new Set(this.methods);t.forEach(this.removeListener,this),this.object.target=e,t.forEach(this.addListener,this)}}addListener(e){this.methods.add(e)&&this.target&&this.target.addEventListener(cs.type,e)}emit(e,t={}){const i={detail:{type:e,...t}};this.target&&this.target.dispatchEvent(new CustomEvent(cs.type,i))}removeListener(e){this.methods.delete(e)&&this.target&&this.target.removeEventListener(cs.type,e)}}Object.defineProperties(cs,{type:{value:"masher"}});const ls={videoContext:{get:function(){return this.__videoContext||=this.object.videoContext||_e.createVideo(),this.__videoContext},set:function(e){this.__videoContext=e,this.composition&&(this.composition.videoContext=e)}},audioContext:{get:function(){return this.__audioContext||=this.object.audioContext||_e.createAudio(),this.__audioContext},set:function(e){this.__audioContext=e,this.composition&&(this.composition.audioContext=e)}}};class hs extends Me{constructor(e){super(e),this.object.bufferSeconds||=t.bufferSeconds,this.paused=!0,this.playing=!1,this.sourcesByClip=new Map,this.__mashSeconds=0,this.__contextSeconds=0}get audible(){return!this.paused&&!!this.audioContext}get bufferedTime(){return this.urlsAtTime.loaded}get bufferedTimeRange(){return this.urlsInTimeRange.loaded}get bufferSeconds(){return this.object.bufferSeconds}set bufferSeconds(e){this.object.bufferSeconds=e}get clipsAtTime(){return this.mash.clipsWithin(this.time,this.audible,this.visible)}get clipsInTimeRange(){return this.mash.clipsWithin(this.timeRange,this.audible,this.visible)}get configured(){return this.time&&this.mash&&(this.videoContext||this.audioContext)}get gain(){return me.undefined(this.__gain)&&(this.__gain=this.__gainInitialize),this.__gain}get __gainInitialize(){return me.defined(this.object.gain)?this.object.gain:t.volume}set gain(e){if(this.__gain!==e){if(this.__gain=e,!this.playing)return;this.clipsAtTime.forEach(this.adjustSourceGain)}}get mash(){return this.object.mash}set mash(e){this.object.mash=e}get quantize(){return this.mash?this.mash.quantize:1}get seconds(){return this.audioContext.currentTime-this.__contextSeconds+this.__mashSeconds}get time(){return this.__time}set time(e){if(!me.instanceOf(e,je))throw r.time;this.__time=e}get timeRange(){const e=Fe.createFromSeconds(this.bufferSeconds),t=this.time.add(e);return mi(this.time,t)}get timeRangeAtTime(){return ui(this.time)}get urlsAtTime(){return this.urlsInTimeRangeByType(this.timeRangeAtTime)}get urlsInTimeRange(){return this.urlsInTimeRangeByType(this.timeRange)}get visible(){return!!this.videoContext}adjustSourceGain(e){const t=this.sourcesByClip.get(e);if(me.undefined(t))return;const{gainNode:i}=t;if(0===this.gain)return i.gain.value=0;const{gain:s}=e;if(!me.array(s))return i.gain.value=s*this.gain;const r=this.clipTiming(e),{start:n,duration:a}=r;i.cancelScheduledValues(0);const o=s.split(","),c=o.length/2;for(let e=0;e<c;e++){const t=o[2*e],s=this.gain*o[2*e+1],r=n+t*a;i.gain.linearRampToValueAtTime(s,r)}}clipsToDraw(e){const t=this.clipsAtTime;(e=>{e.forEach((e=>{if(!e.frames)throw r.frames+JSON.stringify(e)}))})(t);const i=this.urlsInTimeRangeByType(this.timeRangeAtTime);if(!i.loaded){if(!e)return;throw r.uncached+i.urlsUnloaded[0]}return t}clipTiming(e){const t={offset:0},i=e.timeRange(this.quantize),s=this.__contextSeconds-this.__mashSeconds;t.start=s+i.seconds,t.duration=i.lengthSeconds,e.trim&&(i.frame=e.trim,t.offset=i.seconds);const r=this.audioContext.currentTime;if(r>t.start){const e=r-t.start;t.start=r,t.offset+=e,t.duration-=e}return t}createSources(){this.clipsInTimeRange.filter((e=>!this.sourcesByClip.has(e))).forEach((e=>{const t=e.media.urlAudible;if(t&&Ye.cached(t)){const i=this.clipTiming(e),{start:s,duration:r,offset:n}=i;if(me.positive(s)&&me.positive(r)&&r>0){const i=this.audioContext.createBufferSource();i.buffer=Ye.get(t);const a=this.audioContext.createGain();i.connect(a),a.connect(this.audioContext.destination),i.start(s,n,r),this.sourcesByClip.set(e,{gainSource:i,gainNode:a}),this.adjustSourceGain(e)}}}))}destroySources(e=[]){this.sourcesByClip.forEach(((t,i)=>{if(e.includes(i))return;const{gainSource:s,gainNode:r}=t;r.disconnect(this.audioContext.destination),s.disconnect(r),this.sourcesByClip.delete(i)}))}draw(){this.configured&&this.drawClips(this.time,this.clipsToDraw(!0))}drawBackground(e){if(!me.objectStrict(e))throw r.internal;e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=we(this.mash.backcolor),e.fillRect(0,0,e.canvas.width,e.canvas.height)}drawClips(e,t){const i=t.filter((e=>e.visible&&0===e.track));if(this.drawBackground(this.videoContext),i.length>1){const t=i.find((e=>e.type===y.transition));if(!t)throw r.mainTrackOverlap;const s=i.filter((e=>e.type!==y.transition));t.mergeContextAtTime(e,this.videoContext,this.mash.backcolor,s)}else{const[t]=i;t&&t.mergeContextAtTime(e,this.videoContext)}t.filter((e=>!i.includes(e))).sort(a).forEach((t=>{t.mergeContextAtTime(e,this.videoContext)}))}drawFrame(){if(!this.configured)return;const e=this.clipsToDraw();if(!me.undefined(e))return requestAnimationFrame((()=>this.drawClips(this.time,e))),!0;this.loadTimeRange()}loadTimeRange(){this.audible&&(this.createSources(),this.destroySources(this.clipsInTimeRange));return this.urlsInTimeRangeByType(this.timeRange).load(this.audioContext)}urlsInTimeRangeByType(e){return this.mash.urlsWithin(e,this.audible,this.visible)}loadTime(){return this.urlsInTimeRangeByType(this.time).load(this.audioContext)}startPlaying(){if(console.log(this.constructor.name,"startPlaying"),this.__bufferSource)throw r.internal;if(this.playing)throw r.internal;this.playing=!0,this.__bufferSource=this.audioContext.createBufferSource(),this.__bufferSource.loop=!0,this.__bufferSource.buffer=this.audioContext.createBuffer(2,44100,44100),this.__bufferSource.connect(this.audioContext.destination),this.__mashSeconds=this.time.seconds,this.__contextSeconds=this.audioContext.currentTime,console.log("__mashSeconds",this.__mashSeconds),console.log("__contextSeconds",this.__contextSeconds),this.createSources(),this.__bufferSource.start(0)}stopPlaying(){console.log(this.constructor.name,"stopPlaying"),this.playing&&(this.playing=!1,this.__bufferSource&&this.__bufferSource.stop(),this.destroySources(),this.__mashSeconds=0,this.__contextSeconds=0,this.__bufferSource&&(this.__bufferSource.disconnect(this.audioContext.destination),this.__bufferSource=null))}}Object.defineProperties(hs.prototype,{...ls});const us=["addTrack","addClipsToTrack","moveClips","addEffect","change","changeFrames","changeTrim","changeGain","moveEffects","split","freeze","removeClips"],ms=Object.fromEntries(us.map((e=>[e,e])));class ds extends Je{constructor(){super(Ae),this.install(ms.addTrack,Se),this.install(ms.addClipsToTrack,qe),this.install(ms.moveClips,Ne),this.install(ms.addEffect,Be),this.install(ms.change,ze),this.install(ms.changeFrames,Ve),this.install(ms.changeTrim,Pe),this.install(ms.split,Ue),this.install(ms.freeze,Re),this.install(ms.moveEffects,Le),this.install(ms.removeClips,$e)}createFromObjectMasher(e,t){const i={...e};return Object.entries({mash:"",undoSelectedClips:"selectedClips",undoSelectedEffects:"selectedEffects",redoSelectedClips:"selectedClips",redoSelectedEffects:"selectedEffects"}).forEach((s=>{const[r,n]=s;me.defined(e[r])||(me.emptystring(n)?i[r]=t[r]:i[r]=[...t[n]])})),this.createFromObject(i)}}Object.defineProperties(ds.prototype,{type:{value:ms},types:{value:us}});const fs=new ds,ps={uuid:{value:function(){return ve()}},canvas_context:{get:function(){return console.warn(r.deprecation.canvas_context.get),this.videoContext},set:function(e){console.warn(r.deprecation.canvas_context.set),this.videoContext=e}},buffertime:{get:function(){return this.buffer},set:function(e){this.buffer=e}},minbuffertime:{get:function(){return this.buffer},set:function(e){this.buffer=e}}},gs={autoplay:"autoplay",precision:"precision",loop:"loop",fps:"fps",volume:"volume",buffer:"buffer"},_s=(e,t,i)=>{if(!me.object(e))return;let s=ui(t);const r=e.timeRange(i);if(!r.intersects(s))return;const n=s.scale(r.fps);return n.frame!==r.frame&&n.end!==r.end||void 0};class vs extends Me{constructor(e={}){super(e),this.object.canvas||=_e.createCanvas(),this.events=new cs({target:this.canvas}),this.events.addListener(this.handleMasher.bind(this)),this.__load_timer=!1,this.__moving=!1,this.__muted=!1,this.__paused=!0,this.__mashFrames=0,this.__time=Fe.createFromFrame(0,this.fps),this.__drawnTime=Fe.createFromFrame(0,this.fps);const t=this.object.mash||{};this.object.mash=!1,this.mash=t}get action_index(){return this.__actions.index}get autoplay(){return me.undefined(this.__autoplay)&&(this.__autoplay=this.initializeProperty(gs.autoplay)),this.__autoplay}set autoplay(e){this.__autoplay=e}get composition(){if(!this.__composition){const e={bufferSeconds:this.buffer,gain:this.gain,mash:this.mash,audioContext:this.audioContext,videoContext:this.videoContext};this.__composition=new hs(e),this.__composition.time=this.time}return this.__composition}get buffer(){if(me.undefined(this.__buffer)){const e=[gs.buffer,"buffertime","minbuffertime"];this.__buffer=this.initializeProperty(...e)}return this.__buffer}set buffer(e){this.__buffer!==e&&(this.__buffer=e,this.composition.bufferSeconds=e)}get bufferedTimeRange(){return this.composition.bufferedTimeRange}get canvas(){return this.videoContext.canvas}set canvas(e){this.videoContext=_e.createVideo(e),this.events.target=e}get configured(){return this.mash&&this.canvas}get currentTime(){return this.time.seconds}set currentTime(e){this.time=Fe.createFromSeconds(e,this.fps)}get duration(){return Fe.createFromFrame(this.__mashFrames,this.mash.quantize).seconds}get endTime(){return this.mashEndTime.scale(this.fps,"floor")}get fps(){return me.undefined(this.__fps)&&(this.__fps=this.initializeProperty(gs.fps)),this.__fps}set fps(e){if(!me.integer(e)||e<1)throw r.fps;this.__fps!==e&&(this.__fps=e,this.__time=this.__time.scale(e),this.__drawnTime=this.__drawnTime.scale(e))}get frame(){return this.time.frame}set frame(e){this.time=Fe.createFromFrame(e,this.fps)}get frames(){return this.mashEndTime.scale(this.fps).frame}get gain(){return this.muted?0:this.volume}get loop(){return me.undefined(this.__loop)&&(this.__loop=this.initializeProperty(gs.loop)),this.__loop}set loop(e){this.__loop=e}get mash(){return this.__mash||=this.object.mash}set mash(e){this.__mash!==e&&(this.paused=!0,this.__selectedEffects=[],this.__mash=new os(e),this.__mash.events=this.events,this.__actions=new We({mash:this.__mash,masher:this}),this.selectedClips=[],this.handleChangeMashFrames(),this.composition.mash=this.mash,this.time=Fe.createFromSeconds(0,this.fps),this.rebuffer(),this.redraw(),this.autoplay&&(this.paused=!1))}get mashEndTime(){return Fe.createFromFrame(this.__mashFrames,this.mash.quantize)}get muted(){return this.__muted}set muted(e=!1){this.__muted=e,this.handleGainChange()}get paused(){return this.__paused}set paused(e){this.__mashFrames||(e=!0),this.__paused!==e&&(this.__paused=e,this.composition.paused=e,this.__paused?(this.__set_moving(!1),this.__buffer_timer&&(clearInterval(this.__buffer_timer),this.__buffer_timer=0)):(this.__buffer_timer||(this.__buffer_timer=setInterval(this.rebuffer,2e3)),this.rebuffer(),this.redraw()))}get position(){let e=0;return this.__time.frame&&(e=this.__time.seconds/this.duration,1!==e&&(e=parseFloat(e.toFixed(this.precision)))),e}set position(e=0){this.time=Fe.createFromSeconds(this.duration*e,this.fps)}get position_step(){const e="0".repeat(this.precision-1);return parseFloat(`0.${e}1`)}get precision(){return me.undefined(this.__precision)&&(this.__precision=this.initializeProperty(gs.precision)),this.__precision}set precision(e){this.__precision=e}get selectedClip(){if(1===this.__selectedClips.length)return this.__selectedClips[0]}set selectedClip(e){this.selectedClips=e}get selectedClipOrMash(){return this.selectedClip||this.__mash}get selectedClips(){return this.__selectedClips}set selectedClips(e){this.__selectedClips=this.mash.filterClipSelection(e),this.__pristine=this.selectedClipOrMash.propertyValues,this.selectedEffects=[]}get selectedEffect(){if(1===this.__selectedEffects.length)return this.__selectedEffects[0]}set selectedEffect(e){this.selectedEffects=me.object(e)&&!me.empty(e)?[e]:[]}get selectedEffects(){return this.__selectedEffects}set selectedEffects(e){const t=this.selectedClipOrMash.effects;if(!t)return this.__selectedEffects=[],void(this.__pristineEffect={});const i=me.array(e)?e:[];this.__selectedEffects=i.filter((e=>t.includes(e))),this.__pristineEffect=this.selectedEffect&&this.selectedEffect.propertyValues||{}}get silenced(){return this.__paused||this.muted||!this.gain}get stalling(){return!this.__moving&&!this.paused}get time(){return this.__time}set time(e){const t=this.__limit_time(e),i=this.__time.equalsTime(t);this.__time=t,this.composition.time=this.__time,i||this.handleChangeMash()}get urlsCached(){return this.composition.urlsInTimeRange}get volume(){return me.undefined(this.__volume)&&(this.__volume=this.initializeProperty(gs.volume)),this.__volume}set volume(e){if(!me.number(e))throw r.argument;this.__volume=e,this.handleGainChange()}add(e,t,i,s){if(!me.object(e))throw r.argument+e;const n=me.defined(t)?t:e.type;if(n===M.effect)return this.addEffect(new Ni(e),i);const a=oi.create({type:n,...e}),o=ss.createFromObjectMedia(e,a,this.mash);return this.addClip(o,i,s)}addClip(e,t,i){Ce(e,Ui);const{trackType:s}=e,r=[e],n={clip:e,type:fs.type.addClipsToTrack,redoSelectedClips:r,trackType:s},a=this.mash.trackOfTypeAtIndex(s,i),o=this.mash[s].length;return i||s===O.audio?(n.trackIndex=i,e.frame=a.frameForClipsNearFrame(r,t),n.createTracks=Math.max(0,i+1-o)):(n.insertIndex=t,n.createTracks=Math.min(1,Math.max(0,1-o))),this.actionCreate(n),this.loadVisual().then((()=>Promise.resolve(e)))}addEffect(e,t){Ce(e,Ni);const i=this.selectedClipOrMash.effects;Ce(i,Array,r.selection);const s=me.integer(t)&&t>0?t:0,n=[...i],a=[...i];a.splice(s,0,e);const o={effects:i,undoEffects:n,redoEffects:a,type:fs.type.moveEffects};return this.actionCreate(o),this.loadVisual().then((()=>Promise.resolve(e)))}addTrack(e=O.video){if(!I.includes(e))throw r.type+e;return this.actionCreate({trackType:e,type:fs.type.addTrack})}can(e){var t=!1,i=this.__selectedClips.length;switch(e){case"undo":t=this.__actions.canUndo;break;case"redo":t=this.__actions.canRedo;break;case"adjust":(t=i>0)&&(t=this.__selectedClips[0].track>0);break;case"copy":t=i>0;break;case"cut":case"remove":t=this.__selectedClips.length;break;case"split":t=_s(this.selectedClip,this.time,this.mash.quantize);break;case"freeze":t=1===i,t&&=T.video===this.selectedClip.type,t&&=_s(this.selectedClip,this.time,this.mash.quantize)}return t}currentActionReusable(e,t){if(!this.__actions.currentActionLast)return;const i=this.__actions.currentAction;return me.instanceOf(i,ze)&&i.target===e&&i.property===t?i:void 0}change(e){return this.selectedClip?this.changeClip(e):this.changeMash(e)}changeClip(e){if(!me.string(e)||me.empty(e))throw r.property+e;const t={property:e,target:this.selectedClip},[i,s]=e.split(".");if(s){if(!A.includes(i))throw r.property+i;"id"===s?(t.property=i,t.redoValue=t.target[t.property].id):(t.target=t.target[i],t.property=s,t.redoValue=t.target[t.property]),console.log(this.constructor.name,"changeClip",i,s,this.__pristine),t.undoValue=this.__pristine[i][s]}else t.undoValue=this.__pristine[e],t.redoValue=t.target[t.property];const n=this.currentActionReusable(t.target,t.property);if(n)return n.updateAction(t.redoValue);switch(t.property){case"frames":t.type=fs.type.changeFrames;break;case"trim":t.type=fs.type.changeTrim;break;default:t.type=fs.type.change}return this.actionCreate(t)}changeEffect(e){if(!me.string(e)||me.empty(e))throw r.property;const t=this.selectedEffect;if(me.undefined(t))throw r.selection;const i=t[e],s=this.currentActionReusable(t,e);if(s)return s.updateAction(i);const n=this.__pristineEffect[e],a={type:fs.type.change,target:t,property:e,redoValue:i,undoValue:n};return this.actionCreate(a)}changeMash(e){if(!os.properties.includes(e))throw r.unknownMash+e;const t=this.mash,i=this.mash[e],s=this.currentActionReusable(t,e);if(s)return s.updateAction(i);const n={target:t,property:e,redoValue:i,undoValue:this.__pristine[e],type:fs.type.change};return this.actionCreate(n)}delayedDraw(){this.delayed_timer||(this.delayed_timer=setTimeout((()=>{this.delayed_timer=null,this.redraw()}),50))}destroy(){Mashers.delete(this)}handleAction(e,t){this.events.emit(e,{action:t})}handleGainChange(){this.composition.gain=this.gain}handleChangeMash(){this.paused=!0,this.rebuffer(),this.redraw()}handleChangeMashFrames(){const e=this.mash.frames;if(this.__mashFrames!==e){this.__mashFrames=e;const t=Math.max(0,this.endTime.frame-1);t<this.time.frame?this.frame=t:this.delayedDraw()}}handleMasher(e){if(e.type!==cs.type)return console.warn("handleMasher",e);switch(e.detail.type){case w.duration:this.handleChangeMashFrames();break;case w.action:{const t=e.detail.action;switch(this.selectedClips=t.selectedClips,this.selectedEffects=t.selectedEffects,t.type){case fs.type.changeAction:"gain"===t.property&&this.__moving&&!this.silenced&&this.composition.adjustSourceGain(t.target);break;default:this.delayedDraw()}break}default:this.delayedDraw()}}handleRemoveActions(e=[]){const t=e.length?w.truncate:w.add;this.handleAction(t,this.__actions.currentAction),this.handleChangeMash(),e.length&&this.did(e.length)}initializeProperty(...e){for(let t of e)if(me.defined(this.object[t]))return this.object[t];return t[e[0]]}loadVisual(){return this.composition.loadTime()}media(e){return e.media}move(e,t,i,s){if(!me.object(e))throw r.argument+e;return t===M.effect?this.moveEffects(e,i):this.moveClips(e,i,s)}moveEffects(e,t=0){if(!me.positive(t))throw r.argument+t;const i=(me.array(e)?e:[e]).filter((e=>me.instanceOf(e,Ni)));if(me.emptyarray(i))throw r.argument+e;const s=this.selectedClip.effects,n=[...s],a=[];n.forEach(((e,s)=>{s===t&&a.push(...i),i.includes(e)||a.push(e)}));const o={effects:s,undoEffects:n,redoEffects:a,type:fs.type.moveEffects};return this.actionCreate(o)}moveClips(e,t=0,i=0){if(!me.positive(t))throw r.argument+t;if(!me.positive(i))throw r.argument+i;const s=this.mash.filterClipSelection(e);if(me.emptyarray(s))throw r.argument+e;const[n]=s,{trackType:a,track:o}=n,c={clips:s,trackType:a,trackIndex:i,undoTrackIndex:o,type:fs.type.moveClips},l=this.mash.trackOfTypeAtIndex(a,i),h=this.mash.trackOfTypeAtIndex(a,o),u=l.clips.indexOf(n);if(l.isMainVideo&&(c.insertIndex=t),h.isMainVideo&&(c.undoInsertIndex=u,t<u&&(c.undoInsertIndex+=s.length)),!l.isMainVideo||!h.isMainVideo){const e=s.map((e=>e.frame)),i=l.frameForClipsNearFrame(s,t)-n.frame;if(!i)return;c.undoFrames=e,c.redoFrames=e.map((e=>e+i))}return this.actionCreate(c)}pause(){this.paused=!0}play(){this.paused=!1}rebuffer(){return this.paused?this.composition.loadTime():this.composition.loadTimeRange()}redo(){this.__actions.canRedo&&(this.__actions.redo(),this.handleChangeMash())}redraw(){if(!this.configured)return;const e=this.composition.drawFrame(),t=!this.__moving||this.silenced||this.composition.bufferedTime,i=e&&t;this.__moving!==i&&(this.__moving?this.__set_moving(!1):!this.__paused&&this.bufferedTimeRange&&this.__set_moving(!0))}draw(){return this.composition.draw()}remove(e,t){if(!me.object(e))throw r.argument+e;return t===M.effect?this.removeEffects(e):this.removeClips(e)}removeClips(e){const t=this.mash.filterClipSelection(e);if(me.emptyarray(t))throw r.argument+e;const[i]=t,s=this.mash.clipTrack(i),n={clips:t,track:s,index:s.clips.indexOf(i),type:fs.type.removeClips};return this.actionCreate(n)}removeEffects(e){const t=(me.array(e)?e:[e]).filter((e=>me.instanceOf(e,Ni)));if(me.emptyarray(t))throw r.argument+e;const i=this.selectedClip.effects,s=[...i],n=i.filter((e=>!t.includes(e))),a={redoSelectedEffects:[],effects:i,undoEffects:s,redoEffects:n,type:fs.type.moveEffects};return this.actionCreate(a)}select(e,t){if(e){var i,s,r=[],n="__selectedClips",a="selectedClips";if(i=this.mash.findMedia(e.id))if(T.effect===i.type&&(n="__selectedEffects",a="selectedEffects"),t)switch(s=this[n].indexOf(e),this[n].length){case 0:r.push(e);break;case 1:if(s>-1)break;default:s<0?(r.push(e),r=r.concat(this[n])):(s&&(r=r.concat(this[n].slice(0,s))),s<this[n].length-1&&(r=r.concat(this[n].slice(s+1))))}else{if(-1<this[n].indexOf(e))return;r.push(e)}this[a]=r}else this.selectedClip=!1}selected(e){return me.instanceOf(e,Ni)?this.selectedEffects.includes(e):this.selectedClips.includes(e)}selectEffect(e,t){if(me.object(e))return this.select(e,t);t||(this.selectedEffect=e)}split(){const e=this.selectedClip;if(!_s(e,this.time,this.mash.quantize))return;const t=this.time.scale(this.mash.quantize),i=e.frames,s=t.frame-e.frame,r=e.copy;r.frames=i-s,r.frame=t.frame,e.properties.includes("trim")&&(r.trim+=s);const n=this.mash.clipTrack(e).clips,a={type:fs.type.split,splitClip:e,insertClip:r,trackClips:n,redoFrames:s,undoFrames:i,index:1+n.indexOf(e),redoSelectedClips:[r],undoSelectedClips:[e]};return this.actionCreate(a)}freeze(){const e=this.selectedClip;if(!_s(e,this.time,this.mash.quantize))return;if(T.video!==e.type)return;const t=this.time.scale(this.mash.quantize),i=this.mash.clipTrack(e).clips,s=e.copy,r=e.copy,n={frames:e.frames-(t.frame-e.frame),freezeClip:e,frozenClip:r,insertClip:s,trackClips:i,redoSelectedClips:[r],index:1+i.indexOf(e),type:fs.type.freeze};return r.frame=t.frame,r.frames=1,r.trim=e.trim+(t.frame-e.frame),s.frame=t.frame+1,s.frames=n.frames-1,s.trim=r.trim+1,this.actionCreate(n)}undo(){this.__actions.canUndo&&(this.__actions.undo(),this.handleChangeMash())}__limit_time(e){const t=e.scale(this.fps),i=this.mashEndTime.scale(this.fps);return t.frame>i.frame?i:t}__load_timed(){if(this.__moving){var e=Fe.createFromSeconds(this.composition.seconds,this.fps,"ceil");e.frame!==this.__limit_time(e).frame?this.loop?(this.frame=0,this.paused=!1):this.paused=!0:e.equalsTime(this.__drawnTime)||(this.__time=e.scale(this.fps),this.redraw())}}__set_moving(e){if(this.__moving!==e)if(this.__moving=e,this.__moving){var t=this;this.__load_timer=setInterval((()=>{t.__load_timed()}),500/this.fps),this.composition.startPlaying(),this.rebuffer()}else this.composition.stopPlaying(),clearInterval(this.__load_timer),this.__load_timer=!1}actionCreate(e){const t=fs.createFromObjectMasher(e,this),i=this.__actions.do(t);this.handleRemoveActions(i)}}Object.defineProperties(vs,{type:{value:"masher"},properties:{get:function(){return Object.values(gs)}}}),Object.defineProperties(vs.prototype,{...ls,...ps});const ys=["masher"],bs=Object.fromEntries(ys.map((e=>[e,e])));class ws extends Je{constructor(){super(),this.install(bs.masher,vs)}create(e=bs.masher){const t=super.create(e);return this.mashers.length||this.start(),this.mashers.push(t),t}}Object.defineProperties(ws.prototype,{destroy:{value:function(e){const t=this.mashers.indexOf(e);t<0||(this.mashers.splice(t,1),this.mashers.length||this.stop())}},handleInterval:{value:function(){const e=new ct;this.mashers.forEach((t=>e.concat(t.urlsCached)));const t=e.urls;Ye.urls().forEach((e=>t.includes(e)||Ye.remove(e)))}},mashers:{get:function(){return me.undefined(this.__mashers)&&(this.__mashers=[]),this.__mashers}},start:{value:function(){this.interval||(this.interval=setInterval(this.handleInterval.bind(this),1e4))}},stop:{value:function(){this.interval&&(clearInterval(this.interval),this.interval=null)}},type:{value:bs},types:{value:ys}});const xs=new ws;var Ts={Property:fe,Module:Q,ModuleType:j,ModuleTypes:C,MasherFactory:xs};e.default=Ts}));
//# sourceMappingURL=moviemasher.min.js.map
